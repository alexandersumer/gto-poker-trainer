#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

marker_file="$repo_root/.git/.precommit_passed"
rm -f "$marker_file"

if [[ "${SKIP_PRECOMMIT_CI:-}" == "1" ]]; then
  echo "[pre-commit] SKIP_PRECOMMIT_CI=1 detected. Skipping checks."
  exit 0
fi

if ! command -v cargo >/dev/null 2>&1; then
  echo "[pre-commit] Missing 'cargo'. Install Rust via https://rustup.rs." >&2
  exit 1
fi

staged_files=()
while IFS= read -r -d '' path; do
  staged_files+=("$path")
done < <(git diff --cached --name-only --diff-filter=ACMR -z -- '*.rs' 'Cargo.toml')

if (( ${#staged_files[@]} > 0 )); then
  echo "[pre-commit] Running cargo fmt (changed Rust files detected)..."
  cargo fmt
  git add -- "${staged_files[@]}"
fi

run_step() {
  local label=$1
  shift
  echo "[pre-commit] ${label}..."
  if ! "$@"; then
    echo "[pre-commit] ${label} failed. Aborting commit." >&2
    exit 1
  fi
  echo "[pre-commit] ${label} OK."
}

run_step "cargo fmt --check" cargo fmt -- --check
run_step "cargo clippy" cargo clippy -- -D warnings
run_step "cargo test" cargo test

echo "[pre-commit] All checks passed."
printf 'ok %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)" >"$marker_file"
