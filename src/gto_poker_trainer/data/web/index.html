<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#ffffff" />
    <title>GTO Poker Trainer</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <style>

      :root {
        color-scheme: light;
        --min-tap: 44px;
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);

        /* Light theme tokens */
        --theme-light-bg-primary: #f9fafb;
        --theme-light-bg-secondary: rgba(255, 255, 255, 0.92);
        --theme-light-bg-panel: rgba(255, 255, 255, 0.92);
        --theme-light-surface-subtle: #f3f4f6;
        --theme-light-border-panel: #e5e7eb;
        --theme-light-card-highlight: #ffffff;
        --theme-light-text-primary: #111827;
        --theme-light-text-secondary: #4b5563;
        --theme-light-text-muted: #6b7280;

        /* Action palette */
        --theme-light-btn-primary-bg: #eef2ff;
        --theme-light-btn-primary-text: #4338ca;
        --theme-light-btn-primary-hover: #e0e7ff;
        --theme-light-btn-primary-active: #c7d2fe;
        --theme-light-btn-info-bg: #e9f2ff;
        --theme-light-btn-info-text: #0b4f9c;
        --theme-light-btn-info-hover: #dde9ff;
        --theme-light-btn-info-border: #c6dbff;
        --theme-light-btn-danger-bg: #fdecec;
        --theme-light-btn-danger-text: #b42318;
        --theme-light-btn-danger-hover: #fad7d7;
        --theme-light-btn-danger-border: #f8c4c4;
        --theme-light-focus-ring: #a5b4fc;

        /* Additional semantic tokens */
        --theme-light-color-panel-soft: #eff2f8;
        --theme-light-color-chip-bg: #d7ebf4;
        --theme-light-color-chip-hover: #cee4ee;
        --theme-light-color-chip-text: #1d3a56;
        --theme-light-color-muted-bg: #f3f4fa;
        --theme-light-color-muted-hover: #eaedf6;
        --theme-light-color-muted-border: #d7ddea;
        --theme-light-color-muted-text: #47516d;
        --theme-light-color-surface-subtle-hover: #e7eaf1;
        --theme-light-color-secondary-bg: #e8ecf6;
        --theme-light-color-secondary-hover: #dfe4f2;
        --theme-light-color-secondary-border: #ccd5e6;
        --theme-light-color-secondary-text: #25304b;
        --theme-light-color-settings-hover: #f8fafc;
        --theme-light-color-divider-soft: rgba(215, 221, 234, 0.7);
        --theme-light-color-outline: #e5e7eb;
        --theme-light-color-progress: #6c83f5;
        --theme-light-color-input-bg: #e9edf7;
        --theme-light-color-input-border: #c7d3eb;
        --theme-light-color-focus-secondary: #7ec7c2;
        --theme-light-color-focus-primary: #6c83f5;
        --theme-light-color-focus-offset: #f5f7fb;
        --theme-light-color-shadow-elevated: rgba(31, 39, 64, 0.1);
        --theme-light-color-shadow-soft: rgba(15, 23, 42, 0.08);
        --theme-light-color-brand-mark-bg: #111827;
        --theme-light-color-brand-mark-fg: #ffffff;
        --theme-light-color-pill-border: rgba(15, 23, 42, 0.1);
        --theme-light-color-pill-bg: #ffffff;
        --theme-light-color-pill-text: #475569;
        --theme-light-color-pill-dot: #10b981;
        --theme-light-color-pill-dot-empty: #cbd5f5;
        --theme-light-color-subheader-text: #64748b;
        --theme-light-color-subheader-separator: rgba(148, 163, 184, 0.6);
        --theme-light-color-ghost-hover: #f4f6f8;

        /* Card suits */
        --theme-light-suit-spade: #111827;
        --theme-light-suit-heart: #e11d48;
        --theme-light-suit-diamond: #2563eb;
        --theme-light-suit-club: #16a34a;
      }

      :root:not([data-theme]),
      :root[data-theme="light"] {
        color-scheme: light;
        --bg-primary: var(--theme-light-bg-primary);
        --bg-secondary: var(--theme-light-bg-secondary);
        --bg-panel: var(--theme-light-bg-panel);
        --surface-subtle: var(--theme-light-surface-subtle);
        --border-panel: var(--theme-light-border-panel);
        --card-highlight: var(--theme-light-card-highlight);
        --text-primary: var(--theme-light-text-primary);
        --text-secondary: var(--theme-light-text-secondary);
        --text-muted: var(--theme-light-text-muted);
        --btn-primary-bg: var(--theme-light-btn-primary-bg);
        --btn-primary-text: var(--theme-light-btn-primary-text);
        --btn-primary-hover: var(--theme-light-btn-primary-hover);
        --btn-primary-active: var(--theme-light-btn-primary-active);
        --btn-info-bg: var(--theme-light-btn-info-bg);
        --btn-info-text: var(--theme-light-btn-info-text);
        --btn-info-hover: var(--theme-light-btn-info-hover);
        --btn-info-border: var(--theme-light-btn-info-border);
        --btn-danger-bg: var(--theme-light-btn-danger-bg);
        --btn-danger-text: var(--theme-light-btn-danger-text);
        --btn-danger-hover: var(--theme-light-btn-danger-hover);
        --btn-danger-border: var(--theme-light-btn-danger-border);
        --focus-ring: var(--theme-light-focus-ring);
        --color-panel-soft: var(--theme-light-color-panel-soft);
        --color-chip-bg: var(--theme-light-color-chip-bg);
        --color-chip-hover: var(--theme-light-color-chip-hover);
        --color-chip-text: var(--theme-light-color-chip-text);
        --color-muted-bg: var(--theme-light-color-muted-bg);
        --color-muted-hover: var(--theme-light-color-muted-hover);
        --color-muted-border: var(--theme-light-color-muted-border);
        --color-muted-text: var(--theme-light-color-muted-text);
        --color-surface-subtle-hover: var(--theme-light-color-surface-subtle-hover);
        --color-secondary-bg: var(--theme-light-color-secondary-bg);
        --color-secondary-hover: var(--theme-light-color-secondary-hover);
        --color-secondary-border: var(--theme-light-color-secondary-border);
        --color-secondary-text: var(--theme-light-color-secondary-text);
        --color-settings-hover: var(--theme-light-color-settings-hover);
        --color-divider-soft: var(--theme-light-color-divider-soft);
        --color-outline: var(--theme-light-color-outline);
        --color-progress: var(--theme-light-color-progress);
        --color-input-bg: var(--theme-light-color-input-bg);
        --color-input-border: var(--theme-light-color-input-border);
        --color-focus-secondary: var(--theme-light-color-focus-secondary);
        --color-focus-primary: var(--theme-light-color-focus-primary);
        --color-focus-offset: var(--theme-light-color-focus-offset);
        --color-shadow-elevated: var(--theme-light-color-shadow-elevated);
        --color-shadow-soft: var(--theme-light-color-shadow-soft);
        --color-brand-mark-bg: var(--theme-light-color-brand-mark-bg);
        --color-brand-mark-fg: var(--theme-light-color-brand-mark-fg);
        --color-pill-border: var(--theme-light-color-pill-border);
        --color-pill-bg: var(--theme-light-color-pill-bg);
        --color-pill-text: var(--theme-light-color-pill-text);
        --color-pill-dot: var(--theme-light-color-pill-dot);
        --color-pill-dot-empty: var(--theme-light-color-pill-dot-empty);
        --color-subheader-text: var(--theme-light-color-subheader-text);
        --color-subheader-separator: var(--theme-light-color-subheader-separator);
        --color-ghost-hover: var(--theme-light-color-ghost-hover);
        --suit-spade: var(--theme-light-suit-spade);
        --suit-heart: var(--theme-light-suit-heart);
        --suit-diamond: var(--theme-light-suit-diamond);
        --suit-club: var(--theme-light-suit-club);
      }

      :root[data-theme="dark"] {
        color-scheme: dark;
        --bg-primary: var(--theme-dark-bg-primary, var(--theme-light-bg-primary));
        --bg-secondary: var(--theme-dark-bg-secondary, var(--theme-light-bg-secondary));
        --bg-panel: var(--theme-dark-bg-panel, var(--theme-light-bg-panel));
        --surface-subtle: var(--theme-dark-surface-subtle, var(--theme-light-surface-subtle));
        --border-panel: var(--theme-dark-border-panel, var(--theme-light-border-panel));
        --card-highlight: var(--theme-dark-card-highlight, var(--theme-light-card-highlight));
        --text-primary: var(--theme-dark-text-primary, var(--theme-light-text-primary));
        --text-secondary: var(--theme-dark-text-secondary, var(--theme-light-text-secondary));
        --text-muted: var(--theme-dark-text-muted, var(--theme-light-text-muted));
        --btn-primary-bg: var(--theme-dark-btn-primary-bg, var(--theme-light-btn-primary-bg));
        --btn-primary-text: var(--theme-dark-btn-primary-text, var(--theme-light-btn-primary-text));
        --btn-primary-hover: var(--theme-dark-btn-primary-hover, var(--theme-light-btn-primary-hover));
        --btn-primary-active: var(--theme-dark-btn-primary-active, var(--theme-light-btn-primary-active));
        --btn-info-bg: var(--theme-dark-btn-info-bg, var(--theme-light-btn-info-bg));
        --btn-info-text: var(--theme-dark-btn-info-text, var(--theme-light-btn-info-text));
        --btn-info-hover: var(--theme-dark-btn-info-hover, var(--theme-light-btn-info-hover));
        --btn-info-border: var(--theme-dark-btn-info-border, var(--theme-light-btn-info-border));
        --btn-danger-bg: var(--theme-dark-btn-danger-bg, var(--theme-light-btn-danger-bg));
        --btn-danger-text: var(--theme-dark-btn-danger-text, var(--theme-light-btn-danger-text));
        --btn-danger-hover: var(--theme-dark-btn-danger-hover, var(--theme-light-btn-danger-hover));
        --btn-danger-border: var(--theme-dark-btn-danger-border, var(--theme-light-btn-danger-border));
        --focus-ring: var(--theme-dark-focus-ring, var(--theme-light-focus-ring));
        --color-panel-soft: var(--theme-dark-color-panel-soft, var(--theme-light-color-panel-soft));
        --color-chip-bg: var(--theme-dark-color-chip-bg, var(--theme-light-color-chip-bg));
        --color-chip-hover: var(--theme-dark-color-chip-hover, var(--theme-light-color-chip-hover));
        --color-chip-text: var(--theme-dark-color-chip-text, var(--theme-light-color-chip-text));
        --color-muted-bg: var(--theme-dark-color-muted-bg, var(--theme-light-color-muted-bg));
        --color-muted-hover: var(--theme-dark-color-muted-hover, var(--theme-light-color-muted-hover));
        --color-muted-border: var(--theme-dark-color-muted-border, var(--theme-light-color-muted-border));
        --color-muted-text: var(--theme-dark-color-muted-text, var(--theme-light-color-muted-text));
        --color-surface-subtle-hover: var(--theme-dark-color-surface-subtle-hover, var(--theme-light-color-surface-subtle-hover));
        --color-secondary-bg: var(--theme-dark-color-secondary-bg, var(--theme-light-color-secondary-bg));
        --color-secondary-hover: var(--theme-dark-color-secondary-hover, var(--theme-light-color-secondary-hover));
        --color-secondary-border: var(--theme-dark-color-secondary-border, var(--theme-light-color-secondary-border));
        --color-secondary-text: var(--theme-dark-color-secondary-text, var(--theme-light-color-secondary-text));
        --color-settings-hover: var(--theme-dark-color-settings-hover, var(--theme-light-color-settings-hover));
        --color-divider-soft: var(--theme-dark-color-divider-soft, var(--theme-light-color-divider-soft));
        --color-outline: var(--theme-dark-color-outline, var(--theme-light-color-outline));
        --color-progress: var(--theme-dark-color-progress, var(--theme-light-color-progress));
        --color-input-bg: var(--theme-dark-color-input-bg, var(--theme-light-color-input-bg));
        --color-input-border: var(--theme-dark-color-input-border, var(--theme-light-color-input-border));
        --color-focus-secondary: var(--theme-dark-color-focus-secondary, var(--theme-light-color-focus-secondary));
        --color-focus-primary: var(--theme-dark-color-focus-primary, var(--theme-light-color-focus-primary));
        --color-focus-offset: var(--theme-dark-color-focus-offset, var(--theme-light-color-focus-offset));
        --color-shadow-elevated: var(--theme-dark-color-shadow-elevated, var(--theme-light-color-shadow-elevated));
        --color-shadow-soft: var(--theme-dark-color-shadow-soft, var(--theme-light-color-shadow-soft));
        --color-brand-mark-bg: var(--theme-dark-color-brand-mark-bg, var(--theme-light-color-brand-mark-bg));
        --color-brand-mark-fg: var(--theme-dark-color-brand-mark-fg, var(--theme-light-color-brand-mark-fg));
        --color-pill-border: var(--theme-dark-color-pill-border, var(--theme-light-color-pill-border));
        --color-pill-bg: var(--theme-dark-color-pill-bg, var(--theme-light-color-pill-bg));
        --color-pill-text: var(--theme-dark-color-pill-text, var(--theme-light-color-pill-text));
        --color-pill-dot: var(--theme-dark-color-pill-dot, var(--theme-light-color-pill-dot));
        --color-pill-dot-empty: var(--theme-dark-color-pill-dot-empty, var(--theme-light-color-pill-dot-empty));
        --color-subheader-text: var(--theme-dark-color-subheader-text, var(--theme-light-color-subheader-text));
        --color-subheader-separator: var(--theme-dark-color-subheader-separator, var(--theme-light-color-subheader-separator));
        --color-ghost-hover: var(--theme-dark-color-ghost-hover, var(--theme-light-color-ghost-hover));
        --suit-spade: var(--theme-dark-suit-spade, var(--theme-light-suit-spade));
        --suit-heart: var(--theme-dark-suit-heart, var(--theme-light-suit-heart));
        --suit-diamond: var(--theme-dark-suit-diamond, var(--theme-light-suit-diamond));
        --suit-club: var(--theme-dark-suit-club, var(--theme-light-suit-club));
      }

      body {
        min-height: 100vh;
        margin: 0;
        font-family: "Inter", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
      }
      .text-primary { color: var(--text-primary); }
      .text-secondary { color: var(--text-secondary); }
      .text-muted { color: var(--text-muted); }
      .eyebrow { letter-spacing: 0.22em; color: var(--text-muted); }
      main {
        flex: 1;
        width: min(860px, calc(100% - 2.5rem));
        padding-bottom: 4rem;
      }
      #progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--color-progress);
        transform: scaleX(0);
        transform-origin: left;
        opacity: 0;
        transition: opacity 0.35s ease, transform 0.35s ease;
        z-index: 50;
        pointer-events: none;
      }
      #progress-bar.active {
        opacity: 1;
        animation: progress-pulse 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }
      @keyframes progress-pulse {
        0% { transform: scaleX(0.15); }
        50% { transform: scaleX(0.7); }
        100% { transform: scaleX(1); }
      }
      .card {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.65rem;
        border: 1px solid var(--border-panel);
        padding: 0.35rem 0.75rem;
        font-weight: 700;
        letter-spacing: 0.4px;
        margin: 0 0.25rem 0.25rem 0;
        background: var(--card-highlight);
        box-shadow: 0 6px 12px rgba(17, 24, 39, 0.06);
      }
      .card.s { color: var(--suit-spade); }
      .card.h { color: var(--suit-heart); }
      .card.d { color: var(--suit-diamond); }
      .card.c { color: var(--suit-club); }
      .glass {
        backdrop-filter: blur(18px);
        background: rgba(255, 255, 255, 0.82);
        box-shadow: 0 18px 34px rgba(31, 39, 64, 0.08);
      }
      .panel-box {
        background: var(--bg-panel);
        border: 1px solid var(--border-panel);
        box-shadow: 0 30px 40px rgba(15, 23, 42, 0.04);
        color: var(--text-primary);
        border-radius: 1.25rem;
      }
      .panel-soft {
        background: var(--color-panel-soft);
      }
      input, select, textarea {
        color: var(--text-primary);
        background: var(--color-input-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--color-input-border);
        padding: 0.55rem 0.9rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      input:focus-visible {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }
      button {
        color: inherit;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      button:not([disabled]):active { transform: translateY(1px); }
      button[disabled] { cursor: wait !important; opacity: 0.65 !important; }
      #options {
        box-shadow: none;
      }
      #options button {
        box-shadow: 0 6px 12px var(--color-shadow-soft);
      }
      #options button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--focus-ring);
      }
      .btn-action {
        border-radius: 0.9rem;
        border: 1px solid var(--border-panel);
        padding: 0.9rem 1.15rem;
        font-weight: 600;
        text-align: left;
        color: var(--text-primary);
        background: var(--card-highlight);
        box-shadow: 0 6px 12px var(--color-shadow-soft);
        transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease;
      }
      .btn-primary {
        background: var(--btn-primary-bg);
        color: var(--btn-primary-text);
        border-color: var(--btn-primary-active);
      }
      .btn-primary:hover { background: var(--btn-primary-hover); }
      .btn-primary:active { background: var(--btn-primary-active); }

      .btn-info {
        background: var(--btn-info-bg);
        color: var(--btn-info-text);
        border-color: var(--btn-info-border);
      }
      .btn-info:hover { background: var(--btn-info-hover); }

      .btn-danger {
        background: var(--btn-danger-bg);
        color: var(--btn-danger-text);
        border-color: var(--btn-danger-border);
      }
      .btn-danger:hover { background: var(--btn-danger-hover); }

      .btn-neutral {
        background: var(--surface-subtle);
        color: var(--text-secondary);
        border-color: var(--border-panel);
      }
      .btn-neutral:hover { background: var(--color-surface-subtle-hover); }

      .btn-chip {
        background: var(--color-chip-bg);
        color: var(--color-chip-text);
        border: 1px solid transparent;
        box-shadow: 0 10px 20px var(--color-shadow-elevated);
      }
      .btn-chip:hover {
        background: var(--color-chip-hover);
      }
      .btn-chip:focus-visible {
        outline: 2px solid var(--color-focus-secondary);
        outline-offset: 2px;
      }

      .btn-muted {
        background: var(--color-muted-bg);
        color: var(--color-muted-text);
        border: 1px solid var(--color-muted-border);
      }
      .btn-muted:hover {
        background: var(--color-muted-hover);
      }
      .btn-muted:focus-visible {
        outline: 2px solid var(--color-focus-primary);
        outline-offset: 2px;
      }

      .btn-secondary-tone {
        background: var(--color-secondary-bg);
        color: var(--color-secondary-text);
        border: 1px solid var(--color-secondary-border);
      }
      .btn-secondary-tone:hover {
        background: var(--color-secondary-hover);
      }
      .btn-secondary-tone:focus-visible {
        outline: 2px solid var(--color-focus-primary);
        outline-offset: 2px;
      }

      .btn-ghost {
        background: var(--color-muted-bg);
        color: var(--color-muted-text);
        border: 1px solid transparent;
      }
      .btn-ghost:hover {
        border-color: var(--color-muted-border);
      }
      .btn-ghost:focus-visible {
        outline: 2px solid var(--color-focus-primary);
        outline-offset: 2px;
      }

      .border-divider-soft {
        border-color: var(--color-divider-soft) !important;
      }

      .border-outline {
        border: 1px solid var(--color-outline) !important;
      }

      .btn-tertiary {
        background: var(--card-highlight);
        color: var(--text-secondary);
        border: 1px solid rgba(15, 23, 42, 0.12);
      }
      .btn-tertiary:hover { background: var(--color-ghost-hover); }

      .feedback-success {
        background: var(--success-bg) !important;
        color: var(--success-text) !important;
        border-left: 4px solid rgba(17, 106, 71, 0.35);
      }
      .feedback-warning {
        background: var(--warning-bg) !important;
        color: var(--warning-text) !important;
        border-left: 4px solid rgba(146, 64, 14, 0.25);
      }
      .feedback-danger {
        background: var(--btn-danger-bg) !important;
        color: var(--btn-danger-text) !important;
        border-left: 4px solid rgba(180, 35, 24, 0.25);
      }

      .action-button {
        min-height: var(--min-tap);
      }

      .result-panel {
        line-height: 1.35;
      }

      .app-header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        padding-top: max(12px, var(--safe-top));
      }
      .app-header .header-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 56px;
      }
      .app-header .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .app-header .brand-mark {
        display: inline-grid;
        place-items: center;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 1.1rem;
        background: #111827;
        color: #ffffff;
        font-size: 1rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 2px rgba(15, 23, 42, 0.16);
      }
      .app-header .wordmark {
        font-size: 17px;
        font-weight: 600;
        color: var(--text-primary);
        letter-spacing: -0.01em;
      }
      .app-header .wordmark .lead {
        font-weight: 800;
      }
      .app-header .wordmark .trail {
        opacity: 0.92;
      }
      .app-header .header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .header-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
        border: 1px solid var(--color-pill-border);
        background: var(--color-pill-bg);
        font-size: 12px;
        font-weight: 500;
        color: var(--color-pill-text);
        box-shadow: 0 1px 2px var(--color-shadow-soft);
      }
      .header-pill.is-empty {
        opacity: 0.75;
      }
      .header-pill .status-dot {
        width: 0.375rem;
        height: 0.375rem;
        border-radius: 9999px;
        background: var(--color-pill-dot);
      }
      .header-pill.is-empty .status-dot {
        background: var(--color-pill-dot-empty);
      }
      .header-pill strong {
        font-weight: 600;
        color: var(--text-primary);
      }
      .subheader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        color: var(--color-subheader-text);
        gap: 0.75rem;
        flex-wrap: nowrap;
        min-height: 38px;
      }
      .subheader .stateline {
        flex: 1 1 auto;
        min-width: 0;
        font-weight: 500;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .subheader .stateline strong {
        color: var(--text-primary);
      }
      .subheader .stats {
        display: flex;
        align-items: center;
        flex: 0 0 auto;
        gap: 0.75rem;
        white-space: nowrap;
      }
      .subheader .stats span strong {
        color: var(--text-primary);
      }
      .text-num {
        font-variant-numeric: tabular-nums;
      }
      .unit {
        opacity: 0.65;
        margin-left: 0.125rem;
      }
      .subheader .stats span {
        display: inline-flex;
        align-items: baseline;
      }
      .subheader .stats span + span::before {
        content: '•';
        margin: 0 0.6rem;
        color: var(--color-subheader-separator);
        font-weight: 500;
      }

      .density-compact .page-section {
        padding-block: 8px;
      }
      .density-compact .section-heading {
        margin-block-end: 6px;
      }
      .density-compact .stack > :not([hidden]) ~ :not([hidden]) {
        margin-top: 8px;
      }
      .density-compact .subtext,
      .density-compact .meta-row {
        font-size: 0.95rem;
        line-height: 1.3;
      }
      .density-compact .hand-row,
      .density-compact .board-row {
        gap: 6px;
      }
      .density-compact .poker-card {
        width: clamp(36px, 7.2vw, 44px);
        height: clamp(50px, 10vw, 60px);
      }
      .density-compact .stateline {
        font-size: 0.98rem;
        line-height: 1.25;
        margin-block: 6px;
      }
      .density-compact .stats {
        margin-block: 4px;
        font-size: 0.95rem;
        line-height: 1.25;
      }
      .density-compact .actions {
        row-gap: 8px;
      }
      .density-compact .action-button {
        padding-block: 10px;
      }
      .density-compact .result-panel {
        padding: 10px 12px;
        margin-block-start: 8px;
        line-height: 1.3;
      }
      .density-compact .app-header .header-inner {
        height: 52px;
      }
      .density-compact .subheader {
        min-height: 34px;
        font-size: 12.5px;
      }
      .option-card {
        animation: option-in 0.26s ease forwards;
        transform-origin: top center;
        opacity: 0;
      }
      @keyframes option-in {
        0% { opacity: 0; transform: translateY(12px) scale(0.97); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
      }
      @media (prefers-reduced-motion: reduce) {
        .option-card { animation: none; }
        #progress-bar { transition: none; animation: none; }
      }
      #feedback {
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      #feedback.hidden { opacity: 0; transform: translateY(6px); }
      #feedback[data-state="correct"] {
        background: var(--success-bg);
        color: var(--success-text);
        border-left: 4px solid rgba(17, 106, 71, 0.35);
      }
      #feedback[data-state="incorrect"] {
        background: var(--btn-danger-bg);
        color: var(--btn-danger-text);
        border-left: 4px solid rgba(180, 35, 24, 0.25);
      }
      @media (max-width: 640px) {
        header { position: sticky; top: 0; }
        #options { position: relative; }
      }
    </style>
  </head>
  <body>
    <div id="progress-bar" aria-hidden="true"></div>
    <header class="app-header">
      <div class="max-w-2xl mx-auto px-4">
        <div class="header-inner">
          <div class="brand">
            <span aria-hidden="true" class="brand-mark">♠︎</span>
            <h1 class="wordmark"><span class="lead">GTO</span> <span class="trail">Trainer</span></h1>
          </div>
          <div class="header-actions">
            <span id="stats" class="header-pill is-empty">
              <span class="status-dot" aria-hidden="true"></span>
              <span class="pill-label">Answered</span>
              <strong id="stats-count">0</strong>
            </span>
          </div>
        </div>
        <div class="subheader">
          <div id="headline" class="stateline">Ready for a new hand</div>
          <div id="meta" class="stats">
            <span>Hand <strong class="text-num">0</strong><span class="unit">/0</span></span>
            <span>Pot <strong class="text-num">0</strong><span class="unit"> bb</span></span>
            <span>SPR <strong class="text-num">0</strong></span>
          </div>
        </div>
      </div>
    </header>

    <main class="screen max-w-2xl min-h-[720px] mx-auto p-4 pb-[calc(4rem+var(--safe-bottom))]">
      <section id="panel-start" class="page-section space-y-4">
        <div class="rounded-lg panel-box panel-soft p-6 text-secondary">
          <h2 class="font-semibold mb-4 text-[clamp(1.25rem,2vw,1.45rem)] text-primary">Start a Session</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-secondary">
            <label class="block text-sm">Hands
              <input id="inp-hands" type="number" min="1" value="3" class="mt-1 w-full" />
            </label>
            <label class="block text-sm">Simulation depth
              <input id="inp-mc" type="number" min="40" step="10" value="120" class="mt-1 w-full" />
              <span class="mt-2 block text-xs text-muted leading-relaxed">More trials give more accurate equity estimates, at the cost of extra compute time per hand.</span>
            </label>
          </div>
          <button id="btn-start" class="mt-6 w-full rounded-xl px-4 py-2.5 font-semibold transition-transform duration-200 hover:-translate-y-[1px] focus-visible:outline-none btn-chip">Start</button>
        </div>
      </section>

      <section id="panel-play" class="page-section hidden space-y-4">
        <div class="rounded-lg panel-box panel-soft p-6 text-secondary">
          <div class="mt-2 space-y-4 stack" id="card-summary">
            <div>
              <div class="text-xs font-semibold uppercase eyebrow section-heading">Your hand</div>
              <div id="hand" class="hand-row mt-1 flex flex-wrap items-center gap-1 text-lg font-semibold text-primary"></div>
            </div>
            <div>
              <div class="text-xs font-semibold uppercase eyebrow section-heading">Board</div>
              <div id="board" class="board-row mt-1 flex flex-wrap items-center gap-1 text-secondary"></div>
            </div>
          </div>

          <div class="options-block mt-6 pt-5 border-t border-divider-soft">
            <div class="section-heading text-xs font-semibold uppercase eyebrow text-muted tracking-[0.18em]">Choose your action</div>
            <div id="options" class="actions mt-3 grid grid-cols-1 gap-2 max-w-xl mx-auto"></div>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-2 sm:justify-end" id="primary-controls">
          <button id="btn-summary" class="hidden rounded-lg px-4 py-2 text-sm font-semibold transition-colors duration-200 focus-visible:outline-none btn-muted">
            View summary
          </button>
        </div>

        <div id="feedback" class="hidden rounded-lg panel-box p-5 result-panel"></div>
        <div class="mt-3 flex justify-center" id="end-session-container">
          <button id="btn-end" class="rounded-lg px-4 py-2 text-sm font-semibold transition-colors duration-200 focus-visible:outline-none btn-secondary-tone">
            End Session
          </button>
        </div>
      </section>

      <section id="panel-summary" class="page-section hidden space-y-4">
        <div class="rounded-lg panel-box panel-soft p-6 text-secondary" id="summary"></div>
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
          <button id="btn-new" class="w-full sm:w-auto rounded-md px-4 py-2 font-semibold transition-colors duration-200 focus-visible:outline-none btn-chip">Start new session</button>
          <button id="btn-summary-close" class="w-full sm:w-auto rounded-md px-4 py-2 text-sm font-medium transition-colors duration-200 focus-visible:outline-none btn-ghost">Back to results</button>
        </div>
      </section>
    </main>

    <script>

      const ThemeController = (() => {
        const STORAGE_KEY = 'gto-poker-trainer.theme';
        const DEFAULT = 'light';
        const SUPPORTED = new Set(['light', 'dark']);
        const listeners = new Set();
        const root = document.documentElement;
        const themeMeta = document.querySelector('meta[name="theme-color"]');

        const readStored = () => {
          try {
            return localStorage.getItem(STORAGE_KEY);
          } catch (error) {
            return null;
          }
        };

        const writeStored = (value) => {
          try {
            localStorage.setItem(STORAGE_KEY, value);
          } catch (error) {
            /* ignore storage errors */
          }
        };

        const notify = (value) => {
          for (const listener of listeners) {
            try {
              listener(value);
            } catch (error) {
              console.error('Theme listener failed', error);
            }
          }
        };

        const apply = (value, { persist = false } = {}) => {
          const next = SUPPORTED.has(value) ? value : DEFAULT;
          if (!root.dataset.theme || root.dataset.theme !== next) {
            root.dataset.theme = next;
          }
          if (themeMeta) {
            const bg = getComputedStyle(root).getPropertyValue('--bg-primary').trim();
            if (bg) {
              themeMeta.setAttribute('content', bg);
            }
          }
          if (persist) {
            writeStored(next);
          }
          notify(next);
          return next;
        };

        const set = (value, options) => apply(value, { persist: true, ...(options || {}) });
        const preview = (value, options) => apply(value, { persist: false, ...(options || {}) });
        const get = () => root.dataset.theme || DEFAULT;
        const onChange = (fn) => {
          if (typeof fn !== 'function') {
            return () => undefined;
          }
          listeners.add(fn);
          return () => listeners.delete(fn);
        };

        const init = () => {
          const preset = root.dataset.theme;
          const stored = readStored();
          const initial = SUPPORTED.has(preset)
            ? preset
            : SUPPORTED.has(stored)
            ? stored
            : DEFAULT;
          apply(initial, { persist: false });
        };

        init();

        return { get, set, preview, onChange, supported: () => Array.from(SUPPORTED) };
      })();

      window.GTOTheme = ThemeController;

      const $ = (sel) => document.querySelector(sel);
      const fmt = (value, maxDecimals = 2) => {
        const num = Number(value);
        if (!Number.isFinite(num)) return '0';
        const fixed = num.toFixed(maxDecimals);
        if (!fixed.includes('.')) return fixed;
        let trimmed = fixed.replace(/0+$/, '');
        if(trimmed === '' || trimmed === '.') return '0';
        if(trimmed.endsWith('.')) trimmed = trimmed.slice(0, -1);
        return trimmed;
      };
      const progressBar = document.getElementById('progress-bar');
      let inflight = 0;
      let hideProgressTimer = null;
      let sid = null;
      let pending = false;
      let answered = 0;
      let startBusy = false;
      let pendingSummary = null;
      const screen = document.querySelector('main.screen');

      const applyDensity = () => {
        if(!screen) return;
        const shouldCompact = window.innerHeight < 760;
        screen.classList.toggle('density-compact', shouldCompact);
      };

      applyDensity();
      window.addEventListener('resize', () => window.requestAnimationFrame(applyDensity));

      function show(id){
        ['#panel-start', '#panel-play', '#panel-summary'].forEach((sel)=>{
          const el = $(sel);
          if(el){ el.classList.add('hidden'); }
        });
        const target = $(id);
        if(target){ target.classList.remove('hidden'); }
      }

      function beginRequest(){
        inflight += 1;
        if(progressBar){
          clearTimeout(hideProgressTimer);
          progressBar.classList.add('active');
        }
      }

      function endRequest(){
        inflight = Math.max(0, inflight - 1);
        if(progressBar && inflight === 0){
          hideProgressTimer = window.setTimeout(()=>{
            progressBar.classList.remove('active');
          }, 120);
        }
      }

      async function api(path, opts){
        beginRequest();
        try{
          const r = await fetch(path, opts);
          if(!r.ok) throw new Error(await r.text());
          return r.headers.get('content-type')?.includes('json') ? r.json() : r.text();
        } finally {
          endRequest();
        }
      }

      function suit(sym){ return {S:'s',H:'h',D:'d',C:'c'}[sym]||'s'; }
      function suitIcon(sym){ return {S:'\u2660', H:'\u2665', D:'\u2666', C:'\u2663'}[sym]||'\u2660'; }
      function renderCards(cards){
        if(!cards || !cards.length) return '';
        return cards.map((c)=>{
          const rank = c[0];
          const suitCode = c[1];
          const css = suit(suitCode);
          return `<span class="card poker-card ${css}">${rank}${suitIcon(suitCode)}</span>`;
        }).join(' ');
      }

      function resetFeedback(){
        const fb = $('#feedback');
        if(!fb) return;
        fb.classList.add('hidden');
        fb.removeAttribute('data-state');
        fb.classList.remove('feedback-success','feedback-warning','feedback-danger');
        fb.innerHTML = '';
      }

      function setSummaryAvailability(enabled){
        const btn = $('#btn-summary');
        if(!btn) return;
        if(enabled){
          btn.disabled = false;
          btn.classList.remove('hidden');
        } else {
          btn.disabled = true;
          btn.classList.add('hidden');
        }
      }

      function setStartButtonState(busy){
        const btn = $('#btn-start');
        if(!btn) return;
        const label = btn.dataset.label || btn.textContent || 'Start';
        btn.dataset.label = label;
        if(busy){
          btn.disabled = true;
          btn.classList.add('cursor-wait','opacity-80');
          btn.textContent = 'Starting…';
        } else {
          btn.disabled = false;
          btn.classList.remove('cursor-wait','opacity-80');
          btn.textContent = btn.dataset.label;
        }
      }

      function readInt(selector, {fallback, min}){
        const el = $(selector);
        if(!el) return fallback;
        const raw = parseInt(el.value || '', 10);
        if(Number.isNaN(raw)) return fallback;
        return Math.max(min, raw);
      }

      async function start(){
        if(startBusy) return;
        startBusy = true;
        setStartButtonState(true);
        try{
          const hands = readInt('#inp-hands', {fallback: 3, min: 1});
          const handsInput = $('#inp-hands');
          if(handsInput) handsInput.value = String(hands);
          const mc = readInt('#inp-mc', {fallback: 120, min: 40});
          const mcInput = $('#inp-mc');
          if(mcInput) mcInput.value = String(mc);
          const data = await api('/api/session', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({hands, mc})});
          sid = data.session;
          answered = 0;
          pending = false;
          pendingSummary = null;
          updateStats();
          resetFeedback();
          setSummaryAvailability(false);
          const area = $('#options'); if(area) area.innerHTML = '';
          show('#panel-play');
          await showNode();
        } catch (err) {
          console.error(err);
          const statusLine = $('#headline');
          if(statusLine){
            const message = err instanceof Error ? err.message : String(err ?? 'unknown error');
            statusLine.textContent = `Unable to start session — ${message}`;
          }
          show('#panel-start');
        } finally {
          startBusy = false;
          setStartButtonState(false);
        }
      }

      async function showNode(){
        const payload = await api(`/api/session/${sid}/node`);
        await renderNodePayload(payload, {clearFeedback: true});
      }

      async function renderNodePayload(payload, {clearFeedback = false} = {}){
        if(payload.done){
          pendingSummary = payload.summary || null;
          setSummaryAvailability(true);
          const area = $('#options'); if(area) area.innerHTML = '';
          const headline = $('#headline'); if(headline) headline.textContent = 'Session complete';
          const meta = $('#meta'); if(meta) meta.textContent = 'View summary for detailed results.';
          return;
        }
        pendingSummary = null;
        setSummaryAvailability(false);
        const n = payload.node;
        const headline = $('#headline');
        if(headline){
          let descriptor = n.description || '';
          if ((Array.isArray(n.board_cards) && n.board_cards.length > 0) && descriptor.includes('; ')){
            descriptor = descriptor.split('; ')[1];
          } else if ((Array.isArray(n.board_cards) && n.board_cards.length > 0) && descriptor.startsWith('Board ')){
            const idx = descriptor.indexOf('. ');
            descriptor = idx >= 0 ? descriptor.slice(idx + 2) : descriptor;
          }
          const prefix = n.street.toUpperCase();
          headline.textContent = descriptor ? `${prefix} — ${descriptor}` : prefix;
        }
        const hero = renderCards(n.hero_cards);
        const heroEl = $('#hand'); if(heroEl) heroEl.innerHTML = hero || '<span class="text-sm text-muted">Dealing…</span>';
        const board = renderCards(n.board_cards);
        const boardEl = $('#board'); if(boardEl) boardEl.innerHTML = board || '<span class="text-sm text-muted">Board not yet revealed</span>';
        const meta = $('#meta');
        if(meta){
          const sprRaw = n.pot_bb > 0 ? (n.effective_bb / n.pot_bb) : Infinity;
          const sprText = Number.isFinite(sprRaw) ? fmt(sprRaw, 1) : '∞';
          const html = [
            `<span>Hand <strong class="text-num">${n.hand_no}</strong><span class="unit">/${n.total_hands}</span></span>`,
            `<span>Pot <strong class="text-num">${fmt(n.pot_bb, 2)}</strong><span class="unit"> bb</span></span>`,
            `<span>SPR <strong class="text-num">${sprText}</strong></span>`
          ].join('');
          meta.innerHTML = html;
        }
        const area = $('#options');
        if(area){
          const classifyTone = (label) => {
            const lower = label.toLowerCase();
            if (lower.includes('fold')) return 'btn-tertiary';
            if (lower.includes('call')) return 'btn-primary';
            if (lower.includes('check')) return 'btn-primary';
            if (lower.includes('all-in') || lower.includes('jam')) return 'btn-secondary-tone';
            if (lower.includes('raise') || lower.includes('3-bet') || lower.includes('4-bet')) return 'btn-secondary-tone';
            if (lower.includes('bet')) return 'btn-secondary-tone';
            return 'btn-neutral';
          };
          const fragment = document.createDocumentFragment();
          payload.options.forEach((option,i)=>{
            const rawLabel = typeof option === 'string' ? option : option?.label;
            const labelText = typeof rawLabel === 'string' && rawLabel.length ? rawLabel : `Option ${i + 1}`;
            const text = labelText;
            const b = document.createElement('button');
            b.type = 'button';
            const base = 'option-card btn-action action-button w-full text-sm font-semibold tracking-tight transition-all duration-200';
            const toneClass = classifyTone(text);
            b.className = `${base} ${toneClass}`.trim();
            b.style.animationDelay = `${i * 40}ms`;
            b.textContent = text;
            if (typeof option === 'object' && option && 'key' in option) {
              b.dataset.optionKey = option.key;
            }
            b.onclick = () => choose(i);
            fragment.appendChild(b);
          });
          if(typeof area.replaceChildren === 'function'){
            area.replaceChildren(fragment);
          } else {
            area.innerHTML = '';
            area.appendChild(fragment);
          }
        }
        if(clearFeedback){
          resetFeedback();
        }
        if(window.innerWidth < 640){
          window.requestAnimationFrame(()=>{
            const panel = $('#panel-play');
            if(panel){ panel.scrollIntoView({behavior: 'smooth', block: 'start'}); }
          });
        }
      }

      async function choose(i){
        if(pending) return;
        pending = true;
        const buttons = Array.from(document.querySelectorAll('#options button'));
        buttons.forEach((btn)=>{
          btn.disabled = true;
          btn.classList.add('cursor-wait','opacity-60');
        });
        try{
          const data = await api(`/api/session/${sid}/choose`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({choice:i})});
          const f = data.feedback; answered += 1; updateStats();
          const fb = $('#feedback');
          if(fb){
            fb.dataset.state = f.correct ? 'correct' : 'incorrect';
            fb.classList.remove('hidden','feedback-success','feedback-warning','feedback-danger');
            fb.classList.add(f.correct ? 'feedback-success' : 'feedback-danger');
            const verdictLabel = f.correct ? '✓ Best choice' : 'Better line available';
            const whyChosen = f.chosen.why ? `<div class="mt-2 text-sm text-secondary"><strong>Why you chose it:</strong> ${f.chosen.why}</div>` : '';
            const whyBest = !f.correct && f.best.why ? `<div class="mt-1 text-sm text-secondary"><strong>Coach note:</strong> ${f.best.why}</div>` : '';
            fb.innerHTML = `
              <div class="text-base font-semibold">${verdictLabel}: ${f.best.key}</div>
              <div class="mt-1 text-sm">You picked <strong>${f.chosen.key}</strong> · EV difference <strong>${fmt(f.ev_loss)} bb</strong></div>
              ${whyChosen}
              ${whyBest}
            `;
          }
          if(data.next){
            await renderNodePayload(data.next, {clearFeedback: false});
          } else {
            await showNode();
          }
        } finally {
          pending = false;
        }
      }

      async function showSummary(prefetched){
        const s = prefetched || await api(`/api/session/${sid}/summary`);
        const sum = $('#summary');
        if(sum){
          const decisions = s.decisions ?? answered;
          const accuracy = decisions ? Math.round((s.hits / decisions) * 100) : 0;
          const avgEvLoss = s.hands ? fmt(s.ev_lost / s.hands) : fmt(s.ev_lost);
          sum.innerHTML = `
            <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
              <div>
                <h2 class="text-lg font-semibold text-primary">Session summary</h2>
                <p class="text-sm text-muted">Your decisions across this run.</p>
              </div>
              <div class="text-right">
                <div class="text-xs uppercase tracking-wide text-muted">Score (0–100)</div>
                <div class="text-2xl font-bold text-primary">${Math.round(s.score)}</div>
              </div>
            </div>
            <dl class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3">
              <div class="rounded-lg border border-outline bg-white px-4 py-3">
                <dt class="text-xs font-semibold uppercase tracking-wide text-muted">Hands answered</dt>
                <dd class="mt-1 text-lg font-semibold text-primary">${s.hands}</dd>
              </div>
              <div class="rounded-lg border border-outline bg-white px-4 py-3">
                <dt class="text-xs font-semibold uppercase tracking-wide text-muted">Best choices hit</dt>
                <dd class="mt-1 text-lg font-semibold text-primary">${s.hits}</dd>
                <dd class="text-xs text-muted">Accuracy per decision: ${accuracy}%</dd>
              </div>
              <div class="rounded-lg border border-outline bg-white px-4 py-3">
                <dt class="text-xs font-semibold uppercase tracking-wide text-muted">EV lost</dt>
                <dd class="mt-1 text-lg font-semibold text-primary">${fmt(s.ev_lost)} bb</dd>
                <dd class="text-xs text-muted">Avg / hand: ${avgEvLoss} bb</dd>
              </div>
            </dl>
            <div class="mt-4 rounded-lg border border-outline bg-white px-4 py-3 text-sm text-secondary">
              Keep iterating: review the final hand’s feedback before starting a fresh session to reinforce the optimal line.
            </div>
          `;
        }
        pendingSummary = s;
        answered = s.decisions ?? answered;
        setSummaryAvailability(false);
        show('#panel-summary');
      }

      async function endSession(){
        if(!sid || pending) return;
        try{
          const summary = await api(`/api/session/${sid}/summary`);
          answered = summary.hands || answered;
          await showSummary(summary);
        } catch(err){
          console.error(err);
        }
      }

      function updateStats(){
        const countEl = $('#stats-count');
        if(countEl) countEl.textContent = String(answered);
        const stats = $('#stats');
        if(stats) {
          stats.classList.toggle('is-empty', answered === 0);
        }
      }

      const startBtn = $('#btn-start');
      if(startBtn){
        startBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          start();
        });
      }

      const newBtn = $('#btn-new');
      if(newBtn){
        newBtn.addEventListener('click', () => {
          sid = null;
          answered = 0;
          pending = false;
          pendingSummary = null;
          updateStats();
          resetFeedback();
          setStartButtonState(false);
          setSummaryAvailability(false);
          show('#panel-start');
        });
      }

      const endBtn = $('#btn-end');
      if(endBtn){
        endBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          endSession();
        });
      }

      const summaryBtn = $('#btn-summary');
      if(summaryBtn){
        summaryBtn.addEventListener('click', async (event)=>{
          event.preventDefault();
          if(pendingSummary){
            await showSummary(pendingSummary);
          } else {
            await showSummary();
          }
        });
      }

      const summaryCloseBtn = $('#btn-summary-close');
      if(summaryCloseBtn){
        summaryCloseBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          show('#panel-play');
          if(pendingSummary){
            setSummaryAvailability(true);
          }
        });
      }

      window.addEventListener('keydown', (e)=>{
        const panel = $('#panel-play');
        if(!panel || panel.classList.contains('hidden')) return;
        if(e.key >= '1' && e.key <= '9'){
          const idx = parseInt(e.key, 10) - 1;
          const btns = Array.from(document.querySelectorAll('#options button'));
          if(btns[idx]) btns[idx].click();
        }
      });
    </script>
  </body>
  </html>
