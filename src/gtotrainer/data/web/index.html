<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#F8FAFC" />
    <title>gtotrainer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+CiAgPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTgiIGZpbGw9IiMyNTYzRUIiLz4KICA8dGV4dCB4PSIzMiIgeT0iNDEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSInU2Vnb2UgVUknLCAnSGVsdmV0aWNhIE5ldWUnLCBBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzNCIgZmlsbD0iI0Y4RkFGQyI+4pmg77iOPC90ZXh0Pgo8L3N2Zz4=" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <style>
      :root {
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 10px;
        --space-1: 8px;
        --space-2: 12px;
        --space-3: 16px;
        --space-4: 24px;
        --min-tap: 44px;
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --font-sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        --text-size-body: 15px;
        --text-size-label: 13px;
        --text-size-title: 17px;
        --line-height: 1.4;
        --focus-ring: 2px;
        --focus-color: #60A5FA;
        --summary-gap-base: calc(var(--space-1) * 0.65);
        --summary-gap-tight: calc(var(--summary-gap-base) * 0.45);
        --card-row-pad-y: 4px;
        --card-row-pad-x: 6px;
        --card-hand-offset: clamp(4px, 1.1vw, 12px);
      }

      /* Light palette (default) */
      :root {

        color-scheme: light;
        --bg: #F8FAFC;
        --surface-1: #FFFFFF;
        --surface-2: #F8FAFC;
        --surface-3: #FFFFFF;
        --border: #E5E7EB;
        --field-bg: color-mix(in srgb, var(--surface-2) 88%, white 12%);
        --field-bg-hover: color-mix(in srgb, var(--surface-2) 80%, white 20%);
        --field-border: color-mix(in srgb, var(--border) 75%, transparent);
        --field-border-hover: color-mix(in srgb, var(--border) 55%, var(--brand) 12%);
        --field-border-focus: color-mix(in srgb, var(--brand) 60%, transparent);
        --field-placeholder: color-mix(in srgb, var(--text-tertiary) 78%, transparent);
        --field-helper: color-mix(in srgb, var(--text-secondary) 82%, transparent);
        --field-disabled-bg: color-mix(in srgb, var(--surface-2) 90%, white 10%);
        --field-disabled-border: color-mix(in srgb, var(--border) 62%, transparent);
        --field-error-border: color-mix(in srgb, var(--error) 70%, transparent);
        --shadow-soft: 0 18px 34px rgba(15, 23, 42, 0.075);
        --shadow-card: 0 1px 0 rgba(15, 23, 42, 0.035), 0 12px 24px rgba(15, 23, 42, 0.09);
        --text-primary: #0F172A;
        --text-secondary: #64748B;
        --text-tertiary: #94A3B8;
        --text-inverse: #FFFFFF;
        --brand: #2563EB;
        --brand-pressed: #1D4ED8;
        --brand-outline: #93C5FD;
        --on-brand: #FFFFFF;
        --success: #16A34A;
        --on-success: #FFFFFF;
        --warning: #F59E0B;
        --on-warning: #111827;
        --error: #DC2626;
        --on-error: #FFFFFF;
        --chip-bg: color-mix(in srgb, #1D4ED8 15%, transparent);
        --chip-border: color-mix(in srgb, #1D4ED8 30%, transparent);
        --chip-text: #0B1220;
        --muted-bg: #EEF1F6;
        --muted-border: #D7DCE5;
        --muted-hover: #E4E8F1;
        --divider-soft: rgba(209, 214, 223, 0.7);
        --outline: #DCE2EA;
        --ghost-hover: #F1F4F8;
        --progress: #1D4ED8;
        --card-face: #FAFBFE;
        --card-edge: #DEE4EE;
        --card-surface: color-mix(in srgb, var(--surface-1) 95%, white 5%);
        --card-outline: color-mix(in srgb, var(--outline) 78%, transparent);
        --card-elevation: 0 10px 20px -16px rgba(15, 23, 42, 0.28), 0 4px 10px -8px rgba(15, 23, 42, 0.14);
        --card-rank: color-mix(in srgb, var(--text-primary) 95%, white 5%);
        --card-placeholder-surface: color-mix(in srgb, var(--surface-1) 93%, var(--muted-bg) 7%);
        --card-placeholder-outline: color-mix(in srgb, var(--outline) 76%, transparent);
        --suit-spade: #1F2937;
        --suit-heart: color-mix(in srgb, #E65578 66%, var(--card-rank) 34%);
        --suit-club: #26B77A;
        --suit-diamond: color-mix(in srgb, #2EA8FF 70%, var(--card-rank) 30%);
        --action-neutral-text: #33415d;
        --action-neutral-bg: #edf2fb;
        --action-neutral-border: #d7e1f4;
        --action-neutral-selected-bg: #dee7f8;
        --action-neutral-selected-border: #7488d6;
        --action-accent-text: #4a3b6b;
        --action-accent-bg: #f3eefc;
        --action-accent-border: #e1d7f5;
        --action-accent-selected-bg: #e9e1f8;
        --action-accent-selected-border: #8a7cd6;
        --action-caution-text: #6c4459;
        --action-caution-bg: #f9e7f0;
        --action-caution-border: #f0d4e1;
        --action-caution-selected-bg: #f3dbe7;
        --action-caution-selected-border: #dfb9cc;
        --action-negative-text: #DC2626;
        --action-negative-bg: color-mix(in srgb, var(--error) 16%, white 84%);
        --action-negative-border: color-mix(in srgb, var(--error) 45%, transparent);
        --action-negative-selected-bg: var(--error);
        --action-negative-selected-border: color-mix(in srgb, var(--error) 70%, transparent);
        --chipbar-bg: #EAEFF7;
        --chipbar-text: #0F172A;
        --chipbar-border: color-mix(in srgb, #94A3B8 35%, transparent);
        --chipbar-hover: #DDE5F3;
        --chip-selected-border: #4A6AA0;
        --placeholder-base: color-mix(in srgb, var(--muted-border) 70%, white 30%);
        --placeholder-highlight: color-mix(in srgb, var(--brand) 22%, white 78%);
        --placeholder-border: color-mix(in srgb, var(--outline) 70%, transparent);
        --feedback-neutral-stripe: color-mix(in srgb, var(--outline) 82%, transparent);
        --feedback-chip-fill: color-mix(in srgb, var(--surface-1) 96%, white 4%);
        --feedback-success-stripe: #16A34A;
        --feedback-success-ev: #15803D;
        --feedback-success-outline: #16A34A;
        --feedback-warning-stripe: #D97706;
        --feedback-warning-ev: #92400E;
        --feedback-warning-outline: #D97706;
        --feedback-danger-stripe: #DC2626;
        --feedback-danger-ev: #B91C1C;
        --feedback-danger-outline: #DC2626;
        --feedback-blunder-stripe: #991B1B;
        --feedback-blunder-outline: #991B1B;
        --suit-glyph-stroke: rgba(0, 0, 0, 0.10);
      }

      /* Dark palette overrides */
      :root[data-theme="dark"] {

        color-scheme: dark;
        --bg: #0B1220;
        --surface-1: #111827;
        --surface-2: #16213A;
        --surface-3: #1E293B;
        --border: #1F2937;
        --field-bg: color-mix(in srgb, var(--surface-2) 55%, var(--surface-1) 45%);
        --field-bg-hover: color-mix(in srgb, var(--surface-2) 62%, var(--surface-1) 38%);
        --field-border: color-mix(in srgb, var(--outline) 85%, transparent);
        --field-border-hover: color-mix(in srgb, var(--outline) 78%, var(--brand) 18%);
        --field-border-focus: color-mix(in srgb, var(--brand) 46%, var(--outline) 54%);
        --field-placeholder: color-mix(in srgb, var(--text-tertiary) 72%, transparent);
        --field-helper: color-mix(in srgb, var(--text-secondary) 78%, transparent);
        --field-disabled-bg: color-mix(in srgb, var(--surface-2) 78%, var(--surface-1) 22%);
        --field-disabled-border: color-mix(in srgb, var(--outline) 70%, transparent);
        --field-error-border: color-mix(in srgb, var(--error) 48%, var(--outline) 52%);
        --shadow-soft: 0 18px 34px rgba(11, 15, 20, 0.4);
        --shadow-card: 0 1px 0 rgba(7, 11, 16, 0.35), 0 12px 24px rgba(7, 11, 16, 0.35);
        --text-primary: #E5E7EB;
        --text-secondary: #9CA3AF;
        --text-tertiary: #6B7280;
        --text-inverse: #0B0F14;
        --brand: #2563EB;
        --brand-pressed: #1D4ED8;
        --brand-outline: #2563EB;
        --on-brand: #F8FAFC;
        --success: #16A34A;
        --on-success: #04210E;
        --warning: #F59E0B;
        --on-warning: #1D1204;
        --error: #DC2626;
        --on-error: #2A0707;
        --chip-bg: color-mix(in oklab, #1D4ED8 18%, transparent);
        --chip-border: color-mix(in srgb, #1D4ED8 32%, transparent);
        --chip-text: #E6EDF3;
        --muted-bg: #141B23;
        --muted-border: #2A3645;
        --muted-hover: #1A2330;
        --divider-soft: rgba(42, 54, 69, 0.55);
        --outline: #2E3A49;
        --ghost-hover: #1A2330;
        --progress: #1D4ED8;
        --card-face: color-mix(in srgb, #FFFFFF 92%, var(--surface-1) 8%);
        --card-edge: color-mix(in srgb, #C9D4E3 82%, transparent);
        --card-surface: color-mix(in srgb, var(--surface-1) 82%, var(--surface-2) 18%);
        --card-outline: color-mix(in srgb, var(--outline) 52%, rgba(232, 237, 245, 0.42) 48%);
        --card-elevation: 0 8px 20px -16px rgba(5, 10, 18, 0.55), 0 0 0 1px rgba(235, 241, 254, 0.1);
        --card-rank: color-mix(in srgb, #FFFFFF 97%, var(--text-primary) 3%);
        --card-placeholder-surface: color-mix(in srgb, var(--surface-1) 58%, var(--surface-2) 42%);
        --card-placeholder-outline: color-mix(in srgb, var(--outline) 58%, rgba(232, 237, 245, 0.16) 42%);
        --suit-spade: #E5E7EB;
        --suit-heart: color-mix(in srgb, var(--card-rank) 24%, #FF90AB 76%);
        --suit-club: #37C88D;
        --suit-diamond: color-mix(in srgb, var(--card-rank) 24%, #66C5FF 76%);
        --action-neutral-text: #E5E7EB;
        --action-neutral-bg: #374151;
        --action-neutral-border: #4B5563;
        --action-neutral-selected-bg: #4A5568;
        --action-neutral-selected-border: #60A5FA;
        --action-accent-text: #DCE8FF;
        --action-accent-bg: #22314A;
        --action-accent-border: #4A6AA0;
        --action-accent-selected-bg: #2D4166;
        --action-accent-selected-border: #93B4F6;
        --action-caution-text: #FFDCE1;
        --action-caution-bg: #47232A;
        --action-caution-border: #B86774;
        --action-caution-selected-bg: #5A2F38;
        --action-caution-selected-border: #DE8C98;
        --action-negative-text: #FFE4E6;
        --action-negative-bg: color-mix(in srgb, var(--error) 32%, var(--surface-2) 68%);
        --action-negative-border: color-mix(in srgb, var(--error) 55%, transparent);
        --action-negative-selected-bg: var(--error);
        --action-negative-selected-border: color-mix(in srgb, var(--error) 70%, transparent);
        --chipbar-bg: #1F2937;
        --chipbar-text: #EAEFF7;
        --chipbar-border: color-mix(in srgb, #94A3B8 45%, transparent);
        --chipbar-hover: #2B3648;
        --chip-selected-border: #93B4F6;
        --placeholder-base: color-mix(in srgb, var(--surface-2) 80%, var(--surface-1) 20%);
        --placeholder-highlight: color-mix(in srgb, var(--brand) 24%, var(--surface-1) 76%);
        --placeholder-border: color-mix(in srgb, var(--outline) 55%, transparent);
        --feedback-neutral-stripe: color-mix(in srgb, var(--outline) 68%, transparent);
        --feedback-chip-fill: color-mix(in srgb, var(--surface-2) 90%, var(--surface-3) 10%);
        --feedback-success-stripe: #22C55E;
        --feedback-success-ev: #86EFAC;
        --feedback-success-outline: #22C55E;
        --feedback-warning-stripe: #F59E0B;
        --feedback-warning-ev: #FBBF24;
        --feedback-warning-outline: #F59E0B;
        --feedback-danger-stripe: #EF4444;
        --feedback-danger-ev: #F87171;
        --feedback-danger-outline: #EF4444;
        --feedback-blunder-stripe: #F05252;
        --feedback-blunder-outline: #F05252;
        --suit-glyph-stroke: rgba(255, 255, 255, 0.25);
      }

      :root:not([data-theme]),
      body {
        min-height: 100vh;
        margin: 0;
        font-family: var(--font-sans);
        font-size: var(--text-size-body);
        line-height: var(--line-height);
        background: var(--bg);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
      }
      .text-primary { color: var(--text-primary); }
      .text-secondary { color: var(--text-secondary); }
      .text-muted { color: var(--text-tertiary); }
      .hidden { display: none !important; }
      .eyebrow { letter-spacing: 0.22em; color: var(--text-tertiary); }
      main {
        flex: 1;
        width: min(860px, calc(100% - 2.5rem));
        padding-top: calc(var(--space-1) * 0.22);
        padding-bottom: calc(3.3rem + env(safe-area-inset-bottom, 0px));
      }
      main .page-section {
        margin-top: calc(var(--space-1) * 0.28);
      }
      main .page-section > * + * {
        margin-top: calc(var(--space-1) * 0.5);
      }
      #panel-play {
        display: flex;
        flex-direction: column;
        flex: 1 0 auto;
      }
      #panel-play > * + * {
        margin-top: calc(var(--space-1) * 0.75);
      }
      #panel-play .panel-soft,
      #feedback-banner,
      #primary-controls {
        flex-shrink: 0;
      }
      #progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--brand);
        transform: scaleX(0);
        transform-origin: left;
        opacity: 0;
        transition: opacity 0.35s ease, transform 0.35s ease;
        z-index: 50;
        pointer-events: none;
      }
      #progress-bar.active {
        opacity: 1;
        animation: progress-pulse 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }
      @keyframes progress-pulse {
        0% { transform: scaleX(0.15); }
        50% { transform: scaleX(0.7); }
        100% { transform: scaleX(1); }
      }
      .card {
        display: inline-flex;
        align-items: baseline;
        justify-content: center;
        border-radius: var(--radius-md);
        border: 1px solid var(--card-outline);
        padding: 0.42rem 0.7rem;
        font-size: clamp(1.3rem, 3.6vw, 1.66rem);
        font-weight: 700;
        letter-spacing: 0.18px;
        margin: 0 0.2rem 0.2rem 0;
        background: var(--card-surface);
        color: var(--card-rank);
        box-shadow: var(--card-elevation);
        transition: box-shadow 0.25s ease, transform 0.25s ease;
        line-height: 1.02;
        --card-accent: var(--card-rank);
      }
      .poker-card {
        width: clamp(38px, 6.8vw, 56px);
        height: clamp(50px, 9.2vw, 64px);
        flex: 0 0 clamp(38px, 6.8vw, 56px);
      }
      .card__rank {
        color: inherit;
      }
      .card__suit {
        display: inline-flex;
        align-items: center;
        margin-left: 0.18em;
        color: var(--card-accent);
        -webkit-text-stroke: 0;
        text-shadow: none;
      }
      .card.placeholder {
        color: color-mix(in srgb, var(--text-tertiary) 58%, transparent);
        background: linear-gradient(135deg, var(--card-placeholder-surface) 0%, color-mix(in srgb, var(--card-placeholder-surface) 68%, var(--surface-1) 32%) 100%);
        border: 1px solid var(--card-placeholder-outline);
        box-shadow: none;
        opacity: 0.95;
        position: relative;
        overflow: hidden;
        --card-accent: color-mix(in srgb, var(--text-tertiary) 56%, transparent);
      }
      .card.placeholder.placeholder-loading::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: -60%;
        width: 45%;
        background: linear-gradient(90deg, transparent 0%, color-mix(in srgb, var(--placeholder-highlight) 60%, transparent) 50%, transparent 100%);
        animation: placeholder-sheen 1.9s ease-in-out infinite;
      }
      @keyframes placeholder-sheen {
        0% { left: -60%; }
        60% { left: 120%; }
        100% { left: 120%; }
      }
      .card.placeholder .placeholder-icon {
        font-size: 1.12em;
        line-height: 1;
        letter-spacing: 0.02em;
        transition: opacity 0.3s ease;
        color: color-mix(in srgb, var(--placeholder-highlight) 40%, var(--text-tertiary) 60%);
        opacity: 0.55;
      }
      .card.placeholder.placeholder-wide {
        padding-inline: 0.95rem;
      }
      .density-compact .card.placeholder {
        padding-inline: 0.6rem;
      }
      .density-compact .card.placeholder.placeholder-wide {
        padding-inline: 0.8rem;
      }
      .card.s { --card-accent: var(--suit-spade); }
      .card.c { --card-accent: var(--suit-club); }
      .card.h { --card-accent: var(--suit-heart); }
      .card.d { --card-accent: var(--suit-diamond); }
      :root[data-theme="dark"] .card {
        background: var(--card-surface);
        border-color: var(--card-outline);
        box-shadow: var(--card-elevation);
      }
      :root[data-theme="dark"] .card.placeholder {
        background: var(--card-placeholder-surface);
        border-color: var(--card-placeholder-outline);
        color: color-mix(in srgb, var(--text-secondary) 52%, transparent);
      }
.glass {
        backdrop-filter: blur(18px);
        background: color-mix(in srgb, var(--surface-1) 85%, transparent);
        box-shadow: var(--shadow-soft);
      }
      .panel-box {
        background: color-mix(in srgb, var(--surface-2) 68%, var(--surface-1) 32%);
        border: 1px solid color-mix(in srgb, var(--outline) 90%, transparent);
        box-shadow: var(--shadow-card);
        color: var(--text-primary);
        border-radius: var(--radius-lg);
      }
      .panel-soft {
        background: color-mix(in srgb, var(--surface-2) 58%, var(--surface-1) 42%);
      }
      #panel-start .panel-box {
        background: color-mix(in srgb, var(--surface-2) 72%, var(--surface-1) 28%);
        border-color: color-mix(in srgb, var(--outline) 82%, transparent);
      }
      :root[data-theme="light"] #panel-start .panel-box {
        background: color-mix(in srgb, var(--surface-2) 82%, var(--brand) 18%);
        border-color: color-mix(in srgb, var(--border) 78%, var(--brand) 22%);
      }
      #panel-start {
        --field-bg: color-mix(in srgb, var(--surface-2) 74%, var(--surface-1) 26%);
        --field-bg-hover: color-mix(in srgb, var(--surface-2) 68%, var(--surface-1) 32%);
        --field-border: color-mix(in srgb, var(--outline) 72%, transparent);
        --field-border-hover: color-mix(in srgb, var(--outline) 58%, var(--brand) 18%);
        --field-border-focus: color-mix(in srgb, var(--brand) 52%, var(--outline) 48%);
      }
      :root[data-theme="light"] #panel-start {
        --field-bg: color-mix(in srgb, var(--surface-2) 70%, var(--brand) 30%);
        --field-bg-hover: color-mix(in srgb, var(--surface-2) 62%, var(--brand) 38%);
        --field-border: color-mix(in srgb, var(--border) 62%, var(--brand) 24%);
        --field-border-hover: color-mix(in srgb, var(--border) 52%, var(--brand) 32%);
        --field-border-focus: color-mix(in srgb, var(--brand) 58%, var(--border) 42%);
      }
      #panel-start .field-shell {
        background: color-mix(in srgb, var(--surface-2) 68%, var(--surface-1) 32%);
        border: 1px solid color-mix(in srgb, var(--outline) 78%, transparent);
        border-radius: var(--radius-md);
        box-shadow: inset 0 1px 0 color-mix(in srgb, var(--surface-1) 55%, transparent);
        padding: 6px;
      }
      :root[data-theme="light"] #panel-start .field-shell {
        background: color-mix(in srgb, var(--surface-2) 82%, var(--brand) 18%);
        border-color: color-mix(in srgb, var(--border) 74%, var(--brand) 26%);
        box-shadow: inset 0 1px 0 color-mix(in srgb, var(--surface-1) 65%, transparent);
      }
      #panel-start .field-shell input,
      #panel-start .field-shell select {
        color: var(--text-primary);
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
      }
      #panel-start .field-shell input::placeholder,
      #panel-start .field-shell select::placeholder {
        color: color-mix(in srgb, var(--text-secondary) 62%, transparent);
        opacity: 0.8;
      }
      #panel-start .field-shell input:hover,
      #panel-start .field-shell select:hover {
        background: transparent;
      }
      #panel-start .field-shell input:focus-visible,
      #panel-start .field-shell select:focus-visible {
        background: transparent;
        border: none;
        box-shadow: none;
      }
      #panel-start .field-shell:focus-within {
        border-color: var(--field-border-focus);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--field-border-focus) 55%, transparent), 0 0 0 calc(var(--focus-ring)) color-mix(in srgb, var(--field-border-focus) 25%, transparent);
      }
      .surface-card {
        background: color-mix(in srgb, var(--surface-2) 64%, var(--surface-1) 36%);
        border: 1px solid color-mix(in srgb, var(--outline) 85%, transparent);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-card);
        color: var(--text-primary);
      }
      .field-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .field-label {
        font-size: var(--text-size-label);
        font-weight: 650;
        letter-spacing: -0.01em;
        color: var(--text-primary);
      }
      input,
      select,
      textarea {
        color: var(--text-primary);
        background: var(--field-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--field-border);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--field-border) 38%, transparent);
        padding: 0.5rem 0.85rem;
        font-weight: 600;
        letter-spacing: -0.005em;
        transition: background-color 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease, color 0.18s ease;
        min-height: calc(var(--min-tap) - 10px);
        appearance: none;
        caret-color: var(--text-primary);
      }
      input::placeholder,
      textarea::placeholder {
        color: var(--field-placeholder);
        font-weight: 500;
        opacity: 0.64;
      }
      input:not(:placeholder-shown)::placeholder,
      textarea:not(:placeholder-shown)::placeholder {
        opacity: 0;
      }
      input:hover,
      select:hover,
      textarea:hover {
        border-color: var(--field-border-hover);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--field-border-hover) 48%, transparent);
        background: var(--field-bg-hover);
      }
      input:focus-visible,
      select:focus-visible,
      textarea:focus-visible {
        outline: none;
        border-color: var(--field-border-focus);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--field-border-focus) 60%, transparent), 0 0 0 calc(var(--focus-ring)) color-mix(in srgb, var(--field-border-focus) 24%, transparent);
        background: var(--field-bg);
      }
      input:disabled,
      select:disabled,
      textarea:disabled {
        background: var(--field-disabled-bg);
        border-color: var(--field-disabled-border);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--field-disabled-border) 32%, transparent);
        color: color-mix(in srgb, var(--text-secondary) 65%, var(--text-tertiary) 35%);
      }
      input.error,
      select.error,
      textarea.error {
        border-color: var(--field-error-border);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--field-error-border) 52%, transparent), 0 0 0 calc(var(--focus-ring) - 1px) color-mix(in srgb, var(--field-error-border) 18%, transparent);
      }
      input:-webkit-autofill {
        transition: background-color 5000s ease-in-out 0s, color 5000s ease-in-out 0s;
        box-shadow: inset 0 0 0px 1000px var(--field-bg) !important;
        -webkit-text-fill-color: var(--text-primary) !important;
      }
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      .field-shell {
        position: relative;
        width: 100%;
      }
      .field-shell input,
      .field-shell select,
      .field-shell textarea {
        width: 100%;
      }
      .field-shell:focus-within input,
      .field-shell:focus-within select,
      .field-shell:focus-within textarea {
        background: var(--field-bg);
      }
      .field-helper {
        color: var(--field-helper);
        font-size: 12px;
        line-height: 1.5;
        max-inline-size: 54ch;
      }
      .field-error-message {
        font-size: 12px;
        margin: 2px 0 0;
        color: color-mix(in srgb, var(--error) 66%, var(--text-primary) 34%);
      }
      .field-error-message[hidden] {
        display: none;
      }
      .field-group.has-error .field-label {
        color: var(--text-primary);
      }
      .field-group.has-error input,
      .field-group.has-error select,
      .field-group.has-error textarea {
        color: var(--text-primary);
      }
      .field-helper.long {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
      }
      button {
        color: inherit;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      button:not([disabled]):active { transform: translateY(1px); }
      button[disabled] { cursor: not-allowed !important; opacity: 0.65 !important; box-shadow: none !important; }

      body,
      .app-header,
      .panel-box,
      .info-card,
      .feedback-banner,
      .btn {
        transition: background-color 0.12s ease, color 0.12s ease, border-color 0.12s ease;
      }

      @media (prefers-reduced-motion: reduce) {
        body,
        .app-header,
        .panel-box,
        .info-card,
        .feedback-banner,
        .btn {
          transition: none !important;
        }
      }
      .btn {
        font: 600 var(--text-size-body)/var(--line-height) var(--font-sans);
        border-radius: var(--radius-md);
        padding: 12px 16px;
        border: 1px solid transparent;
        min-height: var(--min-tap);
        transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease, transform 0.18s ease;
      }
      .btn:focus-visible { outline: var(--focus-ring) solid var(--focus-color); outline-offset: 2px; }
      .btn:disabled { opacity: 0.55; cursor: not-allowed; }

      .btn-primary {
        background: var(--brand);
        color: var(--on-brand);
        border-color: color-mix(in srgb, var(--brand) 65%, transparent);
      }
      .btn-primary:hover {
        background: color-mix(in srgb, var(--brand) 90%, white 10%);
        border-color: color-mix(in srgb, var(--brand) 72%, transparent);
      }
      .btn-primary:active {
        background: var(--brand-pressed);
        border-color: color-mix(in srgb, var(--brand-pressed) 70%, transparent);
      }

      .btn-chip {
        background: color-mix(in srgb, var(--surface-2) 70%, var(--surface-1) 30%);
        color: var(--text-primary);
        border: 1px solid color-mix(in srgb, var(--outline) 62%, transparent);
        box-shadow: none;
      }
      .btn-chip:hover {
        background: color-mix(in srgb, var(--surface-2) 62%, var(--surface-1) 38%);
        border-color: color-mix(in srgb, var(--outline) 58%, var(--brand) 20%);
      }
      .btn-chip:active {
        background: color-mix(in srgb, var(--surface-2) 58%, var(--surface-1) 42%);
      }

      .btn-muted {
        background: var(--muted-bg);
        color: var(--text-secondary);
        border: 1px solid var(--muted-border);
      }
      .btn-muted:hover { background: var(--muted-hover); }

      .btn-secondary-tone {
        background: var(--surface-2);
        color: var(--text-primary);
        border: 1px solid var(--border);
      }
      .btn-secondary-tone:hover { background: var(--ghost-hover); }

      .btn-ghost {
        background: transparent;
        color: var(--text-primary);
        border: 1px solid transparent;
      }
      .btn-ghost:hover {
        background: var(--ghost-hover);
        border-color: var(--border);
      }

      .primary-cta {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 0;
        margin: 0;
        padding-bottom: max(16px, var(--safe-bottom));
      }
      .primary-cta__button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        width: 100%;
        min-height: 48px;
        font-size: 1rem;
        border-radius: var(--radius-md);
        box-shadow: 0 18px 28px -20px rgba(37, 99, 235, 0.65);
      }
      .primary-cta__button:not([disabled]):hover {
        box-shadow: 0 20px 30px -18px rgba(37, 99, 235, 0.7);
      }
      .primary-cta__button:not([disabled]):active {
        transform: scale(0.985);
        box-shadow: 0 10px 20px -16px rgba(29, 78, 216, 0.6);
      }
      :root[data-theme="dark"] .primary-cta__button {
        box-shadow: 0 20px 32px -22px rgba(37, 99, 235, 0.5);
      }
      :root[data-theme="dark"] .primary-cta__button:not([disabled]):active {
        box-shadow: 0 12px 24px -18px rgba(29, 78, 216, 0.55);
      }
      .primary-cta__chevron {
        font-size: 1.2em;
        transform: translateY(0.5px);
        opacity: 0.88;
      }
      .session-secondary-actions {
        display: flex;
        justify-content: center;
        padding: 4px 0;
      }
      .session-secondary-link {
        appearance: none;
        background: none;
        border: none;
        color: color-mix(in srgb, var(--text-secondary) 82%, transparent);
        font-size: 0.92rem;
        font-weight: 550;
        letter-spacing: 0.01em;
        padding: 4px 8px;
        border-radius: 999px;
        transition: color 0.2s ease, background 0.2s ease;
      }
      .session-secondary-link:hover {
        color: var(--text-primary);
        background: color-mix(in srgb, var(--ghost-hover) 72%, transparent);
      }
      .session-secondary-link:focus-visible {
        outline: var(--focus-ring) solid var(--focus-color);
        outline-offset: 2px;
      }

      .border-divider-soft {
        border-color: var(--divider-soft) !important;
      }

      .border-outline {
        border: 1px solid var(--outline) !important;
      }

      .feedback-success {
        background: color-mix(in srgb, var(--success) 18%, transparent);
        color: var(--on-success);
        border-left: 4px solid color-mix(in srgb, var(--success) 40%, transparent);
      }
      .feedback-warning {
        background: color-mix(in srgb, var(--warning) 18%, transparent);
        color: var(--on-warning);
        border-left: 4px solid color-mix(in srgb, var(--warning) 40%, transparent);
      }
      .feedback-danger {
        background: color-mix(in srgb, var(--error) 18%, transparent);
        color: var(--on-error);
        border-left: 4px solid color-mix(in srgb, var(--error) 40%, transparent);
      }

      .result-panel {
        line-height: 1.35;
      }

      .app-header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(12px);
        background: var(--surface-1);
        border-bottom: 1px solid var(--border);
        padding-top: max(6px, var(--safe-top));
        padding-bottom: 6px;
      }
      .app-header__inner {
        max-width: 42rem;
        margin: 0 auto;
        padding-inline: 1rem;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .app-header .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 52px;
      }
      .app-header .brand {
        display: flex;
        align-items: center;
        gap: 0.45rem;
      }
      .app-header .brand-mark {
        display: inline-grid;
        place-items: center;
        width: 2.35rem;
        height: 2.35rem;
        border-radius: 1rem;
        background: var(--brand);
        color: var(--on-brand);
        font-size: 1.3rem;
        line-height: 1;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12), 0 1px 2px rgba(0, 0, 0, 0.16);
        padding: 0.45rem;
      }
      .app-header .wordmark {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        letter-spacing: -0.01em;
      }
      .app-header .wordmark .lead {
        font-weight: 800;
      }
      .app-header .wordmark .trail {
        opacity: 0.92;
      }
      .app-header .header-actions {
        display: flex;
        align-items: center;
      }
      .theme-control {
        position: relative;
        display: flex;
      }
      .theme-toggle {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 3px;
        min-width: 44px;
        height: 44px;
        padding: 0 6px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface-2);
        color: var(--text-primary);
        transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      }
      .theme-toggle:hover {
        background: var(--ghost-hover);
        color: var(--text-primary);
      }
      .theme-toggle:focus-visible {
        outline: var(--focus-ring) solid var(--focus-color);
        outline-offset: 2px;
      }
      .theme-toggle[data-open="true"] {
        border-color: color-mix(in srgb, var(--brand) 52%, var(--border) 48%);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 12%, transparent);
      }
      .theme-toggle__icon-shell {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
      }
      .theme-icon {
        position: absolute;
        inset: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }
      .theme-icon svg {
        width: 16px;
        height: 16px;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .theme-toggle[data-mode="light"] .theme-icon--sun,
      .theme-toggle[data-mode="dark"] .theme-icon--moon {
        opacity: 1;
        transform: scale(1);
      }
      .theme-toggle__chevron {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 12px;
        height: 12px;
        color: color-mix(in srgb, var(--text-secondary) 65%, transparent);
        margin-top: 1px;
      }
      .theme-toggle__chevron svg {
        width: 100%;
        height: 100%;
      }
      .theme-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
        padding: 6px;
        border-radius: var(--radius-md);
        border: 1px solid color-mix(in srgb, var(--outline) 70%, transparent);
        background: color-mix(in srgb, var(--surface-1) 96%, transparent);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
        min-width: 184px;
        z-index: 20;
      }
      .theme-menu[hidden] {
        display: none;
      }
      .theme-menu__item {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 7px 10px;
        border: none;
        border-radius: var(--radius-sm);
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.82rem;
        font-weight: 600;
        text-align: left;
        transition: background 0.2s ease, color 0.2s ease;
        cursor: pointer;
      }
      .theme-menu__item:hover,
      .theme-menu__item:focus-visible {
        background: var(--ghost-hover);
        color: var(--text-primary);
        outline: none;
      }
      .theme-menu__icon svg {
        width: 18px;
        height: 18px;
      }
      .theme-menu__label {
        flex: 1;
      }
      .theme-menu__check {
        width: 16px;
        height: 16px;
        color: var(--brand);
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .theme-menu__check svg {
        width: 100%;
        height: 100%;
      }
      .theme-menu__item[aria-checked="true"] {
        background: color-mix(in srgb, var(--ghost-hover) 70%, transparent);
        color: var(--text-primary);
      }
      .theme-menu__item[aria-checked="true"] .theme-menu__check {
        opacity: 1;
      }
      .status-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 40px;
        font-size: 0.82rem;
        color: var(--text-secondary);
      }
      .status-compact {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        width: 100%;
        white-space: nowrap;
        overflow-x: auto;
        padding: 3px clamp(10px, 1.6vw, 16px);
        scrollbar-width: none;
        -webkit-overflow-scrolling: touch;
      }
      .status-compact::-webkit-scrollbar { display: none; }
      .status-compact__text {
        display: inline-flex;
        align-items: baseline;
        justify-content: center;
        gap: 6px;
        white-space: nowrap;
        font-variant-numeric: tabular-nums;
        font-size: clamp(0.7rem, 0.68rem + 0.6vw, 0.8rem);
        margin: 0 auto;
      }
      .status-compact__text .status-seg:first-child { padding-left: 2px; }
      .status-compact__text .status-seg:last-child { padding-right: 2px; }
      .status-seg {
        display: inline-flex;
        align-items: baseline;
        gap: 3px;
        color: var(--text-secondary);
      }
      .status-seg strong {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.96em;
      }
      .status-dot {
        opacity: 0.35;
        font-weight: 500;
        margin: 0 4px;
      }
      .inline-card {
        display: inline-flex;
        align-items: baseline;
        gap: 0.12em;
        line-height: 1;
        font-weight: 600;
        font-variant-numeric: tabular-nums;
        vertical-align: baseline;
      }
      .inline-card__rank {
        display: inline-flex;
        align-items: baseline;
        line-height: 1;
        color: var(--card-rank);
      }
      .inline-card__suit {
        display: inline-block;
        margin-left: 0.04em;
        line-height: 1;
        transform: translateY(-0.04em);
        font-size: 0.92em;
        -webkit-text-stroke: 1px var(--suit-glyph-stroke);
        text-shadow: 0 0 0 var(--suit-glyph-stroke);
        paint-order: stroke fill;
      }
      .inline-card + .inline-card {
        margin-left: 0.12em;
      }
      .inline-card--s .inline-card__suit { color: var(--suit-spade); }
      .inline-card--h .inline-card__suit { color: var(--suit-heart); }
      .inline-card--d .inline-card__suit { color: var(--suit-diamond); }
      .inline-card--c .inline-card__suit { color: var(--suit-club); }
      .status-line {
        margin-top: calc(var(--space-1) * 0.45);
        margin-bottom: calc(var(--space-1) * 0.65);
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .status-line .status-item {
        display: flex;
        align-items: baseline;
        gap: 6px;
      }
      .status-line .status-label {
        color: color-mix(in srgb, var(--text-secondary) 82%, transparent);
        font-weight: 600;
        min-width: 2.6rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.75rem;
      }
      .status-line .status-value {
        color: var(--text-primary);
        font-weight: 550;
      }
      .status-line--summary {
        align-items: flex-start;
      }
      .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 8px;
        padding: 4px 10px;
        background: color-mix(in srgb, var(--muted-bg) 85%, transparent);
        border: 1px solid color-mix(in srgb, var(--outline) 78%, transparent);
        color: color-mix(in srgb, var(--text-secondary) 78%, transparent);
        font-size: 0.78rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .status-chip__text {
        color: inherit;
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      .status-chip__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--brand) 14%, transparent);
        color: var(--brand);
        font-size: 0.8rem;
        line-height: 1;
      }
      :root[data-theme="dark"] .status-chip {
        background: color-mix(in srgb, var(--surface-2) 82%, transparent);
        border-color: color-mix(in srgb, var(--outline) 70%, transparent);
        color: color-mix(in srgb, var(--text-secondary) 70%, transparent);
      }
      :root[data-theme="dark"] .status-chip__icon {
        background: color-mix(in srgb, var(--brand) 22%, transparent);
        color: color-mix(in srgb, var(--brand) 90%, transparent);
      }
      #panel-play > * + * {
        margin-top: calc(var(--space-1) * 0.85);
      }
      .action-area {
        position: sticky;
        bottom: calc(var(--space-1) + env(safe-area-inset-bottom, 0px));
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: calc(var(--space-1) * 0.75);
        padding: calc(var(--space-1) - 3px) calc(var(--space-1)) calc(var(--space-1) + env(safe-area-inset-bottom, 0px) - 3px);
        background: transparent;
        border-radius: var(--radius-md);
        border: 0;
        box-shadow: none;
        transition: background 0.2s ease, border-color 0.2s ease;
      }
      .action-area::after,
      .action-area::before {
        content: '';
        position: absolute;
        inset: 4px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .action-area::after {
        border-radius: var(--radius-md);
        background: color-mix(in srgb, var(--surface-2) 72%, transparent 28%);
        backdrop-filter: blur(2px);
      }
      .action-area::before {
        width: 30px;
        height: 30px;
        margin: auto;
        border-radius: 50%;
        border: 3px solid color-mix(in srgb, var(--brand) 28%, transparent);
        border-top-color: color-mix(in srgb, var(--brand) 85%, transparent);
        animation: action-spin 1s linear infinite;
      }
      .action-area[data-pending="true"]::after,
      .action-area[data-pending="true"]::before {
        opacity: 1;
      }
      .ev-pulse {
        position: absolute;
        top: -12px;
        right: 18px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.72rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        background: color-mix(in srgb, var(--surface-1) 65%, var(--brand) 35%);
        color: var(--brand);
        border: 1px solid color-mix(in srgb, var(--brand) 40%, transparent);
        box-shadow: 0 8px 18px rgba(37, 99, 235, 0.18);
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 0.18s ease, transform 0.18s ease;
        pointer-events: none;
      }
      .ev-pulse[data-state="positive"] {
        background: color-mix(in srgb, var(--surface-1) 60%, var(--success) 40%);
        color: color-mix(in srgb, var(--success) 70%, var(--on-success) 30%);
        border-color: color-mix(in srgb, var(--success) 50%, transparent);
      }
      .ev-pulse[data-state="negative"] {
        background: color-mix(in srgb, var(--surface-1) 55%, var(--error) 45%);
        color: color-mix(in srgb, var(--error) 70%, var(--on-error) 30%);
        border-color: color-mix(in srgb, var(--error) 55%, transparent);
      }
      .ev-pulse.is-active {
        opacity: 1;
        transform: translateY(0);
      }
      #panel-play .panel-box.panel-soft {
        padding: calc(var(--space-1) + 3px);
      }
      #panel-play .panel-soft > * + * {
        margin-top: calc(var(--space-1) + 1px);
      }
      .summary-page {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1 0 auto;
      }
      .summary-page__header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0;
      }
      .summary-page__back {
        appearance: none;
        border: none;
        background: none;
        width: 36px;
        height: 36px;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: color-mix(in srgb, var(--text-secondary) 80%, transparent);
        font-size: 1.35rem;
        line-height: 1;
        transition: color 0.2s ease, background 0.2s ease;
      }
      .summary-page__back:hover {
        background: var(--ghost-hover);
        color: var(--text-primary);
      }
      .summary-page__back:focus-visible {
        outline: var(--focus-ring) solid var(--focus-color);
        outline-offset: 2px;
      }
      .summary-page__title {
        margin: 0;
        font-size: clamp(1.28rem, 2.6vw, 1.52rem);
        font-weight: 650;
        letter-spacing: -0.01em;
        color: var(--text-primary);
      }
      .summary-page__body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .summary-hero {
        display: grid;
        gap: 8px;
        align-items: stretch;
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .summary-hero__metric {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 8px 10px;
        border-radius: var(--radius-md);
        border: 1px solid color-mix(in srgb, var(--outline) 70%, transparent);
        background: color-mix(in srgb, var(--surface-1) 92%, transparent);
      }
      .summary-hero__label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: color-mix(in srgb, var(--text-secondary) 78%, transparent);
      }
      .summary-hero__value {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }
      .summary-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .summary-section__title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 650;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: color-mix(in srgb, var(--text-secondary) 70%, transparent);
      }
      .summary-card {
        border: 1px solid color-mix(in srgb, var(--outline) 70%, transparent);
        border-radius: var(--radius-md);
        background: color-mix(in srgb, var(--surface-1) 96%, transparent);
        padding: 9px 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .summary-card__label {
        font-size: 0.85rem;
        font-weight: 550;
        color: color-mix(in srgb, var(--text-secondary) 80%, transparent);
      }
      .summary-card__value {
        font-size: 1.2rem;
        font-weight: 680;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }
      .summary-card__value.is-negative {
        color: color-mix(in srgb, var(--error) 68%, transparent);
      }
      .summary-card__meta {
        font-size: 0.85rem;
        color: color-mix(in srgb, var(--text-secondary) 80%, transparent);
      }
      .summary-card--history {
        margin-top: -2px;
      }
      .summary-list {
        display: flex;
        flex-direction: column;
        gap: 7px;
      }
      .summary-list__item {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        font-size: 0.9rem;
        color: var(--text-primary);
      }
      .summary-list__label {
        color: color-mix(in srgb, var(--text-secondary) 80%, transparent);
      }
      .summary-page__footer {
        margin-top: auto;
        padding-top: 10px;
        display: flex;
        justify-content: center;
      }
      .summary-primary {
        width: min(320px, 100%);
      }
      #feedback-banner {
        margin-top: calc(var(--space-1) * 0.75);
      }
      #primary-controls.primary-cta {
        margin-top: auto;
        padding-top: calc(var(--space-1) * 0.9);
      }
      .action-area.is-hidden {
        display: none;
      }
      @keyframes action-spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .action-main {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
        width: min(100%, 340px);
        margin-inline: auto;
      }
      .next-hand-main {
        align-items: center;
      }
      .next-hand-main .action-slot {
        width: min(220px, 100%);
      }
      .action-slot {
        min-height: calc(var(--min-tap) - 4px);
        border-radius: var(--radius-md);
        width: 100%;
      }
      .action-slot.is-placeholder {
        border: 1px solid transparent;
        background: transparent;
        visibility: hidden;
      }
      .bet-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
        background: color-mix(in srgb, var(--action-accent-bg) 82%, var(--surface-1) 18%);
        border: 1px solid color-mix(in srgb, var(--action-accent-border) 70%, transparent);
        border-radius: var(--radius-md);
        padding: calc(var(--space-1) + 2px);
      }
      .bet-group__label {
        font-size: 0.76rem;
        font-weight: 650;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: color-mix(in srgb, var(--action-accent-text) 85%, var(--text-primary) 15%);
      }
      .bet-group__jam {
        margin-top: 10px;
        display: flex;
        width: 100%;
      }
      .action-sizes {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        min-height: calc(var(--min-tap) - 10px);
      }
      .action-sizes .action-button {
        background: var(--action-accent-bg);
        border-color: var(--action-accent-border);
        color: var(--action-accent-text);
      }
      .action-sizes .action-button:nth-child(2) {
        background: color-mix(in srgb, var(--action-accent-bg) 92%, var(--action-accent-selected-bg) 8%);
      }
      .action-sizes .action-button:nth-child(3) {
        background: color-mix(in srgb, var(--action-accent-bg) 88%, var(--action-accent-selected-bg) 12%);
      }
      .action-sizes .action-button:hover {
        border-color: var(--action-accent-selected-border);
        background: color-mix(in srgb, var(--action-accent-selected-bg) 30%, var(--action-accent-bg) 70%);
      }
      .action-sizes.is-hidden {
        display: none;
      }
      .action-button {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        gap: 2px;
        width: 100%;
        min-height: var(--min-tap);
        border-radius: var(--radius-md);
        border: 1px solid var(--field-border);
        background: #f9faff;
        color: var(--text-primary);
        font: 600 var(--text-size-body)/1.3 var(--font-sans);
        padding: calc(var(--space-1)) calc(var(--space-1) + 4px);
        text-align: left;
        transition: background 0.18s ease, border-color 0.18s ease, transform 0.18s ease, color 0.18s ease, box-shadow 0.18s ease;
        word-break: break-word;
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
      }
      .action-button:not([disabled]):active {
        transform: translateY(1px);
        box-shadow: 0 3px 8px rgba(15, 23, 42, 0.12);
      }
      .action-button:focus-visible {
        outline: var(--focus-ring) solid var(--brand-outline);
        outline-offset: 2px;
      }
      .action-button .action-label {
        width: 100%;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .action-button .action-meta {
        font-size: 0.75rem;
        color: var(--field-helper);
        font-weight: 500;
      }
      .action-button.action-neutral {
        background: var(--action-neutral-bg);
        border-color: var(--action-neutral-border);
        color: var(--action-neutral-text);
      }
      .action-button.action-neutral:hover {
        background: color-mix(in srgb, var(--action-neutral-bg) 90%, var(--action-neutral-selected-bg) 10%);
        border-color: var(--action-neutral-selected-border);
      }
      .action-button.action-primary {
        background: var(--surface-2);
        border-color: color-mix(in srgb, var(--border) 70%, transparent);
        color: var(--text-primary);
      }
      .action-button.action-primary:hover {
        background: color-mix(in srgb, var(--surface-2) 85%, var(--brand) 15%);
        border-color: color-mix(in srgb, var(--brand) 25%, var(--border) 75%);
      }
      .action-button.action-destructive {
        background: color-mix(in srgb, var(--action-neutral-bg) 92%, transparent);
        border-color: color-mix(in srgb, var(--action-neutral-border) 75%, transparent);
        color: var(--action-neutral-text);
      }
      .action-button.action-destructive:hover {
        background: color-mix(in srgb, var(--action-neutral-selected-bg) 70%, var(--action-neutral-bg) 30%);
        border-color: color-mix(in srgb, var(--action-neutral-selected-border) 80%, transparent);
      }
      .action-button.action-negative {
        background: var(--action-negative-bg);
        border-color: var(--action-negative-border);
        color: var(--action-negative-text);
      }
      .action-button.action-negative:hover {
        background: var(--action-negative-selected-bg);
        border-color: var(--action-negative-selected-border);
      }
      .action-button[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
        pointer-events: none;
      }
      .action-button.is-selected,
      .action-button.is-armed {
        background: var(--action-accent-selected-bg);
        border-color: var(--action-accent-selected-border);
        color: var(--action-accent-text);
        transform: scale(1.01);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      }
      .action-button.is-armed {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
      }
      .action-button.is-armed.action-neutral {
        background: var(--action-neutral-selected-bg);
        border-color: var(--action-neutral-selected-border);
        color: var(--action-neutral-text);
      }
      .action-button.is-armed.action-primary {
        background: var(--action-accent-selected-bg);
        border-color: var(--action-accent-selected-border);
        color: var(--action-accent-text);
      }
      .action-button.is-armed.action-destructive {
        background: var(--action-caution-selected-bg);
        border-color: var(--action-caution-selected-border);
        color: var(--action-caution-text);
      }
      .action-button.is-armed.action-negative {
        background: var(--action-negative-selected-bg);
        border-color: var(--action-negative-selected-border);
        color: var(--action-negative-text);
      }
      :root[data-theme="dark"] .action-button.action-negative {
        background: var(--action-negative-bg);
        border-color: color-mix(in srgb, var(--action-negative-border) 70%, rgba(255, 255, 255, 0.4) 30%);
        color: var(--action-negative-text);
        box-shadow: 0 12px 26px rgba(12, 18, 28, 0.45), 0 0 0 1px rgba(255, 255, 255, 0.05);
      }
      :root[data-theme="dark"] .action-button,
      :root[data-theme="dark"] .action-button.action-primary {
        background: var(--surface-2);
        border-color: color-mix(in srgb, var(--border) 80%, transparent);
        box-shadow: none;
      }
      :root[data-theme="dark"] .action-button:hover {
        border-color: color-mix(in srgb, var(--brand) 25%, var(--border) 75%);
      }
      :root[data-theme="dark"] .action-button.action-negative .action-meta {
        color: color-mix(in srgb, var(--action-negative-text) 65%, rgba(255, 255, 255, 0.75) 35%);
      }
      :root[data-theme="dark"] .action-button.action-negative:hover {
        background: color-mix(in srgb, var(--action-negative-selected-bg) 80%, var(--action-negative-bg) 20%);
        border-color: color-mix(in srgb, var(--action-negative-selected-border) 80%, rgba(255, 255, 255, 0.45) 20%);
        box-shadow: 0 16px 30px rgba(12, 18, 28, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.08);
      }
      :root[data-theme="dark"] .action-button.action-negative:active {
        background: color-mix(in srgb, var(--action-negative-bg) 75%, #8C1D33 25%);
        border-color: color-mix(in srgb, var(--action-negative-border) 80%, rgba(255, 255, 255, 0.3) 20%);
        box-shadow: 0 8px 18px rgba(12, 18, 28, 0.45), 0 0 0 1px rgba(255, 255, 255, 0.06);
      }
      :root[data-theme="dark"] .action-button.is-armed.action-negative {
        background: var(--action-negative-selected-bg);
        border-color: var(--action-negative-selected-border);
        color: var(--action-negative-text);
        box-shadow: 0 20px 36px rgba(12, 18, 28, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.1);
      }
      .next-hand-btn {
        margin-top: var(--space-2);
        padding: calc(var(--space-1) + 6px) calc(var(--space-1) * 3);
        font-size: 1rem;
        font-weight: 650;
        background: color-mix(in srgb, var(--action-neutral-selected-bg) 80%, var(--action-neutral-bg) 20%);
        border-color: var(--action-neutral-selected-border);
        color: var(--action-neutral-text);
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      }
      .next-hand-btn:hover {
        background: color-mix(in srgb, var(--action-neutral-selected-bg) 65%, var(--action-neutral-bg) 35%);
        border-color: color-mix(in srgb, var(--action-neutral-selected-border) 85%, transparent);
      }
      .size-chip {
        display: inline-flex;
        align-items: baseline;
        justify-content: center;
        gap: 0.18em;
        border-radius: var(--radius-md);
        border: 1px solid var(--muted-border);
        background: var(--muted-bg);
        color: var(--text-primary);
        padding: 12px 0;
        font-size: 0.84rem;
        font-weight: 600;
        text-align: center;
        transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease, box-shadow 0.18s ease;
      }
      .size-chip:hover {
        background: var(--muted-hover);
        border-color: color-mix(in srgb, var(--muted-border) 65%, var(--brand) 35%);
      }
      .size-chip__value {
        font-size: 1.08em;
        font-weight: 700;
        margin-right: 0.12em;
      }
      .size-chip__unit {
        opacity: 0.78;
      }
      .size-chip--jam {
        display: inline-flex;
        align-items: baseline;
        justify-content: center;
        width: 100%;
        font-weight: 700;
        letter-spacing: 0.015em;
        text-transform: uppercase;
        background: var(--brand);
        color: var(--on-brand);
        border-color: color-mix(in srgb, var(--brand) 80%, transparent);
        box-shadow: 0 12px 22px rgba(37, 99, 235, 0.24);
      }
      .size-chip--jam:hover {
        background: color-mix(in srgb, var(--brand) 94%, white 6%);
        border-color: color-mix(in srgb, var(--brand) 88%, transparent);
      }
      .size-chip--jam:active {
        background: var(--brand-pressed);
        border-color: color-mix(in srgb, var(--brand-pressed) 80%, transparent);
      }
      .size-chip--jam.is-confirm {
        background: color-mix(in srgb, var(--brand-pressed) 82%, var(--surface-1) 18%);
        border-color: color-mix(in srgb, var(--brand-pressed) 80%, transparent);
        box-shadow: 0 8px 16px rgba(29, 78, 216, 0.25);
      }
      .size-chip:focus-visible {
        outline: var(--focus-ring) solid var(--brand-outline);
        outline-offset: 2px;
      }
      .size-chip.is-selected {
        background: var(--muted-bg);
        border-color: color-mix(in srgb, var(--muted-border) 55%, var(--brand) 45%);
        color: var(--text-primary);
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--brand-outline) 30%, transparent);
      }
      .size-chip[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
      }
      :root[data-theme="dark"] .size-chip {
        background: color-mix(in srgb, var(--surface-2) 90%, transparent 10%);
        border-color: color-mix(in srgb, var(--border) 78%, transparent);
        color: var(--text-primary);
      }
      :root[data-theme="dark"] .size-chip:hover {
        background: color-mix(in srgb, var(--surface-2) 75%, var(--brand) 25%);
        border-color: color-mix(in srgb, var(--brand) 35%, var(--border) 65%);
      }
      :root[data-theme="dark"] .size-chip.is-selected {
        background: color-mix(in srgb, var(--surface-2) 88%, transparent 12%);
        border-color: color-mix(in srgb, var(--brand) 35%, var(--border) 65%);
        color: var(--text-primary);
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--brand-outline) 22%, transparent);
      }
      :root[data-theme="dark"] .size-chip--jam {
        box-shadow: none;
      }
      .action-area.is-disabled .action-button,
      .action-area.is-disabled .size-chip {
        opacity: 0.45;
        pointer-events: none;
      }
      .feedback-banner {
        position: relative;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        padding: 12px 16px;
        border-radius: var(--radius-md);
        border: 1px solid color-mix(in srgb, var(--outline) 72%, transparent);
        background: var(--surface-1);
        color: var(--text-secondary);
        box-shadow: none;
        flex-wrap: wrap;
      }
      .feedback-banner::before {
        content: '';
        position: absolute;
        top: 10px;
        bottom: 10px;
        left: -1px;
        width: 4px;
        border-radius: 999px;
        background: var(--feedback-neutral-stripe);
      }
      .feedback-banner[data-state="success"]::before,
      .feedback-banner[data-state="gain"]::before {
        background: var(--feedback-success-stripe);
      }
      .feedback-banner[data-state="warning"]::before {
        background: var(--feedback-warning-stripe);
      }
      .feedback-banner[data-state="danger"]::before {
        background: var(--feedback-danger-stripe);
      }
      .feedback-banner[data-state="blunder"]::before {
        background: var(--feedback-blunder-stripe);
      }
      .feedback-text {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
        max-width: 100%;
        flex: 1;
      }
      .ev-callout__headline {
        display: inline-flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 0.95rem;
        color: var(--text-primary);
      }
      .ev-callout__label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: color-mix(in srgb, var(--text-secondary) 70%, transparent);
      }
      .ev-callout__value {
        font-weight: 650;
        color: var(--text-primary);
      }
      .ev-callout__value--tinted {
        color: var(--text-primary);
      }
      .feedback-banner[data-state="success"] .ev-callout__value--tinted,
      .feedback-banner[data-state="gain"] .ev-callout__value--tinted {
        color: var(--feedback-success-ev);
      }
      .feedback-banner[data-state="warning"] .ev-callout__value--tinted {
        color: var(--feedback-warning-ev);
      }
      .feedback-banner[data-state="danger"] .ev-callout__value--tinted,
      .feedback-banner[data-state="blunder"] .ev-callout__value--tinted {
        color: var(--feedback-danger-ev);
      }
      .ev-callout__chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 12px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--outline) 72%, transparent);
        background: var(--feedback-chip-fill);
        color: var(--text-primary);
        font-size: 0.8rem;
        font-weight: 600;
        line-height: 1.15;
        white-space: nowrap;
      }
      .ev-callout__chip[data-tone="success"],
      .ev-callout__chip[data-tone="gain"] {
        border-color: var(--feedback-success-outline);
      }
      .ev-callout__chip[data-tone="warning"] {
        border-color: var(--feedback-warning-outline);
      }
      .ev-callout__chip[data-tone="danger"] {
        border-color: var(--feedback-danger-outline);
      }
      .ev-callout__chip[data-tone="blunder"] {
        border-color: var(--feedback-blunder-outline);
      }
      .ev-chip__symbol {
        font-weight: 700;
        font-size: 0.85em;
        line-height: 1;
      }
      .ev-chip__text {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .ev-callout__chip[data-tone="success"] .ev-chip__symbol,
      .ev-callout__chip[data-tone="gain"] .ev-chip__symbol {
        color: var(--feedback-success-outline);
      }
      .ev-callout__chip[data-tone="warning"] .ev-chip__symbol {
        color: var(--feedback-warning-outline);
      }
      .ev-callout__chip[data-tone="danger"] .ev-chip__symbol {
        color: var(--feedback-danger-outline);
      }
      .ev-callout__chip[data-tone="blunder"] .ev-chip__symbol {
        color: var(--feedback-blunder-outline);
      }
      .ev-callout__secondary {
        font-size: 0.84rem;
        color: color-mix(in srgb, var(--text-secondary) 80%, transparent);
      }
      :root[data-theme="dark"] .feedback-banner {
        border-color: color-mix(in srgb, var(--outline) 60%, transparent);
        background: color-mix(in srgb, var(--surface-2) 94%, var(--surface-3) 6%);
      }
      .feedback-detail {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: calc(var(--min-tap) - 8px);
        height: calc(var(--min-tap) - 8px);
        padding: 0;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--outline) 55%, transparent);
        background: color-mix(in srgb, var(--surface-1) 94%, transparent);
        color: color-mix(in srgb, var(--text-secondary) 82%, transparent);
        transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        align-self: flex-start;
        margin-left: auto;
        margin-top: 2px;
        line-height: 0;
      }
      .feedback-detail__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        transition: transform 0.2s ease;
      }
      .feedback-detail__icon svg {
        width: 100%;
        height: 100%;
      }
      .feedback-detail:hover {
        background: var(--ghost-hover);
        color: var(--text-primary);
        border-color: color-mix(in srgb, var(--outline) 40%, transparent);
      }
      .feedback-detail:hover .feedback-detail__icon { transform: scale(1.05); }
      .feedback-detail:focus-visible { outline: var(--focus-ring) solid var(--focus-color); outline-offset: 2px; }
      #panel-play .panel-soft {
        display: flex;
        flex-direction: column;
        gap: calc(var(--space-1) * 0.6);
      }
      #panel-play .panel-soft > * {
        margin: 0;
      }
      .info-card {
        display: flex;
        flex-direction: column;
        gap: calc(var(--space-1) * 0.75);
        padding: calc(var(--space-2) * 0.9) var(--space-2);
        border: 1px solid color-mix(in srgb, var(--outline) 78%, transparent);
        border-radius: var(--radius-md);
        background: color-mix(in srgb, var(--surface-1) 94%, white 6%);
        color: var(--text-primary);
        box-shadow: 0 12px 22px -26px rgba(15, 23, 42, 0.35);
        position: relative;
      }
      :root[data-theme="dark"] .info-card {
        background: color-mix(in srgb, var(--surface-2) 88%, var(--surface-3) 12%);
        border-color: color-mix(in srgb, var(--outline) 68%, transparent);
        box-shadow: none;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      .info-row {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .info-label {
        font-size: 0.64rem;
        font-weight: 650;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-tertiary);
        min-width: 3rem;
      }
      .info-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 1.12rem;
        font-weight: 650;
        color: var(--text-primary);
        flex: 0 0 auto;
        min-width: 0;
        align-items: center;
        justify-content: flex-start;
      }
      .info-cards .card {
        margin: 0;
      }
      #hand,
      #board {
        flex-wrap: nowrap;
        align-items: center;
        gap: clamp(6px, 1.1vw, 14px);
        padding: var(--card-row-pad-y) var(--card-row-pad-x);
      }
      #hand {
        padding-left: calc(var(--card-row-pad-x) + var(--card-hand-offset));
      }
      #board {
        overflow-x: auto;
        overflow-y: visible;
        scrollbar-width: thin;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
        scroll-padding-left: var(--card-row-pad-x);
        scroll-padding-right: var(--card-row-pad-x);
        padding-left: calc(var(--card-row-pad-x) + var(--card-hand-offset));
      }
      #board::-webkit-scrollbar {
        height: 4px;
      }
      #board::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--text-secondary) 35%, transparent);
        border-radius: 999px;
      }
      @media (max-width: 480px) {
        .info-row {
          gap: 6px;
          align-items: center;
        }
        .info-label {
          font-size: 0.66rem;
          letter-spacing: 0.08em;
          min-width: 2.35rem;
        }
        .info-cards {
          gap: 4px;
          flex: 1 1 auto;
          justify-content: flex-start;
        }
        #hand,
        #board {
          gap: 4px;
          padding: calc(var(--card-row-pad-y) * 0.85) calc(var(--card-row-pad-x) * 0.9);
        }
        #hand {
          padding-left: calc((var(--card-row-pad-x) * 0.9) + var(--card-hand-offset));
        }
        #hand .card,
        #board .card {
          padding: 0.36rem 0.58rem;
          font-size: 1.06rem;
        }
        #hand .poker-card,
        #board .poker-card {
          width: clamp(36px, 6.4vw, 50px);
          height: clamp(48px, 8.6vw, 60px);
          flex: 0 0 clamp(36px, 6.4vw, 50px);
        }
      }
      .feedback-drawer {
        position: fixed;
        inset: 0;
        background: rgba(11, 15, 20, 0.55);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 2rem clamp(1rem, 6vw, 2.5rem);
        z-index: 70;
      }
      :root[data-theme="light"] .feedback-drawer {
        background: rgba(15, 23, 42, 0.35);
      }
      .feedback-drawer.hidden {
        display: none;
      }
      .drawer-content {
        width: min(480px, 100%);
        background: var(--surface-3);
        border-radius: 20px;
        padding: 20px;
        box-shadow: var(--shadow-soft);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .drawer-header h2 {
        font-size: 1rem;
        color: var(--text-primary);
        margin: 0;
      }
      .drawer-close {
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 1.1rem;
        width: 32px;
        height: 32px;
        border-radius: 50%;
      }
      .drawer-close:hover {
        background: var(--ghost-hover);
      }
      .drawer-close:focus-visible { outline: var(--focus-ring) solid var(--focus-color); outline-offset: 2px; }
      .drawer-body {
        display: grid;
        gap: 12px;
        font-size: 0.92rem;
        color: var(--text-secondary);
      }
      .drawer-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 12px 0;
      }
      .drawer-col {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .drawer-value {
        font-size: 1.02rem;
        color: var(--text-primary);
        font-weight: 600;
      }
      .drawer-ev {
        font-weight: 600;
        color: var(--text-secondary);
      }
      .drawer-sub {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: -6px;
      }
      .drawer-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.72rem;
        font-weight: 650;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: color-mix(in srgb, var(--action-accent-bg) 70%, transparent);
        color: var(--action-accent-text);
        border: 1px solid var(--action-accent-border);
      }
      .drawer-chip--best {
        background: color-mix(in srgb, var(--action-accent-bg) 70%, transparent);
        color: var(--action-accent-text);
        border: 1px solid var(--action-accent-border);
      }
      .drawer-chip--chosen {
        background: color-mix(in srgb, var(--action-accent-bg) 70%, transparent);
        color: var(--action-accent-text);
        border: 1px solid var(--action-accent-border);
      }
      .drawer-chip--alt {
        background: color-mix(in srgb, var(--muted-bg) 70%, transparent);
        color: var(--text-secondary);
        border: 1px solid color-mix(in srgb, var(--muted-border) 80%, transparent);
      }

      .density-compact .page-section {
        padding-block: 8px;
      }
      .density-compact .section-heading {
        margin-block-end: 6px;
      }
      .density-compact .stack > :not([hidden]) ~ :not([hidden]) {
        margin-top: 8px;
      }
      .density-compact .subtext,
      .density-compact .meta-row {
        font-size: 0.95rem;
        line-height: 1.3;
      }
      .density-compact .hand-row,
      .density-compact .board-row {
        gap: 6px;
      }
      .density-compact .poker-card {
        width: clamp(36px, 6.0vw, 48px);
        height: clamp(48px, 8.2vw, 60px);
        flex: 0 0 clamp(36px, 6.0vw, 48px);
        font-size: clamp(1.22rem, 3.3vw, 1.48rem);
        padding: 0.34rem 0.58rem;
      }
      .density-compact .action-area {
        gap: 6px;
        padding: 8px 8px 6px;
      }
      .density-compact .action-main {
        gap: 8px;
      }
      .density-compact .action-button {
        padding: 8px 10px;
        font-size: 0.92rem;
      }
      .density-compact .action-button .action-meta {
        font-size: 0.74rem;
      }
      .density-compact .action-sizes {
        gap: 8px;
        min-height: calc(var(--min-tap) - 12px);
      }
      .density-compact .size-chip {
        padding: 8px 0;
        font-size: 0.74rem;
      }
      .density-compact .bet-group {
        gap: 6px;
      }
      .density-compact .bet-group__label {
        font-size: 0.68rem;
      }
      .density-compact .status-bar {
        min-height: 40px;
      }
      @media (prefers-reduced-motion: reduce) {
        #progress-bar { transition: none; animation: none; }
      }
      @media (max-width: 640px) {
        header { position: sticky; top: 0; }
        #action-area { position: relative; }
      }
    </style>
  </head>
  <body>
    <div id="progress-bar" aria-hidden="true"></div>
    <header class="app-header">
      <div class="app-header__inner">
        <div class="top-bar">
          <div class="brand">
            <span aria-hidden="true" class="brand-mark"></span>
            <h1 class="wordmark"><span class="lead">GTO</span> <span class="trail">Trainer</span></h1>
          </div>
          <div class="header-actions">
            <div class="theme-control">
              <button id="theme-toggle" class="theme-toggle" type="button" aria-haspopup="menu" aria-expanded="false" aria-controls="theme-menu" aria-label="Change appearance" title="Change appearance" data-mode="light" data-open="false">
                <span class="theme-toggle__icon-shell" aria-hidden="true">
                  <span class="theme-icon theme-icon--sun">
                    <svg viewBox="0 0 24 24" role="presentation">
                      <circle cx="12" cy="12" r="4.25" fill="none" stroke="currentColor" stroke-width="1.6" />
                      <path d="M12 2.6v2.8M12 18.6v2.8M4.8 4.8l2 2M17.2 17.2l2 2M2.6 12h2.8M18.6 12h2.8M4.8 19.2l2-2M17.2 6.8l2-2" fill="none" stroke="currentColor" stroke-width="1.6" />
                    </svg>
                  </span>
                  <span class="theme-icon theme-icon--moon">
                    <svg viewBox="0 0 24 24" role="presentation">
                      <path d="M16.6 3.4a7.2 7.2 0 1 0 5.2 11.5 5.8 5.8 0 0 1-5.2-11.5z" fill="currentColor" />
                      <path d="M14 4.3a6.2 6.2 0 1 0 6 10.8" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.5" />
                    </svg>
                  </span>
                </span>
                <span class="theme-toggle__chevron" aria-hidden="true">
                  <svg viewBox="0 0 12 8" role="presentation">
                    <path d="M2 2.5 6 5.5 10 2.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </span>
              </button>
              <div id="theme-menu" class="theme-menu" role="menu" aria-label="Appearance" hidden>
                <button type="button" class="theme-menu__item" data-theme-choice="system" role="menuitemradio" aria-checked="false">
                  <span class="theme-menu__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="presentation">
                      <path d="M12 19.25a7.25 7.25 0 1 1 0-14.5" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" />
                      <path d="M12 4.75a7.25 7.25 0 0 1 0 14.5" fill="currentColor" opacity="0.2" />
                    </svg>
                  </span>
                  <span class="theme-menu__label">Follow System</span>
                  <span class="theme-menu__check" aria-hidden="true">
                    <svg viewBox="0 0 16 16" role="presentation">
                      <path d="M3.2 8.2l2.6 2.9 6-6.2" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </span>
                </button>
                <button type="button" class="theme-menu__item" data-theme-choice="light" role="menuitemradio" aria-checked="false">
                  <span class="theme-menu__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="presentation">
                      <circle cx="12" cy="12" r="5" fill="currentColor" />
                      <path d="M12 2.5v3M12 18.5v3M4.5 12h-3M22.5 12h-3M5.8 5.8l-2-2M20.2 20.2l-2-2M5.8 18.2l-2 2M20.2 3.8l-2 2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </span>
                  <span class="theme-menu__label">Light</span>
                  <span class="theme-menu__check" aria-hidden="true">
                    <svg viewBox="0 0 16 16" role="presentation">
                      <path d="M3.2 8.2l2.6 2.9 6-6.2" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </span>
                </button>
                <button type="button" class="theme-menu__item" data-theme-choice="dark" role="menuitemradio" aria-checked="false">
                  <span class="theme-menu__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="presentation">
                      <path d="M16.6 3.4a7.2 7.2 0 1 0 5.2 11.5 5.8 5.8 0 0 1-5.2-11.5z" fill="currentColor" />
                      <path d="M14 4.3a6.2 6.2 0 1 0 6 10.8" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.5" />
                    </svg>
                  </span>
                  <span class="theme-menu__label">Dark</span>
                  <span class="theme-menu__check" aria-hidden="true">
                    <svg viewBox="0 0 16 16" role="presentation">
                      <path d="M3.2 8.2l2.6 2.9 6-6.2" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div id="status-bar" class="status-bar" aria-live="polite">
          <div id="status-compact" class="status-compact" role="text">
            <span id="header-status" class="status-compact__text">Ready</span>
          </div>
        </div>
      </div>
    </header>

    <main class="screen max-w-2xl min-h-[720px] mx-auto p-4 pb-[calc(8rem+var(--safe-bottom))]">
      <section id="panel-start" class="page-section space-y-4">
        <div class="rounded-lg panel-box panel-soft p-6">
          <h2 class="font-semibold mb-4 text-[clamp(1.25rem,2vw,1.45rem)] text-primary">Start a Session</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" role="group" aria-labelledby="start-session-fields">
            <p id="start-session-fields" class="sr-only">Session configuration</p>
            <div class="field-group" data-field-group="inp-hands">
              <label class="field-label" for="inp-hands">Hands</label>
              <div class="field-shell">
                <input id="inp-hands" type="number" min="1" value="3" data-default="3" placeholder="e.g., 3" class="w-full" inputmode="numeric" aria-describedby="helper-hands inp-hands-error" />
              </div>
              <p id="helper-hands" class="field-helper">Choose how many scenarios play back-to-back.</p>
              <p id="inp-hands-error" class="field-error-message" role="status" aria-live="polite" hidden></p>
            </div>
            <div class="field-group" data-field-group="inp-mc">
              <label class="field-label" for="inp-mc">Depth</label>
              <div class="field-shell">
                <input id="inp-mc" type="number" min="40" step="10" value="120" data-default="120" placeholder="e.g., 120" class="w-full" inputmode="numeric" aria-describedby="helper-depth inp-mc-error" />
              </div>
              <p id="helper-depth" class="field-helper long">More trials yield tighter EV estimates but extend the compute per hand.</p>
              <p id="inp-mc-error" class="field-error-message" role="status" aria-live="polite" hidden></p>
            </div>
          </div>
          <button id="btn-start" class="mt-6 w-full rounded-xl px-4 py-2.5 font-semibold transition-transform duration-200 hover:-translate-y-[1px] focus-visible:outline-none btn btn-primary">Start</button>
        </div>
      </section>

      <section id="panel-play" class="page-section hidden">
        <div class="rounded-lg panel-box panel-soft">
          <div id="card-summary" class="info-card">
            <div class="info-row">
              <span class="info-label">Hand</span>
              <div id="hand" class="info-cards"></div>
            </div>
            <div class="info-row">
              <span class="info-label">Board</span>
              <div id="board" class="info-cards"></div>
            </div>
          </div>
          <div id="status-line" class="status-line" role="status" aria-live="polite"></div>
          <div id="action-area" class="action-area is-hidden" role="group" aria-label="Available actions"></div>
        </div>

        <div id="feedback-banner" class="feedback-banner hidden" role="status" aria-live="polite">
          <div class="feedback-text">
            <div id="feedback-recommendation" class="feedback-line"></div>
            <div id="feedback-choice" class="feedback-line hidden"></div>
            <div id="feedback-resolution" class="feedback-line feedback-resolution hidden"></div>
          </div>
          <button type="button" id="feedback-detail" class="feedback-detail" aria-label="View detailed reasoning">
            <span class="feedback-detail__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="9" />
                <line x1="12" y1="11" x2="12" y2="16" />
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor" stroke="none" />
              </svg>
            </span>
          </button>
        </div>

        <div id="primary-controls" class="primary-cta">
          <button id="btn-summary" class="hidden btn btn-primary primary-cta__button">
            <span>View summary</span>
            <span class="primary-cta__chevron" aria-hidden="true"></span>
          </button>
        </div>
        <div id="secondary-controls" class="session-secondary-actions">
          <button id="btn-end" class="session-secondary-link" type="button">
            End session
          </button>
        </div>
      </section>

      <section id="panel-summary" class="summary-page hidden">
        <header class="summary-page__header">
          <button id="btn-summary-back" class="summary-page__back" type="button" aria-label="Back to training">
            <span aria-hidden="true"></span>
          </button>
          <h1 class="summary-page__title">Session summary</h1>
        </header>
        <div class="summary-page__body">
          <div class="summary-hero">
            <div class="summary-hero__metric">
              <span class="summary-hero__label">Score</span>
              <span class="summary-hero__value" data-summary-hero-score data-summary-score></span>
            </div>
            <div class="summary-hero__metric">
              <span class="summary-hero__label">EV</span>
              <span class="summary-hero__value" data-summary-hero-ev></span>
            </div>
            <div class="summary-hero__metric">
              <span class="summary-hero__label">Accuracy</span>
              <span class="summary-hero__value" data-summary-hero-accuracy></span>
            </div>
          </div>

          <section class="summary-section" id="summary-key-outcomes">
            <h2 class="summary-section__title">Key outcomes</h2>
            <div class="summary-card summary-card--ev">
              <div class="summary-card__label">Total EV delta</div>
              <div class="summary-card__value" id="summary-ev-delta"></div>
              <div class="summary-card__meta" id="summary-ev-meta"></div>
            </div>
          </section>

          <section class="summary-section" id="summary-history">
            <h2 class="summary-section__title">Hand list &amp; mistakes</h2>
            <div class="summary-card summary-card--history" id="summary-history-card">
              <div class="summary-list" id="summary-history-list"></div>
            </div>
          </section>
        </div>
        <div class="summary-page__footer">
          <button id="btn-new" class="summary-primary btn btn-primary">New session</button>
        </div>
      </section>
    </main>

    <div id="feedback-drawer" class="feedback-drawer hidden" role="dialog" aria-modal="false" aria-labelledby="feedback-drawer-title">
      <div class="drawer-content">
        <div class="drawer-header">
          <h2 id="feedback-drawer-title">EV breakdown</h2>
          <button type="button" id="feedback-drawer-close" class="drawer-close" aria-label="Close"></button>
        </div>
        <div id="feedback-drawer-body" class="drawer-body"></div>
      </div>
    </div>

    <div id="action-announcer" class="sr-only" aria-live="polite"></div>

    <script>

      const ThemeController = (() => {
        const STORAGE_KEY = 'gtotrainer.theme';
        const DEFAULT = 'system';
        const SUPPORTED = new Set(['light', 'dark', 'system']);
        const listeners = new Set();
        const root = document.documentElement;
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        const systemMedia = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
        let active = DEFAULT;
        let applied = 'light';

        const readStored = () => {
          try {
            const value = localStorage.getItem(STORAGE_KEY);
            return value && SUPPORTED.has(value) ? value : null;
          } catch (error) {
            return null;
          }
        };

        const writeStored = (value) => {
          try {
            if (!value) {
              localStorage.removeItem(STORAGE_KEY);
              return;
            }
            localStorage.setItem(STORAGE_KEY, value);
          } catch (error) {
            /* ignore storage errors */
          }
        };

        const notify = (value) => {
          for (const listener of listeners) {
            try {
              listener(value);
            } catch (error) {
              console.error('Theme listener failed', error);
            }
          }
        };

        const resolveSystemTheme = () => {
          if (!systemMedia) return 'light';
          return systemMedia.matches ? 'dark' : 'light';
        };

        const applyDataTheme = (theme) => {
          if (theme === 'light') {
            delete root.dataset.theme;
          } else {
            root.dataset.theme = theme;
          }

          if (themeMeta) {
            const bg = getComputedStyle(root).getPropertyValue('--bg').trim();
            if (bg) {
              themeMeta.setAttribute('content', bg);
            }
          }
        };

        const apply = (value, { persist = false } = {}) => {
          const nextMode = SUPPORTED.has(value) ? value : DEFAULT;
          active = nextMode;
          const concrete = nextMode === 'system' ? resolveSystemTheme() : nextMode;
          applyDataTheme(concrete);
          applied = concrete;
          if (persist) {
            writeStored(nextMode);
          }
          notify(nextMode);
          return nextMode;
        };

        const set = (value, options) => apply(value, { persist: true, ...(options || {}) });
        const preview = (value, options) => apply(value, { persist: false, ...(options || {}) });
        const get = () => active;
        const effective = () => applied;
        const onChange = (fn) => {
          if (typeof fn !== 'function') {
            return () => undefined;
          }
          listeners.add(fn);
          return () => listeners.delete(fn);
        };

        const init = () => {
          const preset = root.dataset.theme;
          const stored = readStored();
          const initial = SUPPORTED.has(stored)
            ? stored
            : SUPPORTED.has(preset) ? preset : DEFAULT;
          apply(initial, { persist: false });
        };

        const handleSystemChange = () => {
          if (active === 'system') {
            apply(active, { persist: false });
          }
        };

        if (systemMedia && typeof systemMedia.addEventListener === 'function') {
          systemMedia.addEventListener('change', handleSystemChange);
        } else if (systemMedia && typeof systemMedia.addListener === 'function') {
          systemMedia.addListener(handleSystemChange);
        }

        init();

        return { get, set, preview, onChange, supported: () => Array.from(SUPPORTED), effective };
      })();

      window.GTOTheme = ThemeController;

      const $ = (sel) => document.querySelector(sel);
      const fmt = (value, maxDecimals = 2) => {
        const num = Number(value);
        if (!Number.isFinite(num)) return '0';
        const fixed = num.toFixed(maxDecimals);
        if (!fixed.includes('.')) return fixed;
        let trimmed = fixed.replace(/0+$/, '');
        if(trimmed === '' || trimmed === '.') return '0';
        if(trimmed.endsWith('.')) trimmed = trimmed.slice(0, -1);
        return trimmed;
      };
      const normalizePercent = (text) => {
        if(!text) return text;
        return text.replace(/(\d+)(?:\.0+)%/g, '$1%');
      };
      const progressBar = document.getElementById('progress-bar');
      let inflight = 0;
      let hideProgressTimer = null;
      let sid = null;
      let pending = false;
      let answered = 0;
      let startBusy = false;
      let pendingSummary = null;
      const screen = document.querySelector('main.screen');
      const headerStatus = $('#header-status');
      const themeToggle = $('#theme-toggle');
      const themeMenu = $('#theme-menu');
      const feedbackBanner = $('#feedback-banner');
      const feedbackRecommendation = $('#feedback-recommendation');
      const feedbackChoice = $('#feedback-choice');
      const feedbackResolution = $('#feedback-resolution');
      const feedbackDetailBtn = $('#feedback-detail');
      const feedbackDrawer = $('#feedback-drawer');
      const feedbackDrawerBody = $('#feedback-drawer-body');
      const feedbackDrawerClose = $('#feedback-drawer-close');
      const actionArea = $('#action-area');
      const statusLineEl = $('#status-line');
      const startBtn = $('#btn-start');
      const summaryBtn = $('#btn-summary');
      const endBtn = $('#btn-end');
      const secondaryControls = document.getElementById('secondary-controls');
      const summaryBackBtn = $('#btn-summary-back');
      const newBtn = $('#btn-new');
      const summaryHeroScore = document.querySelector('[data-summary-hero-score]');
      const summaryHeroEv = document.querySelector('[data-summary-hero-ev]');
      const summaryHeroAccuracy = document.querySelector('[data-summary-hero-accuracy]');
      const summaryEvDeltaEl = document.getElementById('summary-ev-delta');
      const summaryEvMetaEl = document.getElementById('summary-ev-meta');
      const summaryHistoryList = document.getElementById('summary-history-list');
      const actionAnnouncer = $('#action-announcer');
      let lastFeedback = null;
      let lastActionSignature = '';
      let selectedMainAction = null;
      let selectedRaiseIndex = null;
      let betGroupCounter = 0;
      let pendingNextPayload = null;
      let nextHandButton = null;
      let totalEvLost = 0;
      let correctDecisions = 0;
      let sessionHands = 0;
      let activeNode = null;
      let jamConfirmTimeout = null;
      let jamConfirmButton = null;
      let jamConfirmLabel = '';
      let jamConfirmMarkup = '';

      const escapeHtml = (text) => String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");

      const triggerHaptic = (pattern = 'selection') => {
        try {
          const vib = window.navigator && typeof window.navigator.vibrate === 'function'
            ? window.navigator.vibrate.bind(window.navigator)
            : null;
          if(!vib) return;
          vib(pattern === 'impact' ? 20 : 10);
        } catch (error) {
          /* haptics optional */
        }
      };

      const SUIT_CLASS = {
        S: 's', H: 'h', D: 'd', C: 'c',
        '': 's', '': 'h', '': 'd', '': 'c',
      };
      const SUIT_EMOJI = {
        S: '', H: '', D: '', C: '',
        '': '', '': '', '': '', '': '',
      };
      const CARD_CODE_PATTERN = /^(10|[2-9TJQKA])\s*([scdh])/i;
      const CARD_SYMBOL_PATTERN = /^(10|[2-9TJQKA])\s*([])\uFE0F?/i;

      function suit(sym){
        const token = (sym || '').toString().trim();
        if(!token) return 's';
        const upper = token.toUpperCase();
        const key = upper[0];
        return SUIT_CLASS[key] || 's';
      }
      function suitIcon(sym){
        const token = (sym || '').toString().trim();
        if(!token) return '';
        const upper = token.toUpperCase();
        const key = upper[0];
        return SUIT_EMOJI[key] || '';
      }
      function matchInlineCard(input){
        if(!input) return null;
        const codeMatch = input.match(CARD_CODE_PATTERN);
        if(codeMatch){
          return {
            rank: codeMatch[1].toUpperCase(),
            suit: codeMatch[2],
            length: codeMatch[0].length,
          };
        }
        const symbolMatch = input.match(CARD_SYMBOL_PATTERN);
        if(symbolMatch){
          return {
            rank: symbolMatch[1].toUpperCase(),
            suit: symbolMatch[2],
            length: symbolMatch[0].length,
          };
        }
        return null;
      }
      function parseCardToken(raw){
        const token = (raw || '').toString().trim();
        if(!token) return null;
        const match = matchInlineCard(token);
        if(match && match.length === token.length){
          return { rank: match.rank, suit: match.suit };
        }
        const codepoints = Array.from(token);
        if(codepoints.length < 2) return null;
        const trySuit = (suitChar, rankParts) => {
          if(!suitChar) return null;
          const key = suitChar.toString().toUpperCase()[0];
          if(!SUIT_CLASS[key]) return null;
          const rank = rankParts.join('').trim();
          if(!rank) return null;
          const normalizedRank = rank.toUpperCase();
          if(!/^(10|[2-9TJQKA])$/i.test(normalizedRank)) return null;
          return { rank: normalizedRank, suit: suitChar };
        };
        const tailSuit = codepoints[codepoints.length - 1];
        const tailRankParts = codepoints.slice(0, -1);
        const direct = trySuit(tailSuit, tailRankParts);
        if(direct) return direct;
        const altSuit = codepoints[codepoints.length - 2];
        const altRankParts = codepoints.slice(0, -2);
        return trySuit(altSuit, altRankParts);
      }
      function withCardMarkup(text){
        if(text == null) return '';
        if(typeof text !== 'string') text = String(text);
        const source = text;
        let result = '';
        let index = 0;
        let buffer = '';
        let previousWasCard = false;

        const flushBuffer = () => {
          if(buffer){
            result += escapeHtml(buffer);
            buffer = '';
          }
        };

        while(index < source.length){
          const slice = source.slice(index);
          const match = matchInlineCard(slice);
          if(match){
            const before = index > 0 ? source[index - 1] : '';
            const afterIndex = index + match.length;
            const after = afterIndex < source.length ? source[afterIndex] : '';
            const nextCard = matchInlineCard(source.slice(afterIndex));
            const hasSafePrefix = !before || !/[0-9A-Za-z]/.test(before) || previousWasCard;
            const hasSafeSuffix = !after || !/[0-9A-Za-z]/.test(after) || !!nextCard;
            if(hasSafePrefix && hasSafeSuffix){
              flushBuffer();
              const suitKey = suit(match.suit);
              const suitChar = escapeHtml(suitIcon(match.suit));
              const rankText = escapeHtml(match.rank);
              result += `<span class="inline-card inline-card--${suitKey}"><span class="inline-card__rank">${rankText}<span class="inline-card__suit">${suitChar}</span></span></span>`;
              index += match.length;
              previousWasCard = true;
              continue;
            }
          }
          buffer += source[index];
          index += 1;
          previousWasCard = false;
        }

        flushBuffer();
        return result;
      }
      function setTextWithCards(el, value){
        if(!el) return;
        el.innerHTML = value == null ? '' : withCardMarkup(value);
      }
      function renderCards(cards){
        if(!cards || !cards.length) return '';
        return cards
          .map((raw) => {
            const parsed = parseCardToken(raw);
            if(!parsed) return '';
            const { rank, suit: suitCode } = parsed;
            const css = suit(suitCode);
            return `<span class="card poker-card ${css}"><span class="card__rank">${rank}</span><span class="card__suit">${suitIcon(suitCode)}</span></span>`;
          })
          .filter(Boolean)
          .join(' ');
      }

      const clearNextHandQueue = () => {
        pendingNextPayload = null;
        if(nextHandButton){
          nextHandButton.removeEventListener('click', handleNextHandClick);
          nextHandButton = null;
        }
        if(jamConfirmTimeout){
          clearTimeout(jamConfirmTimeout);
          jamConfirmTimeout = null;
        }
        jamConfirmButton = null;
        jamConfirmLabel = '';
        if(actionArea){
          actionArea.classList.remove('is-disabled');
          delete actionArea.dataset.pending;
          actionArea.innerHTML = '';
        }
        jamConfirmMarkup = '';
      };

      const advanceToNextHand = async () => {
        if(!pendingNextPayload) return;
        const payload = pendingNextPayload;
        clearNextHandQueue();
        await renderNodePayload(payload, { clearFeedback: true });
      };

      const handleNextHandClick = (event) => {
        event.preventDefault();
        advanceToNextHand();
      };

      const queueNextHand = (payload) => {
        clearNextHandQueue();
        pendingNextPayload = payload;
        if(!actionArea) return;
        actionArea.classList.remove('is-hidden');
        actionArea.classList.remove('is-disabled');
        delete actionArea.dataset.pending;
        const container = document.createElement('div');
        container.className = 'action-main next-hand-main';
        const slot = document.createElement('div');
        slot.className = 'action-slot';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'action-button action-neutral next-hand-btn';
        btn.textContent = 'Next hand';
        slot.appendChild(btn);
        container.appendChild(slot);
        actionArea.innerHTML = '';
        actionArea.appendChild(container);
        nextHandButton = btn;
        btn.addEventListener('click', handleNextHandClick);
        window.requestAnimationFrame(() => btn.focus({ preventScroll: true }));
        if(statusLineEl){
          statusLineEl.dataset.active = '';
          renderStatusLine([]);
        } else {
          setStatusMessage('');
        }
      };

      const formatBb = (value) => `${fmt(value, Math.abs(value) < 10 ? 1 : 0)}bb`;
      const formatSignedBb = (value) => {
        if(!Number.isFinite(value) || value === 0){
          return '0bb';
        }
        const sign = value < 0 ? '-' : '+';
        return `${sign}${formatBb(Math.abs(value))}`;
      };

      const renderStatusLine = (items) => {
        if(!statusLineEl) return;
        const list = Array.isArray(items) ? items.filter((item) => item && item.label && item.value) : [];
        const firstValue = list[0]?.value ? String(list[0].value) : '';
        const isSummaryChip =
          list.length === 1 &&
          typeof list[0]?.label === 'string' &&
          list[0].label.toLowerCase() === 'status' &&
          firstValue.toLowerCase().includes('summary');

        statusLineEl.classList.toggle('status-line--summary', isSummaryChip);

        if(isSummaryChip){
          const valueMarkup = withCardMarkup(firstValue);
          statusLineEl.innerHTML = `
            <div class="status-chip">
              <span class="status-chip__icon" aria-hidden="true"></span>
              <span class="status-chip__text">${valueMarkup}</span>
            </div>
          `;
          return;
        }

        statusLineEl.innerHTML = list
          .map((item) => {
            const labelMarkup = withCardMarkup(item.label);
            const valueMarkup = withCardMarkup(item.value);
            return `
            <div class="status-item">
              <span class="status-label">${labelMarkup}</span>
              <span class="status-value">${valueMarkup}</span>
            </div>
          `;
          })
          .join('');
      };

      const setStatusMessage = (message) => {
        if(statusLineEl && (!statusLineEl.dataset.active || statusLineEl.dataset.active !== 'node')){
          renderStatusLine(message ? [{ label: 'Status', value: message }] : []);
          updateHeaderStatus(activeNode, { state: message || 'Ready' });
        } else if(!activeNode){
          updateHeaderStatus(null, { state: message || 'Ready' });
        }
      };

      const THEME_LABELS = {
        system: 'Follow System',
        light: 'Light',
        dark: 'Dark'
      };

      const themeMenuButtons = themeMenu ? Array.from(themeMenu.querySelectorAll('.theme-menu__item')) : [];
      let themeMenuOpen = false;

      const setThemeMenuVisibility = (open, { focusTarget = undefined } = {}) => {
        if(!themeToggle || !themeMenu) return;
        themeMenuOpen = open;
        themeMenu.hidden = !open;
        themeToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        themeToggle.setAttribute('data-open', open ? 'true' : 'false');
        if(open){
          const current = ThemeController.get();
          const targetButton = focusTarget
            || themeMenuButtons.find((btn) => btn.dataset.themeChoice === current)
            || themeMenuButtons[0];
          if(targetButton){
            window.requestAnimationFrame(() => targetButton.focus({ preventScroll: true }));
          }
        } else if(focusTarget !== false){
          window.requestAnimationFrame(() => themeToggle.focus({ preventScroll: true }));
        }
      };

      const syncThemeToggle = (value) => {
        if(!themeToggle) return;
        const mode = value && THEME_LABELS[value] ? value : ThemeController.get();
        const effectiveMode = typeof ThemeController.effective === 'function'
          ? ThemeController.effective()
          : (document.documentElement.dataset.theme === 'dark' ? 'dark' : 'light');
        const baseLabel = THEME_LABELS[mode] || THEME_LABELS.system;
        const descriptor = mode === 'system'
          ? `${baseLabel} (${effectiveMode === 'dark' ? 'Dark' : 'Light'})`
          : baseLabel;
        themeToggle.dataset.mode = effectiveMode;
        themeToggle.setAttribute('data-mode', effectiveMode);
        themeToggle.setAttribute('title', `Appearance: ${descriptor}`);
        themeToggle.setAttribute('aria-label', `Appearance: ${descriptor}`);
        if(themeMenuButtons.length){
          themeMenuButtons.forEach((btn) => {
            const isActive = btn.dataset.themeChoice === mode;
            btn.setAttribute('aria-checked', isActive ? 'true' : 'false');
          });
        }
      };

      const closeThemeMenu = ({ focus = false } = {}) => {
        if(!themeMenuOpen) return;
        setThemeMenuVisibility(false, { focusTarget: focus ? undefined : false });
      };

      if(themeToggle){
        syncThemeToggle(ThemeController.get());
        ThemeController.onChange(syncThemeToggle);

        const handleOutsideClick = (event) => {
          if(!themeMenuOpen) return;
          if(event.target === themeToggle || themeToggle.contains(event.target)) return;
          if(themeMenu && themeMenu.contains(event.target)) return;
          closeThemeMenu();
        };

        document.addEventListener('pointerdown', handleOutsideClick);

        themeToggle.addEventListener('click', (event)=>{
          event.preventDefault();
          if(!themeMenu){
            const next = ThemeController.get() === 'dark' ? 'light' : 'dark';
            ThemeController.set(next);
            return;
          }
          setThemeMenuVisibility(!themeMenuOpen);
        });

        themeToggle.addEventListener('keydown', (event)=>{
          if(!themeMenu) return;
          if(event.key === 'ArrowDown' || event.key === 'ArrowUp'){
            event.preventDefault();
            if(!themeMenuOpen){
              setThemeMenuVisibility(true);
            } else {
              const direction = event.key === 'ArrowDown' ? 1 : -1;
              const currentIndex = themeMenuButtons.findIndex((btn) => btn === document.activeElement);
              const nextIndex = (currentIndex + direction + themeMenuButtons.length) % themeMenuButtons.length;
              const target = themeMenuButtons[nextIndex] || themeMenuButtons[0];
              target?.focus({ preventScroll: true });
            }
          } else if(event.key === 'Enter' || event.key === ' '){
            event.preventDefault();
            setThemeMenuVisibility(!themeMenuOpen);
          } else if(event.key === 'Escape' && themeMenuOpen){
            event.preventDefault();
            closeThemeMenu({ focus: true });
          }
        });

        if(themeMenu){
          themeMenuButtons.forEach((btn) => {
            btn.addEventListener('click', (event)=>{
              event.preventDefault();
              const choice = btn.dataset.themeChoice;
              if(choice && THEME_LABELS[choice]){
                ThemeController.set(choice);
                closeThemeMenu({ focus: true });
              }
            });

            btn.addEventListener('keydown', (event)=>{
              if(event.key === 'Escape'){
                event.preventDefault();
                closeThemeMenu({ focus: true });
              } else if(event.key === 'ArrowDown' || event.key === 'ArrowUp'){
                event.preventDefault();
                const direction = event.key === 'ArrowDown' ? 1 : -1;
                const index = themeMenuButtons.indexOf(btn);
                const nextIndex = (index + direction + themeMenuButtons.length) % themeMenuButtons.length;
                const target = themeMenuButtons[nextIndex];
                target?.focus({ preventScroll: true });
              } else if(event.key === 'Tab'){
                closeThemeMenu({ focus: false });
              }
            });
          });
        }
      }

      const streetLabel = (street) => {
        const value = (street || "").toString();
        if(!value) return "Ready";
        return value.charAt(0).toUpperCase() + value.slice(1);
      };

      const updateHeaderStatus = (node, opts = {}) => {
        if(!headerStatus) return;
        const { state } = opts;
        const segments = [];

        if(node){
          const street = streetLabel(node.street);
          if(street) segments.push(street);
          if(typeof node.hand_no === 'number' && typeof node.total_hands === 'number'){
            segments.push(`Hand ${node.hand_no}/${node.total_hands}`);
            sessionHands = node.total_hands;
          }
          if(typeof node.effective_bb === 'number' && Number.isFinite(node.effective_bb) && node.effective_bb > 0){
            segments.push(`Stk ${formatBb(node.effective_bb)}`);
          }
        } else if(state){
          segments.push(state);
        } else {
          segments.push('Ready');
        }

        const evMagnitude = Math.abs(totalEvLost);
        const evDisplay = totalEvLost > 0 ? `-${formatBb(totalEvLost)}` : `+${formatBb(evMagnitude)}`;
        segments.push(`EV ${evDisplay}`);

        const accPct = answered > 0
          ? Math.round((correctDecisions / Math.max(1, answered)) * 100)
          : null;
        segments.push(`Acc ${accPct !== null ? `${accPct}%` : '--'}`);

        const formatSegment = (segment) => {
          const raw = (segment || '').trim();
          if(!raw) return '';
          const firstSpace = raw.indexOf(' ');
          if(firstSpace === -1){
            return `<span class="status-seg">${withCardMarkup(raw)}</span>`;
          }
          const label = raw.slice(0, firstSpace);
          const value = raw.slice(firstSpace + 1).trim();
          const labelMarkup = withCardMarkup(label);
          const valueMarkup = withCardMarkup(value);
          return `<span class="status-seg"><strong>${labelMarkup}</strong><span>${valueMarkup}</span></span>`;
        };

        const markup = segments
          .map(formatSegment)
          .filter(Boolean)
          .join('<span class="status-dot"></span>');

        headerStatus.innerHTML = markup || '<span class="status-seg">Ready</span>';
      };

      const formatStatusLine = (node, descriptor) => {
        if(!node){
          return [{ label: 'Status', value: descriptor || 'Ready for a new hand' }];
        }
        const context = node?.context || {};
        const facing = (context?.facing || '').toString().toLowerCase();
        const betSize = typeof node?.context?.bet === 'number' ? formatBb(node.context.bet) : '';
        const openSize = typeof node?.context?.open_size === 'number' ? formatBb(node.context.open_size) : '';
        const rivalSeat = (context?.rival_seat || context?.rivalSeat || '').toString().toUpperCase();
        const seatToken = rivalSeat ? `(${rivalSeat})` : '';
        let actionText = '';
        if(facing === 'check'){
          actionText = 'checks';
        } else if(facing === 'oop-check'){
          actionText = 'checks to hero';
        } else if(facing === 'bet'){
          actionText = betSize ? `bets ${betSize}` : 'bets';
        } else if(openSize){
          actionText = `opened ${openSize}`;
        } else if(descriptor){
          const cleaned = descriptor.replace(/Rival\s+/i, '').replace(/\s+/g, ' ').trim().replace(/[.]+$/g, '');
          actionText = cleaned || 'to act';
        } else {
          actionText = 'to act';
        }
        const value = `${seatToken ? seatToken + ' ' : ''}${actionText}`.trim();
        return [{ label: 'Rival', value }];
      };


      const parseActionLabel = (label) => {
        if(!label) return { primary: "Action", meta: "" };
        let primary = label.trim();
        let meta = "";
        const openIdx = primary.indexOf("(");
        if(openIdx >= 0){
          const closeIdx = primary.lastIndexOf(")");
          if(closeIdx > openIdx){
            meta = primary.slice(openIdx + 1, closeIdx).trim();
            primary = primary.slice(0, openIdx).trim();
          }
        }
        if(!meta){
          const bbMatch = primary.match(/(\d+(?:\.\d+)?)\s*bb$/i);
          if(bbMatch && typeof bbMatch.index === "number"){
            meta = `${bbMatch[1]} bb`;
            primary = primary.slice(0, bbMatch.index).trim();
          }
        }
        if(meta && /bb$/i.test(meta) && !/\sbb$/i.test(meta)){
          meta = meta.replace(/bb$/i, " bb");
        }
        if(primary.toLowerCase().startsWith("bet ") && primary.toLowerCase().includes("%")){
          primary = primary.replace(/^bet\s+/i, "").trim();
        }
        if(!primary){
          primary = "Action";
        }
        return { primary: normalizePercent(primary), meta: normalizePercent(meta) };
      };

      const parseDescriptor = (node) => {
        let descriptor = node?.description || "";
        if ((Array.isArray(node?.board_cards) && node.board_cards.length > 0) && descriptor.includes('; ')){
          descriptor = descriptor.split('; ')[1];
        } else if ((Array.isArray(node?.board_cards) && node.board_cards.length > 0) && descriptor.startsWith('Board ')){
          const idx = descriptor.indexOf('. ');
          descriptor = idx >= 0 ? descriptor.slice(idx + 2) : descriptor;
        }
        return descriptor.trim();
      };

      const canonicalAction = (option) => {
        const normalize = (value) => (value || "").toString().toLowerCase();
        if(typeof option === 'string'){
          const lower = normalize(option);
          if(lower.includes('all-in') || lower.includes('jam') || lower.includes('shove')) return 'all-in';
          if(lower.startsWith('fold')) return 'fold';
          if(lower.startsWith('check')) return 'check';
          if(lower.startsWith('call')) return 'call';
          if(lower.startsWith('3-bet') || lower.startsWith('3bet')) return '3bet';
          if(lower.startsWith('bet')) return 'bet';
          if(lower.startsWith('raise')) return 'raise';
          return lower.split(' ')[0];
        }
        const metaAction = normalize(option?.meta?.action);
        if(metaAction){
          if(metaAction === "allin" || metaAction === "jam") return "all-in";
          if(metaAction === "3bet") return "3bet";
          return metaAction;
        }
        const key = normalize(option?.key || option?.label || "");
        if(key.includes("all-in") || key.includes("jam") || key.includes("shove")) return "all-in";
        if(key.startsWith("fold")) return "fold";
        if(key.startsWith("check")) return "check";
        if(key.startsWith("call")) return "call";
        if(key.startsWith("3-bet") || key.startsWith("3bet")) return "3bet";
        if(key.startsWith("bet")) return "bet";
        if(key.startsWith("raise")) return "raise";
        return metaAction || key.split(' ')[0];
      };

      const numericFromOption = (option) => {
        const meta = option?.meta || {};
        const candidates = [meta.bet, meta.raise_to, meta.call_cost];
        for (const value of candidates){
          if(typeof value === "number" && Number.isFinite(value)){
            return value;
          }
        }
        const text = (typeof option === 'string' ? option : option?.label || option?.key || "").toString();
        const match = text.match(/(\d+(?:\.\d+)?)\s*bb/i);
        if(match){
          return parseFloat(match[1]);
        }
        return null;
      };

      const describeOptions = (options) => {
        return (Array.isArray(options) ? options : []).map((option, index) => {
          const label = typeof option === "string" ? option : option?.label || option?.key || `Option ${index + 1}`;
          const { primary, meta } = parseActionLabel(label);
          const action = canonicalAction(option);
          const numeric = numericFromOption(option);
          const disabled = Boolean(option && typeof option === 'object' && (option.disabled || option.enabled === false));
          return { index, option, label, primary, meta, action, numeric, disabled };
        });
      };

      const chipLabel = (descriptor) => {
        if(!descriptor) return '';
        if(descriptor.meta){
          const meta = normalizePercent(descriptor.meta);
          if(/%/.test(meta)){
            return meta.replace(/\s*pot/i, '').replace(/\s+/g, ' ').trim();
          }
          return meta.replace(/\s+bb$/i, ' bb').trim();
        }
        if(typeof descriptor.numeric === 'number' && Number.isFinite(descriptor.numeric)){
          return `${fmt(descriptor.numeric, descriptor.numeric < 10 ? 1 : 0)}bb`;
        }
        return descriptor.primary;
      };

      const raiseVerb = (descriptor, { isFacingBet }) => {
        if(!descriptor) return isFacingBet ? 'Raise' : 'Bet';
        if(descriptor.action === 'bet') return 'Bet';
        if(descriptor.action === '3bet') return '3-bet';
        if(descriptor.action === 'raise') return isFacingBet ? 'Raise' : 'Bet';
        if(descriptor.action === 'all-in') return 'All-in';
        return descriptor.primary || (isFacingBet ? 'Raise' : 'Bet');
      };

      const formatBetLabel = (descriptor, { isFacingBet, includeSize }) => {
        if(!descriptor){
          return { label: isFacingBet ? 'Raise' : 'Bet', meta: '' };
        }
        const verb = raiseVerb(descriptor, { isFacingBet });
        const numeric = typeof descriptor.numeric === 'number' && Number.isFinite(descriptor.numeric)
          ? `${fmt(descriptor.numeric, descriptor.numeric < 10 ? 1 : 0)}bb`
          : '';
        if(includeSize){
          if(descriptor.meta && /%/.test(descriptor.meta)){
            const cleaned = normalizePercent(descriptor.meta).replace(/\s*pot/i, '').trim();
            return { label: `${verb} ${cleaned}`.trim(), meta: '' };
          }
          if(numeric){
            const needsTo = verb.toLowerCase().includes('bet') ? '' : 'to ';
            return { label: `${verb} ${needsTo}${numeric}`.replace(/\s+/g, ' ').trim(), meta: '' };
          }
        }
        if(descriptor.meta && !/%/.test(descriptor.meta)){
          return { label: verb, meta: descriptor.meta };
        }
        return { label: verb, meta: '' };
      };

      const sortBySizing = (a, b) => {
        const aNum = typeof a?.numeric === 'number' ? a.numeric : null;
        const bNum = typeof b?.numeric === 'number' ? b.numeric : null;
        if(aNum !== null && bNum !== null && Number.isFinite(aNum) && Number.isFinite(bNum)){
          return aNum - bNum;
        }
        return a.index - b.index;
      };

      const renderActions = (options, node) => {
        if(!actionArea) return;
        if(jamConfirmTimeout){
          clearTimeout(jamConfirmTimeout);
          jamConfirmTimeout = null;
        }
        if(jamConfirmButton){
          jamConfirmButton.classList.remove('is-confirm');
          if(jamConfirmMarkup){
            jamConfirmButton.innerHTML = jamConfirmMarkup;
          } else {
            jamConfirmButton.innerHTML = chipMarkup(jamConfirmLabel || 'All-in');
          }
          jamConfirmButton.removeAttribute('aria-label');
          jamConfirmButton.removeAttribute('aria-live');
          jamConfirmButton = null;
        }
        jamConfirmLabel = '';
        jamConfirmMarkup = '';
        if(pending){
          actionArea.dataset.pending = 'true';
        } else {
          delete actionArea.dataset.pending;
        }
        const previousHeight = actionArea.offsetHeight;
        const described = describeOptions(options);
        const signature = described.map((d) => `${d.index}:${d.action}`).join('|');
        if(signature !== lastActionSignature){
          lastActionSignature = signature;
          selectedMainAction = null;
          selectedRaiseIndex = null;
        }
        if(previousHeight > 0){
          actionArea.style.minHeight = `${previousHeight}px`;
        }
        actionArea.innerHTML = '';
        if(described.length === 0){
          actionArea.classList.add('is-hidden');
          actionArea.classList.remove('is-disabled');
          actionArea.style.minHeight = '';
          return;
        }
        actionArea.classList.remove('is-hidden');
        actionArea.classList.remove('is-disabled');

        const foldOpt = described.find((d) => d.action === 'fold');
        const callOpt = described.find((d) => d.action === 'call');
        const checkOpt = described.find((d) => d.action === 'check');
        const jamOpt = described.find((d) => d.action === 'all-in');
        let raiseOpts = described.filter((d) => ['raise', 'bet', '3bet'].includes(d.action) && d !== jamOpt);

        const isFacingBet = typeof node?.context?.bet === 'number' && node.context.bet > 0;
        const passiveOpt = isFacingBet ? (callOpt || checkOpt) : (checkOpt || callOpt);

        const used = new Set([foldOpt, passiveOpt, jamOpt].filter(Boolean));
        if(raiseOpts.length === 0){
          described.forEach((d) => {
            if(!used.has(d) && ['fold', 'call', 'check', 'all-in'].indexOf(d.action) === -1){
              raiseOpts.push(d);
              used.add(d);
            }
          });
        }
        raiseOpts = raiseOpts.filter(Boolean).sort(sortBySizing);
        const primaryRaise = raiseOpts[0] || null;

        const mainRow = document.createElement('div');
        mainRow.className = 'action-main';
        const sizeRow = document.createElement('div');
        sizeRow.className = 'action-sizes';
        let sizeSlot = null;
        let betGroup = null;

        const mainButtons = {};

        const chipMarkup = (label) => {
          const raw = (label || '').trim();
          if(!raw) return '';
          const match = raw.match(/^([0-9]+(?:\.[0-9]+)?)(.*)$/);
          if(!match){
            return escapeHtml(raw);
          }
          const [, value, unit] = match;
          const unitText = unit.trim() || 'bb';
          return `<span class="size-chip__value">${escapeHtml(value)}</span><span class="size-chip__unit">${escapeHtml(unitText)}</span>`;
        };

        const makeLabelMeta = (descriptor, override = {}) => {
          if(!descriptor) return { label: override.fallbackLabel || '', meta: '' };
          const baseLabel = normalizePercent(override.label ?? descriptor.primary);
          const baseMeta = normalizePercent(override.meta ?? descriptor.meta ?? '');
          return { label: baseLabel, meta: baseMeta };
        };

        const appendMainButton = (slotKey, descriptor, variant, override = {}) => {
          if(!descriptor){
            return null;
          }
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = `action-button ${variant}`;
          btn.dataset.slot = slotKey;
          const { label, meta } = makeLabelMeta(descriptor, override);
          const labelEl = document.createElement('span');
          labelEl.className = 'action-label';
          labelEl.textContent = label;
          btn.appendChild(labelEl);
          if(meta){
            const metaEl = document.createElement('span');
            metaEl.className = 'action-meta';
            metaEl.textContent = meta;
            btn.appendChild(metaEl);
          }
          btn.dataset.optionIndex = String(descriptor.index);
          btn.dataset.optionLabel = meta ? `${label} (${meta})` : label;
          mainRow.appendChild(btn);
          mainButtons[slotKey] = btn;
          return btn;
        };

        const refreshMainArming = () => {
          Object.entries(mainButtons).forEach(([key, btn]) => {
            if(!btn) return;
            const shouldArm = key === selectedMainAction;
            btn.classList.toggle('is-armed', shouldArm);
          });
        };

        const ensureRaiseSelection = () => {
          const live = raiseOpts.filter((d) => !d.disabled);
          if(!live.length){
            selectedRaiseIndex = null;
            return null;
          }
          if(typeof selectedRaiseIndex === 'number'){
            const match = live.find((d) => d.index === selectedRaiseIndex);
            if(match) return match;
          }
          selectedRaiseIndex = live[0].index;
          return live[0];
        };

        const activeRaise = () => {
          if(!raiseOpts.length) return null;
          return raiseOpts.find((d) => d.index === selectedRaiseIndex) || null;
        };

        const passiveButton = appendMainButton('passive', passiveOpt, 'action-neutral', {
          label: passiveOpt ? (passiveOpt.action === 'call' ? 'Call' : passiveOpt.action === 'check' ? 'Check' : 'Check/Call') : 'Check/Call',
          meta: '',
        });

        if(passiveButton && passiveOpt){
          passiveButton.addEventListener('click', (event) => {
            event.preventDefault();
            selectedMainAction = null;
            refreshMainArming();
            choose(passiveOpt.index);
          });
        }

        if(raiseOpts.length || jamOpt){
          sizeRow.setAttribute('role', 'group');
          sizeRow.setAttribute('aria-label', isFacingBet ? 'Raise sizes' : 'Bet sizes');
          betGroup = document.createElement('div');
          betGroup.className = 'bet-group';
          betGroup.setAttribute('role', 'group');
          const betLabel = document.createElement('div');
          betLabel.className = 'bet-group__label';
          betLabel.textContent = isFacingBet ? 'Raise' : 'Bet';
          const labelId = `bet-label-${++betGroupCounter}`;
          betLabel.id = labelId;
          betGroup.setAttribute('aria-labelledby', labelId);
          betGroup.appendChild(betLabel);
          sizeSlot = document.createElement('div');
          sizeSlot.className = 'action-slot';
          sizeSlot.appendChild(betGroup);
          mainRow.appendChild(sizeSlot);
        }

        if(raiseOpts.length && betGroup){
          betGroup.appendChild(sizeRow);
          const ensured = ensureRaiseSelection();
          raiseOpts.forEach((descriptor) => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'size-chip';
            chip.dataset.optionIndex = String(descriptor.index);
            chip.dataset.optionLabel = `${raiseVerb(descriptor, { isFacingBet })} ${chipLabel(descriptor)}`;
            chip.innerHTML = chipMarkup(chipLabel(descriptor));
            if(descriptor.disabled){
              chip.disabled = true;
            }
            if(ensured && ensured.index === descriptor.index){
              chip.classList.add('is-selected');
            }
            chip.addEventListener('click', (event) => {
              event.preventDefault();
              if(chip.disabled || pending) return;
              selectedRaiseIndex = descriptor.index;
              ensureRaiseSelection();
              Array.from(sizeRow.querySelectorAll('.size-chip')).forEach((nodeChip) => {
                nodeChip.classList.toggle('is-selected', nodeChip === chip);
              });
              window.requestAnimationFrame(() => {
                if(pending) return;
                choose(descriptor.index);
              });
            });
            sizeRow.appendChild(chip);
          });
        }

        if(jamOpt && betGroup){
          const jamRow = document.createElement('div');
          jamRow.className = 'bet-group__jam';
          const jamButton = document.createElement('button');
          jamButton.type = 'button';
          jamButton.className = 'size-chip size-chip--jam';
          const jamLabelMeta = formatBetLabel(jamOpt, { isFacingBet, includeSize: true });
          const jamLabelText = jamLabelMeta.label || 'All-in';
          jamButton.innerHTML = chipMarkup(jamLabelText);
          jamButton.dataset.optionIndex = String(jamOpt.index);
          jamButton.dataset.optionLabel = jamLabelMeta.meta
            ? `${jamLabelText} (${jamLabelMeta.meta})`
            : jamLabelText;
          if(jamOpt.disabled){
            jamButton.disabled = true;
          }
          const resetJamConfirm = () => {
            if(jamConfirmTimeout){
              clearTimeout(jamConfirmTimeout);
              jamConfirmTimeout = null;
            }
            if(jamConfirmButton){
              jamConfirmButton.classList.remove('is-confirm');
              if(jamConfirmMarkup){
                jamConfirmButton.innerHTML = jamConfirmMarkup;
              } else {
                jamConfirmButton.innerHTML = chipMarkup(jamConfirmLabel || jamLabelText);
              }
              jamConfirmButton.removeAttribute('aria-label');
              jamConfirmButton.removeAttribute('aria-live');
              jamConfirmButton = null;
            }
            jamConfirmMarkup = '';
          };
          jamButton.addEventListener('click', (event) => {
            event.preventDefault();
            if(jamButton.disabled || pending) return;
            if(jamConfirmButton !== jamButton){
              resetJamConfirm();
            }
            if(!jamConfirmButton){
              jamConfirmButton = jamButton;
              jamConfirmLabel = jamLabelText;
              jamConfirmMarkup = jamButton.innerHTML;
              jamButton.classList.add('is-confirm');
              jamButton.innerHTML = '<span class="size-chip__value">Confirm</span><span class="size-chip__unit">All-in</span>';
              jamButton.setAttribute('aria-label', 'Tap again to confirm all-in');
              jamButton.setAttribute('aria-live', 'polite');
              jamConfirmTimeout = window.setTimeout(() => {
                resetJamConfirm();
              }, 2200);
              triggerHaptic('selection');
              return;
            }
            resetJamConfirm();
            jamButton.setAttribute('aria-label', 'All-in');
            selectedMainAction = null;
            refreshMainArming();
            triggerHaptic('impact');
            choose(jamOpt.index);
          });
          jamRow.appendChild(jamButton);
          betGroup.appendChild(jamRow);
        }

        const foldButton = appendMainButton('fold', foldOpt, 'action-negative');
        if(foldButton && foldOpt){
          foldButton.addEventListener('click', (event) => {
            event.preventDefault();
            selectedMainAction = null;
            refreshMainArming();
            choose(foldOpt.index);
          });
        }

        refreshMainArming();

        actionArea.appendChild(mainRow);
        announceAction('');
        window.requestAnimationFrame(() => {
          actionArea.style.minHeight = '';
        });
      };


      const announceAction = (message) => {
        if(actionAnnouncer){
          setTextWithCards(actionAnnouncer, message ? `Action selected: ${message}` : '');
        }
      };

      const flashEvPulse = (value, deltaSign) => {
        if(!actionArea) return;
        let pulse = actionArea.querySelector('.ev-pulse');
        if(!pulse){
          pulse = document.createElement('div');
          pulse.className = 'ev-pulse';
          actionArea.appendChild(pulse);
        }
        pulse.dataset.state = deltaSign > 0 ? 'negative' : 'positive';
        pulse.textContent = deltaSign > 0 ? `-${formatBb(value)}` : `+${formatBb(value)}`;
        pulse.classList.add('is-active');
        window.setTimeout(() => {
          pulse?.classList.remove('is-active');
        }, 1800);
      };

      const hideFeedbackDrawer = () => {
        if(!feedbackDrawer) return;
        feedbackDrawer.classList.add('hidden');
        feedbackDrawer.setAttribute('aria-hidden', 'true');
      };

      const showFeedbackDrawer = () => {
        if(!feedbackDrawer || !feedbackDrawerBody || !lastFeedback) return;
        const rows = [];
        const makeRow = (variant, label, opt) => {
          if(!opt) return;
          const evDisplay = typeof opt.ev === 'number' ? formatBb(opt.ev) : '';
          const choiceLabel = opt.key || opt.label || '';
          const whyText = opt.why ? `<div class="drawer-sub">${withCardMarkup(opt.why)}</div>` : '';
          rows.push(`
            <div class="drawer-row drawer-row--${variant}">
              <div class="drawer-col">
                <div class="drawer-chip drawer-chip--${variant}">${escapeHtml(label)}</div>
                <div class="drawer-value">${withCardMarkup(choiceLabel)}</div>
              </div>
              <div class="drawer-ev">${withCardMarkup(evDisplay)}</div>
            </div>
            ${whyText}
          `);
        };
        makeRow('best', 'GTO recommendation', lastFeedback.best);
        makeRow('chosen', 'Your action', lastFeedback.chosen);
        if(Array.isArray(lastFeedback.options)){
          lastFeedback.options.forEach((opt) => makeRow('alt', 'Alternative line', opt));
        }
        feedbackDrawerBody.innerHTML = rows.join('');
        feedbackDrawer.classList.remove('hidden');
        feedbackDrawer.setAttribute('aria-hidden', 'false');
      };

      const classifyFeedback = ({ feedback, node, evLossRaw }) => {
        const EPS = 0.005;
        const NOISE_FLOOR = 0.015;
        const GREEN_POT_MULTIPLIER = 0.004;
        const YELLOW_POT_MULTIPLIER = 0.05;
        const LOW_FREQ_THRESHOLD = 3.5;
        const YELLOW_FALLBACK = 0.35;
        const MIN_YELLOW_BAND = 0.08;

        if(typeof evLossRaw !== 'number' || Number.isNaN(evLossRaw)){
          return {
            state: 'neutral',
            tone: 'neutral',
            symbol: '',
            shouldTintValue: false,
            evLossPct: null,
            gtoFreqPct: null,
            evLossBb: 0,
          };
        }

        const rawLoss = evLossRaw;
        let loss = rawLoss;
        if(loss < 0 && Math.abs(loss) <= EPS){
          loss = 0;
        }
        const absLoss = Math.abs(loss);

        const rawPot = node?.pot_bb;
        const pot = typeof rawPot === 'number' && Number.isFinite(rawPot) && rawPot > 0 ? rawPot : null;
        let greenCutoff = NOISE_FLOOR;
        let yellowUpper = YELLOW_FALLBACK;
        if(pot){
          greenCutoff = Math.max(NOISE_FLOOR, GREEN_POT_MULTIPLIER * pot);
          yellowUpper = Math.max(YELLOW_POT_MULTIPLIER * pot, YELLOW_FALLBACK);
        }
        if(yellowUpper <= greenCutoff){
          yellowUpper = greenCutoff + MIN_YELLOW_BAND;
        }

        const evLossPct = pot ? (absLoss / pot) * 100 : null;
        const freqRaw = typeof feedback?.chosen?.gto_freq === 'number' ? feedback.chosen.gto_freq : null;
        const freq = freqRaw != null && Number.isFinite(freqRaw) ? Math.max(0, freqRaw) : null;
        const gtoFreqPct = freq != null ? freq * 100 : null;

        let state;
        let tone;
        if(loss <= 0){
          state = loss < 0 ? 'gain' : 'success';
          tone = 'success';
        } else {
          if(loss <= greenCutoff + EPS){
            state = 'success';
            tone = 'success';
          } else if(loss <= yellowUpper + EPS){
            state = 'warning';
            tone = 'warning';
          } else {
            state = 'danger';
            tone = 'danger';
          }
        }

        if(freq === 0 && loss > yellowUpper + EPS){
          state = 'danger';
          tone = 'danger';
        } else if(gtoFreqPct != null && gtoFreqPct > 0 && gtoFreqPct < LOW_FREQ_THRESHOLD){
          if(state === 'success' || state === 'gain'){
            state = 'warning';
            tone = 'warning';
          }
        }

        const shouldTintValue = rawLoss < 0 ? true : rawLoss > 0 && (tone === 'warning' || tone === 'danger');
        let symbol;
        if(tone === 'warning'){
          symbol = '!';
        } else if(tone === 'danger'){
          symbol = '';
        } else {
          symbol = '';
        }

        return {
          state,
          tone,
          symbol,
          shouldTintValue,
          evLossPct,
          gtoFreqPct,
          evLossBb: absLoss,
          thresholds: { greenCutoff, yellowUpper },
        };
      };

      const applyFeedback = (feedback) => {
        lastFeedback = feedback;
        if(!feedbackBanner || !feedbackRecommendation || !feedbackChoice){
          return;
        }
        if(typeof feedback?.ev_loss === 'number'){
          totalEvLost += Math.max(0, feedback.ev_loss);
        }
        if(feedback?.correct){
          correctDecisions += 1;
        }
        const bestLabel = feedback?.best?.key || 'Best';
        const evLossRaw = typeof feedback?.ev_loss === 'number' ? feedback.ev_loss : null;
        const lossMagnitude = evLossRaw == null ? null : Math.abs(evLossRaw);
        if(lossMagnitude !== null && lossMagnitude > 0){
          flashEvPulse(lossMagnitude, feedback?.ev_loss || 0);
        }
        const resolutionNote = feedback?.chosen?.resolution_note || '';
        const summarizeResolution = (text) => {
          if(!text) return '';
          const normalized = text.replace(/\s+/g, ' ').trim();
          if(!normalized) return '';
          return normalized.length <= 110 ? normalized : `${normalized.slice(0, 107).trim()}`;
        };
        const secondaryLine = summarizeResolution(resolutionNote);
        const classification = classifyFeedback({ feedback, node: activeNode, evLossRaw });
        if(classification?.state && classification.state !== 'neutral'){
          feedbackBanner.dataset.state = classification.state;
        } else {
          delete feedbackBanner.dataset.state;
        }
        if(feedbackRecommendation){
          feedbackRecommendation.innerHTML = '';
          const headline = document.createElement('div');
          headline.className = 'ev-callout__headline';
          const labelSpan = document.createElement('span');
          labelSpan.className = 'ev-callout__label';
          if(evLossRaw == null){
            labelSpan.textContent = 'Best line';
          } else if(evLossRaw > 0){
            labelSpan.textContent = 'EV loss';
          } else if(evLossRaw < 0){
            labelSpan.textContent = 'EV gain';
          } else {
            labelSpan.textContent = 'EV delta';
          }
          headline.appendChild(labelSpan);
          if(lossMagnitude !== null){
            const valueSpan = document.createElement('span');
            valueSpan.className = 'ev-callout__value';
            if(classification?.shouldTintValue){
              valueSpan.classList.add('ev-callout__value--tinted');
            }
            valueSpan.textContent = formatBb(lossMagnitude);
            headline.appendChild(valueSpan);
          }
          const chip = document.createElement('span');
          chip.className = 'ev-callout__chip';
          if(classification?.tone && classification.tone !== 'neutral'){
            chip.dataset.tone = classification.tone;
          } else {
            delete chip.dataset.tone;
          }
          const chipLabel = withCardMarkup(`Best ${bestLabel}`);
          const chipSymbol = classification?.symbol || '';
          const symbolMarkup = chipSymbol ? `<span class="ev-chip__symbol" aria-hidden="true">${chipSymbol}</span>` : '';
          chip.innerHTML = `${symbolMarkup}<span class="ev-chip__text">${chipLabel}</span>`;
          headline.appendChild(chip);
          feedbackRecommendation.appendChild(headline);
        }
        setTextWithCards(feedbackChoice, '');
        feedbackChoice.classList.add('hidden');
        if(feedbackResolution){
          const detailText = secondaryLine;
          if(detailText){
            feedbackResolution.innerHTML = `<span class="ev-callout__secondary">${withCardMarkup(detailText)}</span>`;
            feedbackResolution.classList.remove('hidden');
          } else {
            setTextWithCards(feedbackResolution, '');
            feedbackResolution.classList.add('hidden');
          }
        }
        feedbackBanner.classList.remove('hidden');
        updateHeaderStatus(activeNode);
      };

      const resetFeedback = () => {
        if(feedbackBanner){
          feedbackBanner.classList.add('hidden');
          delete feedbackBanner.dataset.state;
          if(feedbackRecommendation) setTextWithCards(feedbackRecommendation, '');
          if(feedbackChoice){
            setTextWithCards(feedbackChoice, '');
            feedbackChoice.classList.add('hidden');
          }
          if(feedbackResolution){
            setTextWithCards(feedbackResolution, '');
            feedbackResolution.classList.add('hidden');
          }
        }
        lastFeedback = null;
        hideFeedbackDrawer();
      };

      const applyDensity = () => {
        if(!screen) return;
        const shouldCompact = window.innerHeight < 760;
        screen.classList.toggle('density-compact', shouldCompact);
      };

      updateHeaderStatus(null, { state: 'Ready' });
      if(statusLineEl){
        statusLineEl.dataset.active = '';
        renderStatusLine([{ label: 'Status', value: 'Ready for a new hand' }]);
      }
      if(actionArea){
        actionArea.classList.add('is-hidden');
        actionArea.innerHTML = '';
      }
      applyDensity();
      window.addEventListener('resize', () => window.requestAnimationFrame(applyDensity));

      function show(id){
        clearNextHandQueue();
        ['#panel-start', '#panel-play', '#panel-summary'].forEach((sel)=>{
          const el = $(sel);
          if(el){ el.classList.add('hidden'); }
        });
        const target = $(id);
        if(target){ target.classList.remove('hidden'); }
        if(id === '#panel-start'){
          updateHeaderStatus(null, { state: 'Ready' });
          activeNode = null;
          if(statusLineEl){
            statusLineEl.dataset.active = '';
            renderStatusLine([{ label: 'Status', value: 'Ready for a new hand' }]);
          }
          if(actionArea){
            actionArea.classList.add('is-hidden');
            actionArea.innerHTML = '';
            delete actionArea.dataset.pending;
          }
        }
        if(id === '#panel-summary'){
          updateHeaderStatus(null, { state: 'Summary' });
          if(statusLineEl){
            statusLineEl.dataset.active = '';
            renderStatusLine([{ label: 'Status', value: 'Session summary ready' }]);
          }
        }
      }

      function beginRequest(){
        inflight += 1;
        if(progressBar){
          clearTimeout(hideProgressTimer);
          progressBar.classList.add('active');
        }
      }

      function endRequest(){
        inflight = Math.max(0, inflight - 1);
        if(progressBar && inflight === 0){
          hideProgressTimer = window.setTimeout(()=>{
            progressBar.classList.remove('active');
          }, 120);
        }
      }

      async function api(path, opts){
        beginRequest();
        try{
          let response = await fetch(path, opts);
          if(response.status === 404 && path.startsWith('/api/v1/')){
            const legacyPath = path.replace('/api/v1/', '/api/');
            response = await fetch(legacyPath, opts);
          }
          if(!response.ok){
            throw new Error(await response.text());
          }
          const contentType = response.headers.get('content-type') || '';
          return contentType.includes('json') ? response.json() : response.text();
        } finally {
          endRequest();
        }
      }

      const placeholderCard = (state = 'loading', wide = false) =>
        `<span class="card poker-card placeholder placeholder-${state}${wide ? ' placeholder-wide' : ''}" aria-hidden="true" role="presentation">` +
        `<span class="placeholder-icon">?</span>` +
        `</span>`;
      const renderHeroPlaceholder = (state = 'loading') => `${placeholderCard(state)} ${placeholderCard(state)}`;
      const renderBoardPlaceholder = (state = 'loading') =>
        Array.from({ length: 5 }, (_, index) => placeholderCard(state, index === 0)).join(' ');
      const renderBoardWithPlaceholders = (cards, state = 'pending') => {
        const list = Array.isArray(cards) ? cards : [];
        const actualMarkup = list.length ? renderCards(list) : '';
        const remaining = Math.max(0, 5 - list.length);
        if(!remaining){
          return actualMarkup || renderBoardPlaceholder(state);
        }
        const placeholders = Array.from({ length: remaining }, (_, idx) => placeholderCard(state, list.length === 0 && idx === 0)).join(' ');
        if(!actualMarkup){
          return placeholders || renderBoardPlaceholder(state);
        }
        return `${actualMarkup} ${placeholders}`.trim();
      };

      const showPlaceholderCards = () => {
        const heroEl = $('#hand');
        const boardEl = $('#board');
        if(heroEl) heroEl.innerHTML = renderHeroPlaceholder('loading');
        if(boardEl) boardEl.innerHTML = renderBoardPlaceholder('loading');
      };

      const setSummaryAvailability = (enabled) => {
        if(summaryBtn){
          summaryBtn.disabled = !enabled;
          summaryBtn.classList.toggle('hidden', !enabled);
        }
        if(endBtn){
          const hideEnd = Boolean(enabled);
          endBtn.classList.toggle('hidden', hideEnd);
          if(secondaryControls){
            secondaryControls.classList.toggle('hidden', hideEnd);
          }
        }
      };

      const setStartButtonState = (busy) => {
        if(!startBtn) return;
        const label = startBtn.dataset.label || startBtn.textContent || 'Start';
        startBtn.dataset.label = label;
        if(busy){
          startBtn.disabled = true;
          startBtn.classList.add('cursor-wait','opacity-80');
          startBtn.textContent = 'Starting';
        } else {
          startBtn.disabled = false;
          startBtn.classList.remove('cursor-wait','opacity-80');
          startBtn.textContent = startBtn.dataset.label;
        }
      };

      const findFieldGroup = (id) => document.querySelector(`[data-field-group="${id}"]`);

      const setFieldError = (id, message) => {
        const input = document.getElementById(id);
        const group = findFieldGroup(id);
        const errorEl = document.getElementById(`${id}-error`);
        const hasMessage = Boolean(message);
        if(group){
          group.classList.toggle('has-error', hasMessage);
        }
        if(input){
          input.classList.toggle('error', hasMessage);
          if(hasMessage){
            input.setAttribute('aria-invalid', 'true');
          } else {
            input.removeAttribute('aria-invalid');
          }
        }
        if(errorEl){
          errorEl.textContent = message || '';
          errorEl.hidden = !hasMessage;
        }
      };

      const normalizeNumberField = (id, { fallback, min } = {}) => {
        const input = document.getElementById(id);
        if(!input){
          return { value: fallback, hadError: false };
        }
        const trimmed = (input.value || '').trim();
        const defaultAttr = Number.parseInt(input.dataset.default || '', 10);
        const fallbackValue = Number.isNaN(defaultAttr) ? fallback : defaultAttr;
        let value = typeof fallbackValue === 'number' ? fallbackValue : typeof fallback === 'number' ? fallback : 0;
        let hadError = false;
        let message = '';

        if(trimmed === ''){
          if(typeof fallbackValue === 'number'){
            input.value = String(fallbackValue);
            value = fallbackValue;
          } else if(typeof fallback === 'number'){
            input.value = String(fallback);
            value = fallback;
          } else {
            input.value = '';
          }
          setFieldError(id, '');
          return { value, hadError };
        }

        const parsed = Number.parseInt(trimmed, 10);
        if(Number.isNaN(parsed)){
          hadError = true;
          message = 'Enter a number.';
        } else {
          value = parsed;
          if(typeof min === 'number' && parsed < min){
            hadError = true;
            value = min;
            message = `Minimum is ${min}.`;
          }
        }

        input.value = String(value);
        setFieldError(id, message);
        return { value, hadError };
      };

      const setupNumericField = (id, options = {}) => {
        const input = document.getElementById(id);
        if(!input) return;
        if(options?.fallback !== undefined && !input.dataset.default){
          input.dataset.default = String(options.fallback);
        }
        const originalPlaceholder = input.getAttribute('placeholder');
        if(originalPlaceholder && !input.dataset.placeholder){
          input.dataset.placeholder = originalPlaceholder;
        }
        const syncPlaceholder = () => {
          if(!input.dataset.placeholder) return;
          if(input.value.trim()){
            if(input.placeholder) input.placeholder = '';
          } else if(input.placeholder !== input.dataset.placeholder){
            input.placeholder = input.dataset.placeholder;
          }
        };
        syncPlaceholder();
        input.addEventListener('input', () => {
          syncPlaceholder();
          if(!input.classList.contains('error')) return;
          const trimmed = input.value.trim();
          if(trimmed === ''){
            setFieldError(id, '');
            return;
          }
          const parsed = Number.parseInt(trimmed, 10);
          if(!Number.isNaN(parsed) && (options.min === undefined || parsed >= options.min)){
            setFieldError(id, '');
          }
        });
        input.addEventListener('blur', () => {
          normalizeNumberField(id, options);
          syncPlaceholder();
        });
      };

      const numericFieldConfigs = {
        'inp-hands': { fallback: 3, min: 1 },
        'inp-mc': { fallback: 120, min: 40 }
      };

      Object.entries(numericFieldConfigs).forEach(([id, config]) => {
        setupNumericField(id, config);
      });

      const start = async () => {
        if(startBusy) return;
        startBusy = true;
        setStartButtonState(true);
        try{
          const handsResult = normalizeNumberField('inp-hands', numericFieldConfigs['inp-hands']);
          const depthResult = normalizeNumberField('inp-mc', numericFieldConfigs['inp-mc']);
          if(handsResult.hadError || depthResult.hadError){
            const focusTarget = handsResult.hadError ? $('#inp-hands') : $('#inp-mc');
            setStartButtonState(false);
            startBusy = false;
            focusTarget?.focus({ preventScroll: true });
            return;
          }
          const hands = handsResult.value;
          const mc = depthResult.value;
          const data = await api('/api/v1/session', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({hands, mc})});
          sid = data.session;
          answered = 0;
          correctDecisions = 0;
          totalEvLost = 0;
          sessionHands = hands;
          pending = false;
          pendingSummary = null;
          resetFeedback();
          setSummaryAvailability(false);
          if(actionArea){
            actionArea.classList.add('is-hidden');
            actionArea.innerHTML = '';
          }
          showPlaceholderCards();
          show('#panel-play');
          setStatusMessage('Preparing a fresh scenario');
          updateHeaderStatus(null, { state: 'Preparing' });
          await showNode();
        } catch (err) {
          console.error(err);
          const message = err instanceof Error ? err.message : String(err ?? 'unknown error');
          setStatusMessage(`Unable to start session  ${message}`);
          show('#panel-start');
        } finally {
          startBusy = false;
          setStartButtonState(false);
        }
      };

      const showNode = async () => {
        showPlaceholderCards();
        try {
          const payload = await api(`/api/v1/session/${sid}/node`);
          await renderNodePayload(payload, {clearFeedback: true});
        } catch (err) {
          throw err;
        }
      };

      const renderNodePayload = async (payload, {clearFeedback = false} = {}) => {
        clearNextHandQueue();
        if(payload.done){
          pendingSummary = payload.summary || null;
          setSummaryAvailability(true);
          activeNode = null;
          updateHeaderStatus(null, { state: 'Summary' });
          if(statusLineEl){
            statusLineEl.dataset.active = '';
            renderStatusLine([{ label: 'Status', value: 'Session complete  view summary' }]);
          } else {
            setStatusMessage('Session complete  view summary for breakdown.');
          }
          if(actionArea){
            actionArea.classList.add('is-hidden');
            actionArea.innerHTML = '';
          }
          return;
        }
        pendingSummary = null;
        setSummaryAvailability(false);
        const node = payload.node;
        activeNode = node;
        const descriptor = parseDescriptor(node);
        updateHeaderStatus(node);
        const streetName = streetLabel(node.street);
        const statusBits = [];
        if(streetName && streetName.toLowerCase() != 'ready'){
          statusBits.push(streetName);
        }
        if(!statusBits.length){
          statusBits.push('Decision live');
        }
        if(statusLineEl){
          statusLineEl.dataset.active = 'node';
        }
        setStatusMessage(statusBits.join('  '));
        if(statusLineEl){
          renderStatusLine(formatStatusLine(node, descriptor));
        }
        const heroEl = $('#hand');
        const heroCardsHtml = renderCards(node.hero_cards);
        if(heroEl){
          heroEl.innerHTML = heroCardsHtml || renderHeroPlaceholder('pending');
        }
        const boardEl = $('#board');
        if(boardEl){
          boardEl.innerHTML = renderBoardWithPlaceholders(node.board_cards || []);
        }
        const optionList = Array.isArray(payload.options) ? payload.options : [];
        renderActions(optionList, node);
        if(optionList.length === 0 && actionArea){
          actionArea.classList.add('is-disabled');
        }
        if(clearFeedback){
          resetFeedback();
        }
      };

      const choose = async (index) => {
        if(pending) return;
        pending = true;
        selectedMainAction = null;
        const interactives = Array.from(actionArea?.querySelectorAll('[data-option-index]') || []);
        if(actionArea){
          actionArea.querySelectorAll('.action-button.is-armed').forEach((btn) => btn.classList.remove('is-armed'));
          actionArea.dataset.pending = 'true';
        }
        const chosenElement = interactives.find((el) => Number(el.dataset.optionIndex) === index);
        interactives.forEach((el) => {
          const isChosen = Number(el.dataset.optionIndex) === index;
          el.classList.toggle('is-selected', isChosen);
          if('disabled' in el){
            el.disabled = true;
          }
        });
        if(actionArea){
          actionArea.classList.add('is-disabled');
        }
        if(chosenElement?.dataset.optionLabel){
          announceAction(chosenElement.dataset.optionLabel);
        } else {
          announceAction('');
        }
        triggerHaptic('selection');
        try{
          const data = await api(`/api/v1/session/${sid}/choose`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({choice:index})});
          const feedback = data.feedback;
          answered += 1;
          if(feedback){
            applyFeedback(feedback);
          }
          if(data.next){
            if(data.next.done){
              await renderNodePayload(data.next, {clearFeedback: false});
            } else if(feedback?.ended){
              queueNextHand(data.next);
            } else {
              await renderNodePayload(data.next, {clearFeedback: false});
            }
          } else {
            await showNode();
          }
        } catch (err) {
          console.error(err);
          setStatusMessage('Action failed  please retry.');
          interactives.forEach((el) => {
            el.classList.remove('is-selected');
            if('disabled' in el){
              el.disabled = false;
            }
          });
          if(actionArea){
            actionArea.classList.remove('is-disabled');
          }
          announceAction('');
        } finally {
          pending = false;
          if(actionArea){
            delete actionArea.dataset.pending;
          }
        }
      };

      const showSummary = async (prefetched) => {
        const s = prefetched || await api(`/api/v1/session/${sid}/summary`);
        const decisions = s.decisions ?? answered;
        const totalDecisions = typeof decisions === 'number' ? decisions : 0;
        const accuracyPct = totalDecisions ? Math.round((s.hits / totalDecisions) * 100) : 0;
        const hitsDisplay = `${s.hits || 0}/${totalDecisions || 0}`;
        const summaryEvLost = typeof s.ev_lost === 'number' ? s.ev_lost : 0;
        const deltaEv = -summaryEvLost;
        const avgDelta = s.hands ? deltaEv / s.hands : deltaEv;

        if(summaryHeroScore){
          const scoreValue = Number.isFinite(s.score) ? Math.round(s.score) : 0;
          summaryHeroScore.textContent = `${scoreValue}`;
        }
        if(summaryHeroEv){
          summaryHeroEv.textContent = formatSignedBb(deltaEv);
        }
        if(summaryHeroAccuracy){
          summaryHeroAccuracy.textContent = totalDecisions ? `${accuracyPct}%` : '';
        }

        if(summaryEvDeltaEl){
          summaryEvDeltaEl.textContent = formatSignedBb(deltaEv);
          summaryEvDeltaEl.classList.toggle('is-negative', deltaEv < 0);
        }
        if(summaryEvMetaEl){
          const parts = [];
          if(s.hands){
            parts.push(`${s.hands} ${s.hands === 1 ? 'hand' : 'hands'}`);
          }
          if(summaryEvLost !== 0 || s.hands){
            parts.push(`Avg / hand ${formatSignedBb(avgDelta)}`);
          }
          if(totalDecisions){
            parts.push(`${hitsDisplay} best choices`);
          }
          summaryEvMetaEl.textContent = parts.join('  ');
        }

        if(summaryHistoryList){
          const historyItems = [
            { label: 'Hands played', value: String(s.hands || 0) },
            { label: 'Decisions reviewed', value: String(totalDecisions || 0) },
            { label: 'Correct decisions', value: hitsDisplay },
          ];
          summaryHistoryList.innerHTML = historyItems.map(({ label, value }) => `
            <div class="summary-list__item">
              <span class="summary-list__label">${escapeHtml(label)}</span>
              <span>${escapeHtml(value)}</span>
            </div>
          `).join('');
        }

        pendingSummary = s;
        answered = s.decisions ?? answered;
        setSummaryAvailability(false);
        show('#panel-summary');
        updateHeaderStatus(null, { state: 'Summary' });
      };

      const endSession = async () => {
        if(!sid || pending) return;
        try{
          const summary = await api(`/api/v1/session/${sid}/summary`);
          answered = summary.hands || answered;
          await showSummary(summary);
        } catch(err){
          console.error(err);
        }
      };

      if(startBtn){
        startBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          start();
        });
      }

      if(newBtn){
        newBtn.addEventListener('click', () => {
          sid = null;
          answered = 0;
          pending = false;
          pendingSummary = null;
          resetFeedback();
          setStartButtonState(false);
          setSummaryAvailability(false);
          show('#panel-start');
          setStatusMessage('Ready for a new hand');
        });
      }

      if(endBtn){
        endBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          endSession();
        });
      }

      if(summaryBtn){
        summaryBtn.addEventListener('click', async (event)=>{
          event.preventDefault();
          if(pendingSummary){
            await showSummary(pendingSummary);
          } else {
            await showSummary();
          }
        });
      }

      if(summaryBackBtn){
        summaryBackBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          show('#panel-play');
          if(pendingSummary){
            setSummaryAvailability(true);
          }
        });
      }

      if(feedbackDetailBtn){
        feedbackDetailBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          if(lastFeedback){
            showFeedbackDrawer();
          }
        });
      }

      if(feedbackDrawerClose){
        feedbackDrawerClose.addEventListener('click', (event)=>{
          event.preventDefault();
          hideFeedbackDrawer();
        });
      }

      if(feedbackDrawer){
        feedbackDrawer.addEventListener('click', (event)=>{
          if(event.target === feedbackDrawer){
            hideFeedbackDrawer();
          }
        });
      }

      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          hideFeedbackDrawer();
          return;
        }
        const panel = $('#panel-play');
        if(!panel || panel.classList.contains('hidden')) return;
        if(e.key >= '1' && e.key <= '9'){
          const idx = parseInt(e.key, 10) - 1;
          const btns = Array.from(document.querySelectorAll('#action-area [data-option-index]'));
          if(btns[idx] instanceof HTMLElement){
            btns[idx].click();
          }
        }
      });

      setStatusMessage('Ready for a new hand');
      renderActions([], null);
    </script>
  </body>
  </html>
