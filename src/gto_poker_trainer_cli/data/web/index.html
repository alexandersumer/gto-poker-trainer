<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GTO Poker Trainer</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <style>
      :root {
        color-scheme: light;
        --bg-primary: #f5f7fb;
        --bg-secondary: rgba(255, 255, 255, 0.92);
        --bg-panel: rgba(255, 255, 255, 0.88);
        --surface-subtle: #eef1f8;
        --border-panel: #d7ddea;
        --card-highlight: #f1f3fb;
        --accent-primary: #6c83f5;
        --accent-secondary: #7ec7c2;
        --accent-warm: #f2b4c0;
        --text-primary: #1f2740;
        --text-secondary: #47516d;
        --text-muted: #838eaa;
        --focus-ring: rgba(108, 131, 245, 0.35);
      }
      body {
        min-height: 100vh;
        margin: 0;
        font-family: "Inter", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f7fb;
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
      }
      .text-primary { color: var(--text-primary); }
      .text-secondary { color: var(--text-secondary); }
      .text-muted { color: var(--text-muted); }
      .eyebrow { letter-spacing: 0.22em; color: var(--text-muted); }
      main {
        flex: 1;
        width: min(860px, calc(100% - 2.5rem));
        padding-bottom: 4rem;
      }
      #progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: #6c83f5;
        transform: scaleX(0);
        transform-origin: left;
        opacity: 0;
        transition: opacity 0.35s ease, transform 0.35s ease;
        z-index: 50;
        pointer-events: none;
      }
      #progress-bar.active {
        opacity: 1;
        animation: progress-pulse 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }
      @keyframes progress-pulse {
        0% { transform: scaleX(0.15); }
        50% { transform: scaleX(0.7); }
        100% { transform: scaleX(1); }
      }
      .card {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
        border: 1px solid rgba(190, 202, 224, 0.5);
        padding: 0.35rem 0.75rem;
        font-weight: 700;
        letter-spacing: 0.4px;
        margin: 0 0.25rem 0.25rem 0;
        background: var(--card-highlight);
        box-shadow: 0 8px 18px rgba(31, 39, 64, 0.08);
      }
      .card.s { color: #1f2740; }
      .card.h { color: #c45b6b; }
      .card.d { color: #1d68a6; }
      .card.c { color: #2c7a66; }
      .glass {
        backdrop-filter: blur(18px);
        background: rgba(255, 255, 255, 0.82);
        box-shadow: 0 18px 34px rgba(31, 39, 64, 0.08);
      }
      .panel-box {
        background: var(--bg-panel);
        border: 1px solid var(--border-panel);
        box-shadow: 0 14px 28px rgba(31, 39, 64, 0.08);
        color: var(--text-primary);
        backdrop-filter: blur(18px);
        border-radius: 1.25rem;
      }
      input, select, textarea {
        color: var(--text-primary);
        background: var(--surface-subtle);
        border-radius: 0.75rem;
        border: 1px solid rgba(181, 192, 212, 0.65);
        padding: 0.55rem 0.9rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      input:focus-visible {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }
      button {
        color: inherit;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      button:not([disabled]):active { transform: translateY(1px); }
      button[disabled] { cursor: wait !important; opacity: 0.7 !important; }
      #options {
        box-shadow: none;
      }
      #options button {
        box-shadow: 0 10px 20px rgba(31, 39, 64, 0.12);
      }
      #options button:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--focus-ring); }
      .option-card {
        animation: option-in 0.26s ease forwards;
        transform-origin: top center;
        opacity: 0;
      }
      @keyframes option-in {
        0% { opacity: 0; transform: translateY(12px) scale(0.97); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
      }
      @media (prefers-reduced-motion: reduce) {
        .option-card { animation: none; }
        #progress-bar { transition: none; animation: none; }
      }
      #feedback {
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      #feedback.hidden { opacity: 0; transform: translateY(6px); }
      #feedback[data-state="correct"] {
        background: #e3f3ed;
        border-left: 4px solid rgba(111, 191, 163, 0.65);
      }
      #feedback[data-state="incorrect"] {
        background: #f6e9e4;
        border-left: 4px solid rgba(210, 150, 120, 0.6);
      }
      @media (max-width: 640px) {
        header { position: sticky; top: 0; }
        #options { position: relative; }
      }
    </style>
  </head>
  <body>
    <div id="progress-bar" aria-hidden="true"></div>
    <header class="sticky top-0 z-10 glass shadow-sm">
      <div class="max-w-2xl mx-auto flex items-center justify-between p-3">
        <h1 class="text-xl font-bold text-primary">GTO Poker Trainer</h1>
        <div id="stats" class="text-sm text-muted"></div>
      </div>
    </header>

    <main class="max-w-2xl min-h-[720px] mx-auto p-4">
      <section id="panel-start" class="space-y-4">
        <div class="rounded-lg panel-box p-6 shadow-lg">
          <h2 class="font-semibold mb-4 text-[clamp(1.25rem,2vw,1.45rem)] text-primary">Start a Session</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-secondary">
            <label class="block text-sm">Hands
              <input id="inp-hands" type="number" min="1" value="3" class="mt-1 w-full" />
            </label>
            <label class="block text-sm">Simulation depth
              <input id="inp-mc" type="number" min="40" step="10" value="120" class="mt-1 w-full" />
              <span class="mt-2 block text-xs text-muted leading-relaxed">Higher trials = more precise equities, but each hand takes longer to compute.</span>
            </label>
          </div>
          <button id="btn-start" class="mt-6 w-full rounded-xl bg-[#dee4ff] px-4 py-2.5 font-semibold text-[#1f2740] shadow-lg shadow-[#1f2740]/10 transition-transform duration-200 hover:-translate-y-[1px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#6c83f5] focus-visible:ring-offset-[#f5f7fb]">Start</button>
        </div>
      </section>

      <section id="panel-play" class="hidden space-y-4">
        <div class="rounded-lg panel-box p-6 text-secondary">
          <div id="headline" class="text-sm uppercase eyebrow"></div>
          <div class="mt-4 space-y-4" id="card-summary">
            <div>
              <div class="text-xs font-semibold uppercase eyebrow">Your hand</div>
              <div id="hand" class="mt-1 flex flex-wrap items-center gap-1 text-lg font-semibold text-primary"></div>
            </div>
            <div>
              <div class="text-xs font-semibold uppercase eyebrow">Board</div>
              <div id="board" class="mt-1 flex flex-wrap items-center gap-1 text-secondary"></div>
            </div>
          </div>
          <div class="text-sm mt-5 text-secondary" id="meta"></div>
        </div>

        <div id="options" class="grid grid-cols-1 gap-3 max-w-xl mx-auto"></div>

        <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
          <button id="btn-end" class="rounded-lg border border-[#e3c7d0] bg-[#f7ecf0] px-4 py-2 text-sm font-semibold text-[#5b2940] transition-colors duration-200 hover:bg-[#f3e1e7] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#f2b4c0] focus-visible:ring-offset-2 focus-visible:ring-offset-[#f5f7fb]">
            End Session
          </button>
        </div>

        <div id="feedback" class="hidden rounded-lg panel-box p-5"></div>
      </section>

      <section id="panel-summary" class="hidden space-y-3">
        <div class="rounded-lg panel-box p-4" id="summary"></div>
        <button id="btn-new" class="w-full rounded-md bg-[#e9f2fa] px-4 py-2 font-semibold text-[#1d3a56] transition-colors duration-200 hover:bg-[#e0edf7] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#7ec7c2] focus-visible:ring-offset-2 focus-visible:ring-offset-[#f5f7fb]">New Session</button>
      </section>
    </main>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const fmt = (n) => Number(n).toFixed(2);
      const progressBar = document.getElementById('progress-bar');
      let inflight = 0;
      let hideProgressTimer = null;
      let sid = null;
      let pending = false;
      let answered = 0;
      let startBusy = false;

      function show(id){
        ['#panel-start', '#panel-play', '#panel-summary'].forEach((sel)=>{
          const el = $(sel);
          if(el){ el.classList.add('hidden'); }
        });
        const target = $(id);
        if(target){ target.classList.remove('hidden'); }
      }

      function beginRequest(){
        inflight += 1;
        if(progressBar){
          clearTimeout(hideProgressTimer);
          progressBar.classList.add('active');
        }
      }

      function endRequest(){
        inflight = Math.max(0, inflight - 1);
        if(progressBar && inflight === 0){
          hideProgressTimer = window.setTimeout(()=>{
            progressBar.classList.remove('active');
          }, 120);
        }
      }

      async function api(path, opts){
        beginRequest();
        try{
          const r = await fetch(path, opts);
          if(!r.ok) throw new Error(await r.text());
          return r.headers.get('content-type')?.includes('json') ? r.json() : r.text();
        } finally {
          endRequest();
        }
      }

      function suit(sym){ return {S:'s',H:'h',D:'d',C:'c'}[sym]||'s'; }
      function suitIcon(sym){ return {S:'\u2660', H:'\u2665', D:'\u2666', C:'\u2663'}[sym]||'\u2660'; }
      function renderCards(cards){
        if(!cards || !cards.length) return '';
        return cards.map((c)=>{
          const rank = c[0];
          const suitCode = c[1];
          const css = suit(suitCode);
          return `<span class="card ${css}">${rank}${suitIcon(suitCode)}</span>`;
        }).join(' ');
      }

      function resetFeedback(){
        const fb = $('#feedback');
        if(!fb) return;
        fb.classList.add('hidden');
        fb.removeAttribute('data-state');
        fb.innerHTML = '';
      }

      function setStartButtonState(busy){
        const btn = $('#btn-start');
        if(!btn) return;
        const label = btn.dataset.label || btn.textContent || 'Start';
        btn.dataset.label = label;
        if(busy){
          btn.disabled = true;
          btn.classList.add('cursor-wait','opacity-80');
          btn.textContent = 'Starting…';
        } else {
          btn.disabled = false;
          btn.classList.remove('cursor-wait','opacity-80');
          btn.textContent = btn.dataset.label;
        }
      }

      function readInt(selector, {fallback, min}){
        const el = $(selector);
        if(!el) return fallback;
        const raw = parseInt(el.value || '', 10);
        if(Number.isNaN(raw)) return fallback;
        return Math.max(min, raw);
      }

      async function start(){
        if(startBusy) return;
        startBusy = true;
        setStartButtonState(true);
        try{
          const hands = readInt('#inp-hands', {fallback: 1, min: 1});
          const handsInput = $('#inp-hands');
          if(handsInput) handsInput.value = String(hands);
          const mc = readInt('#inp-mc', {fallback: 120, min: 40});
          const mcInput = $('#inp-mc');
          if(mcInput) mcInput.value = String(mc);
          const data = await api('/api/session', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({hands, mc})});
          sid = data.session;
          answered = 0;
          pending = false;
          updateStats();
          resetFeedback();
          const area = $('#options'); if(area) area.innerHTML = '';
          show('#panel-play');
          await showNode();
        } catch (err) {
          console.error(err);
          const stats = $('#stats');
          if(stats) stats.textContent = 'Unable to start session. Please try again.';
          show('#panel-start');
        } finally {
          startBusy = false;
          setStartButtonState(false);
        }
      }

      async function showNode(){
        const payload = await api(`/api/session/${sid}/node`);
        await renderNodePayload(payload, {clearFeedback: true});
      }

      async function renderNodePayload(payload, {clearFeedback = false} = {}){
        if(payload.done){
          await showSummary(payload.summary);
          return;
        }
        const n = payload.node;
        const headline = $('#headline');
        if(headline) headline.textContent = `${n.street.toUpperCase()} — ${n.description}`;
        const hero = renderCards(n.hero_cards);
        const heroEl = $('#hand'); if(heroEl) heroEl.innerHTML = hero || '<span class="text-sm text-muted">Dealing…</span>';
        const board = renderCards(n.board_cards);
        const boardEl = $('#board'); if(boardEl) boardEl.innerHTML = board || '<span class="text-sm text-muted">Board not yet revealed</span>';
        const meta = $('#meta');
        if(meta){
          const parts = [`Hand ${n.hand_no}/${n.total_hands}`];
          const spr = n.pot_bb > 0 ? (n.effective_bb / n.pot_bb) : Infinity;
          parts.push(`Pot: ${fmt(n.pot_bb)} bb`);
          parts.push(`SPR: ${spr.toFixed(1)}`);
          meta.textContent = parts.join(' • ');
        }
        const area = $('#options');
        if(area){
          const palette = {
            Fold: 'bg-[#f7ecf0] border-[#e5c8d0] hover:bg-[#f3e1e7] focus-visible:ring-[#f2b4c0]/55 text-[#5b2940]',
            Call: 'bg-[#e9f2fa] border-[#cfe0f0] hover:bg-[#e0edf7] focus-visible:ring-[#7ec7c2]/55 text-[#1d3a56]',
            Check: 'bg-[#f1f3fb] border-[#cdd4e6] hover:bg-[#e7eaf5] focus-visible:ring-[#6c83f5]/50 text-[#20283f]',
            'Check back': 'bg-[#f1f3fb] border-[#cdd4e6] hover:bg-[#e7eaf5] focus-visible:ring-[#6c83f5]/50 text-[#20283f]',
          };
          const fragment = document.createDocumentFragment();
          payload.options.forEach((label,i)=>{
            const text = label.replace(/\s*\([^)]*\)$/, '');
            const toneKey = label.includes('%') ? text : label;
            const b = document.createElement('button');
            b.type = 'button';
            const base = 'option-card w-full rounded-lg px-3.5 py-2.5 text-sm font-semibold tracking-tight transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-[#f5f7fb] border shadow-sm shadow-[#1f2740]/10';
            const color = palette[toneKey] || 'bg-[#eaf7f2] border-[#c6e4d7] hover:bg-[#e2f1ec] focus-visible:ring-[#89d0b4]/55 text-[#1d4337]';
            b.className = `${base} ${color}`;
            b.style.animationDelay = `${i * 40}ms`;
            b.textContent = `${i + 1}. ${text}`;
            b.onclick = () => choose(i);
            fragment.appendChild(b);
          });
          if(typeof area.replaceChildren === 'function'){
            area.replaceChildren(fragment);
          } else {
            area.innerHTML = '';
            area.appendChild(fragment);
          }
        }
        if(clearFeedback){
          resetFeedback();
        }
        if(window.innerWidth < 640){
          window.requestAnimationFrame(()=>{
            const panel = $('#panel-play');
            if(panel){ panel.scrollIntoView({behavior: 'smooth', block: 'start'}); }
          });
        }
      }

      async function choose(i){
        if(pending) return;
        pending = true;
        const buttons = Array.from(document.querySelectorAll('#options button'));
        buttons.forEach((btn)=>{
          btn.disabled = true;
          btn.classList.add('cursor-wait','opacity-60');
        });
        try{
          const data = await api(`/api/session/${sid}/choose`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({choice:i})});
          const f = data.feedback; answered += 1; updateStats();
          const fb = $('#feedback');
          if(fb){
            fb.dataset.state = f.correct ? 'correct' : 'incorrect';
            fb.classList.remove('hidden');
            const stateTone = f.correct ? 'text-[#4a8b74]' : 'text-[#b17646]';
            const contextTone = 'text-[#6d7794]';
            fb.innerHTML = `
              <div class="text-lg font-bold ${stateTone}">${f.correct?'✓ Best choice':'✗ Better was'}: ${f.best.key}</div>
              <div class="mt-2">You chose: <b>${f.chosen.key}</b> — EV lost: <b>${fmt(f.ev_loss)} bb</b></div>
              ${f.chosen.why?`<div class=\"mt-1 text-sm ${contextTone}\"><i>Why (yours):</i> ${f.chosen.why}</div>`:''}
              ${!f.correct && f.best.why?`<div class=\"text-sm ${contextTone}\"><i>Why (best):</i> ${f.best.why}</div>`:''}
            `;
          }
          if(data.next){
            await renderNodePayload(data.next, {clearFeedback: false});
          } else {
            await showNode();
          }
        } finally {
          pending = false;
        }
      }

      async function showSummary(prefetched){
        const s = prefetched || await api(`/api/session/${sid}/summary`);
        const sum = $('#summary');
        if(sum){
          sum.innerHTML = `
            <div class="text-xl font-bold mb-2">Session Summary</div>
            <div>Hands answered: <b>${s.hands}</b></div>
            <div>Best choices hit: <b>${s.hits}</b></div>
            <div>Total EV lost: <b>${fmt(s.ev_lost)} bb</b></div>
            <div>Score: <b>${s.score.toFixed(0)}</b></div>
          `;
        }
        show('#panel-summary');
      }

      async function endSession(){
        if(!sid || pending) return;
        try{
          const summary = await api(`/api/session/${sid}/summary`);
          answered = summary.hands || answered;
          await showSummary(summary);
        } catch(err){
          console.error(err);
        }
      }

      function updateStats(){
        const stats = $('#stats');
        if(stats) stats.textContent = answered ? `Answered: ${answered}` : '';
      }

      const startBtn = $('#btn-start');
      if(startBtn){
        startBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          start();
        });
      }

      const newBtn = $('#btn-new');
      if(newBtn){
        newBtn.addEventListener('click', () => {
          sid = null;
          answered = 0;
          pending = false;
          updateStats();
          resetFeedback();
          setStartButtonState(false);
          show('#panel-start');
        });
      }

      const endBtn = $('#btn-end');
      if(endBtn){
        endBtn.addEventListener('click', (event)=>{
          event.preventDefault();
          endSession();
        });
      }

      window.addEventListener('keydown', (e)=>{
        const panel = $('#panel-play');
        if(!panel || panel.classList.contains('hidden')) return;
        if(e.key >= '1' && e.key <= '9'){
          const idx = parseInt(e.key, 10) - 1;
          const btns = Array.from(document.querySelectorAll('#options button'));
          if(btns[idx]) btns[idx].click();
        }
      });
    </script>
  </body>
  </html>
